<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>è§†é¢‘ä¸“åŒº | NEXUS VIDEO</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.1/css/all.min.css">
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Orbitron:wght@400;700;900&family=Rajdhani:wght@500;700&family=Noto+Sans+SC:wght@300;400;500;700&display=swap');

        :root {
            --primary: #00f3ff;
            --secondary: #bc13fe;
            --gold: #ffd700;
            --bg: #050505;
            --glass: rgba(16, 16, 20, 0.85);
            --glass-border: rgba(255, 255, 255, 0.1);
        }

        * { margin: 0; padding: 0; box-sizing: border-box; }
        
        body {
            background-color: var(--bg);
            color: #e0e0e0;
            font-family: 'Noto Sans SC', sans-serif;
            min-height: 100vh;
        }

        body.modal-open { overflow: hidden; }

        /* èƒŒæ™¯ç‰¹æ•ˆ */
        #canvas { position: fixed; top: 0; left: 0; width: 100%; height: 100%; z-index: -1; }
        
        .cyber-grid {
            position: fixed; bottom: -20%; left: -50%; width: 200%; height: 60%;
            background: 
                linear-gradient(transparent 0%, rgba(0, 243, 255, 0.1) 1px, transparent 2px),
                linear-gradient(90deg, transparent 0%, rgba(0, 243, 255, 0.1) 1px, transparent 2px);
            background-size: 60px 60px;
            transform: perspective(500px) rotateX(60deg);
            animation: grid-move 20s linear infinite;
            z-index: -2;
            mask-image: linear-gradient(to bottom, transparent, black 40%);
        }
        @keyframes grid-move { 0% { background-position: 0 0; } 100% { background-position: 0 60px; } }

        /* é¡¶éƒ¨å¯¼èˆª */
        .top-nav {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            height: 60px;
            background: rgba(5, 5, 5, 0.9);
            backdrop-filter: blur(20px);
            border-bottom: 1px solid var(--glass-border);
            display: flex;
            align-items: center;
            justify-content: space-between;
            padding: 0 30px;
            z-index: 1000;
        }

        .nav-left {
            display: flex;
            align-items: center;
            gap: 20px;
        }

        .back-btn {
            color: var(--primary);
            text-decoration: none;
            display: flex;
            align-items: center;
            gap: 8px;
            font-size: 0.9em;
            transition: all 0.3s;
        }
        .back-btn:hover { color: #fff; }

        .nav-title {
            font-family: 'Orbitron', sans-serif;
            font-size: 1.3em;
            color: var(--gold);
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .nav-title i { color: var(--gold); }

        .vip-badge {
            background: linear-gradient(135deg, var(--gold), #ff8c00);
            color: #000;
            padding: 4px 12px;
            border-radius: 20px;
            font-size: 0.7em;
            font-weight: bold;
            font-family: 'Rajdhani', sans-serif;
        }

        .nav-right {
            display: flex;
            align-items: center;
            gap: 15px;
        }

        .user-info {
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .user-avatar {
            width: 36px;
            height: 36px;
            border-radius: 50%;
            background: linear-gradient(135deg, var(--primary), var(--secondary));
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 1rem;
            overflow: hidden;
        }
        .user-avatar img { width: 100%; height: 100%; object-fit: cover; }

        .user-name { color: #fff; font-family: 'Rajdhani'; font-weight: 600; }

        .admin-link {
            color: var(--secondary);
            text-decoration: none;
            font-size: 0.85em;
            display: flex;
            align-items: center;
            gap: 5px;
            padding: 5px 10px;
            border: 1px solid var(--secondary);
            border-radius: 15px;
            transition: all 0.3s;
        }
        .admin-link:hover {
            background: var(--secondary);
            color: #fff;
        }

        .membership-status {
            padding: 4px 10px;
            border-radius: 15px;
            font-size: 0.75em;
            font-weight: bold;
        }
        .membership-status.free {
            background: rgba(100, 100, 100, 0.3);
            border: 1px solid #666;
            color: #aaa;
        }
        .membership-status.premium {
            background: linear-gradient(135deg, rgba(255, 215, 0, 0.2), rgba(255, 140, 0, 0.2));
            border: 1px solid var(--gold);
            color: var(--gold);
        }

        /* ä¸»å†…å®¹åŒº */
        .main-content {
            margin-top: 80px;
            padding: 20px 40px;
            max-width: 1400px;
            margin-left: auto;
            margin-right: auto;
        }

        /* ä¼šå‘˜æç¤ºæ¨ªå¹… */
        .membership-banner {
            background: linear-gradient(135deg, rgba(255, 215, 0, 0.1), rgba(188, 19, 254, 0.1));
            border: 1px solid rgba(255, 215, 0, 0.3);
            border-radius: 12px;
            padding: 20px 30px;
            margin-bottom: 30px;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .banner-content h3 {
            color: var(--gold);
            font-family: 'Rajdhani', sans-serif;
            margin-bottom: 5px;
        }
        .banner-content p {
            color: #aaa;
            font-size: 0.9em;
        }

        .banner-btn {
            background: linear-gradient(135deg, var(--gold), #ff8c00);
            color: #000;
            border: none;
            padding: 12px 25px;
            border-radius: 8px;
            font-weight: bold;
            cursor: pointer;
            transition: all 0.3s;
            font-size: 0.95em;
        }
        .banner-btn:hover {
            transform: scale(1.05);
            box-shadow: 0 0 20px rgba(255, 215, 0, 0.4);
        }

        .banner-premium {
            background: linear-gradient(135deg, rgba(0, 243, 255, 0.1), rgba(188, 19, 254, 0.1));
            border-color: var(--primary);
        }
        .banner-premium h3 { color: var(--primary); }

        /* è§†é¢‘ç½‘æ ¼ */
        .section-title {
            font-family: 'Orbitron', sans-serif;
            font-size: 1.2em;
            color: var(--primary);
            margin-bottom: 20px;
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .video-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(300px, 1fr));
            gap: 25px;
        }

        .video-card {
            background: var(--glass);
            border: 1px solid var(--glass-border);
            border-radius: 12px;
            overflow: hidden;
            transition: all 0.3s;
            cursor: pointer;
        }
        .video-card:hover {
            transform: translateY(-5px);
            border-color: var(--primary);
            box-shadow: 0 10px 30px rgba(0, 243, 255, 0.2);
        }

        .video-thumbnail {
            position: relative;
            aspect-ratio: 16/9;
            background: #111;
            overflow: hidden;
        }
        .video-thumbnail img {
            width: 100%;
            height: 100%;
            object-fit: cover;
        }
        .video-thumbnail .play-icon {
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            width: 60px;
            height: 60px;
            background: rgba(0, 0, 0, 0.7);
            border: 2px solid var(--primary);
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            color: var(--primary);
            font-size: 1.5em;
            transition: all 0.3s;
        }
        .video-card:hover .play-icon {
            background: var(--primary);
            color: #000;
            transform: translate(-50%, -50%) scale(1.1);
        }

        .video-duration {
            position: absolute;
            bottom: 10px;
            right: 10px;
            background: rgba(0, 0, 0, 0.8);
            padding: 3px 8px;
            border-radius: 4px;
            font-size: 0.8em;
            color: #fff;
        }

        .video-lock {
            position: absolute;
            top: 10px;
            right: 10px;
            background: rgba(255, 215, 0, 0.9);
            color: #000;
            padding: 4px 10px;
            border-radius: 4px;
            font-size: 0.75em;
            font-weight: bold;
            display: flex;
            align-items: center;
            gap: 5px;
        }

        .video-free {
            position: absolute;
            top: 10px;
            right: 10px;
            background: rgba(76, 175, 80, 0.9);
            color: #fff;
            padding: 4px 10px;
            border-radius: 4px;
            font-size: 0.75em;
            font-weight: bold;
            display: flex;
            align-items: center;
            gap: 5px;
        }

        .video-info {
            padding: 15px;
        }
        .video-title {
            font-weight: 600;
            margin-bottom: 8px;
            color: #fff;
            font-size: 1em;
        }
        .video-meta {
            display: flex;
            justify-content: space-between;
            align-items: center;
            font-size: 0.8em;
            color: #666;
        }
        .video-category {
            color: var(--secondary);
        }

        /* è§†é¢‘æ’­æ”¾å™¨æ¨¡æ€æ¡† */
        .player-modal {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(0, 0, 0, 0.95);
            z-index: 2000;
            display: none;
            flex-direction: column;
        }
        .player-modal.show { display: flex; }

        .player-header {
            height: 60px;
            background: rgba(20, 20, 20, 0.9);
            display: flex;
            align-items: center;
            justify-content: space-between;
            padding: 0 20px;
            border-bottom: 1px solid var(--glass-border);
        }

        .player-title {
            color: #fff;
            font-weight: 600;
        }

        .player-close {
            background: none;
            border: none;
            color: #888;
            font-size: 1.5em;
            cursor: pointer;
            transition: color 0.3s;
        }
        .player-close:hover { color: #fff; }

        .player-body {
            flex: 1;
            display: flex;
            overflow: hidden;
        }

        .player-main {
            flex: 1;
            display: flex;
            flex-direction: column;
        }

        .video-container {
            flex: 1;
            background: #000;
            display: flex;
            align-items: center;
            justify-content: center;
            position: relative;
        }

        .video-container video {
            max-width: 100%;
            max-height: 100%;
        }

        /* é¢„è§ˆé™åˆ¶é®ç½© */
        .preview-overlay {
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(0, 0, 0, 0.9);
            display: none;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            gap: 20px;
            z-index: 10;
        }
        .preview-overlay.show { display: flex; }

        .preview-overlay i {
            font-size: 4em;
            color: var(--gold);
        }
        .preview-overlay h3 {
            color: #fff;
            font-size: 1.5em;
        }
        .preview-overlay p {
            color: #aaa;
            max-width: 400px;
            text-align: center;
            line-height: 1.6;
        }
        .preview-overlay .unlock-btn {
            background: linear-gradient(135deg, var(--gold), #ff8c00);
            color: #000;
            border: none;
            padding: 15px 40px;
            border-radius: 8px;
            font-weight: bold;
            cursor: pointer;
            font-size: 1em;
            transition: all 0.3s;
        }
        .preview-overlay .unlock-btn:hover {
            transform: scale(1.05);
            box-shadow: 0 0 30px rgba(255, 215, 0, 0.5);
        }

        /* è¯„è®ºä¾§è¾¹æ  */
        .comments-sidebar {
            width: 380px;
            background: rgba(15, 15, 15, 0.95);
            border-left: 1px solid var(--glass-border);
            display: flex;
            flex-direction: column;
        }

        .comments-header {
            padding: 15px 20px;
            border-bottom: 1px solid var(--glass-border);
            display: flex;
            justify-content: space-between;
            align-items: center;
        }
        .comments-header h4 {
            color: var(--primary);
            font-family: 'Rajdhani', sans-serif;
        }

        .comments-list {
            flex: 1;
            overflow-y: auto;
            padding: 15px;
        }

        .comment-item {
            background: rgba(255, 255, 255, 0.03);
            border-radius: 8px;
            padding: 12px;
            margin-bottom: 10px;
            border: 1px solid transparent;
        }
        .comment-item:hover {
            border-color: rgba(0, 243, 255, 0.2);
        }
        .comment-header {
            display: flex;
            align-items: center;
            gap: 10px;
            margin-bottom: 8px;
        }
        .comment-avatar {
            width: 30px;
            height: 30px;
            border-radius: 50%;
            background: rgba(0, 243, 255, 0.1);
            border: 1px solid rgba(0, 243, 255, 0.3);
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 0.9em;
            overflow: hidden;
        }
        .comment-avatar img { width: 100%; height: 100%; object-fit: cover; }
        .comment-avatar.admin {
            border-color: var(--gold);
            background: rgba(255, 215, 0, 0.1);
        }
        .comment-name {
            font-size: 0.85em;
            color: #fff;
        }
        .comment-name.admin { color: var(--gold); }
        .comment-time {
            font-size: 0.75em;
            color: #666;
            margin-left: auto;
        }
        .comment-content {
            font-size: 0.9em;
            color: #ccc;
            line-height: 1.5;
        }
        .comment-actions {
            display: flex;
            gap: 15px;
            margin-top: 8px;
        }
        .comment-actions button {
            background: none;
            border: none;
            color: #666;
            font-size: 0.8em;
            cursor: pointer;
            display: flex;
            align-items: center;
            gap: 4px;
            transition: color 0.3s;
        }
        .comment-actions button:hover {
            color: var(--primary);
        }
        .comment-actions button.delete:hover {
            color: #ff4757;
        }
        /* æ¥¼ä¸­æ¥¼å›å¤ */
        .comment-replies {
            margin-top: 10px;
            margin-left: 40px;
            border-left: 2px solid rgba(0, 243, 255, 0.2);
            padding-left: 12px;
        }
        .reply-item {
            background: rgba(0, 243, 255, 0.03);
            border-radius: 6px;
            padding: 10px;
            margin-bottom: 8px;
        }
        .reply-item .comment-avatar {
            width: 24px;
            height: 24px;
            font-size: 0.75em;
        }
        .reply-item .comment-name {
            font-size: 0.8em;
        }
        .reply-item .comment-content {
            font-size: 0.85em;
        }
        .reply-to-hint {
            color: var(--primary);
            font-size: 0.85em;
            margin-right: 5px;
        }
        /* å›å¤æç¤ºæ¡ */
        .reply-hint {
            display: none;
            align-items: center;
            gap: 10px;
            padding: 8px 12px;
            background: rgba(0, 243, 255, 0.1);
            border-radius: 6px;
            margin-bottom: 10px;
            font-size: 0.85em;
        }
        .reply-hint.show { display: flex; }
        .reply-hint span { flex: 1; color: var(--primary); }
        .reply-hint button {
            background: none;
            border: none;
            color: #888;
            cursor: pointer;
        }
        .reply-hint button:hover { color: #fff; }

        .comment-input-area {
            padding: 15px;
            border-top: 1px solid var(--glass-border);
        }
        .comment-input-area textarea {
            width: 100%;
            background: rgba(255, 255, 255, 0.05);
            border: 1px solid var(--glass-border);
            border-radius: 8px;
            padding: 12px;
            color: #fff;
            resize: none;
            height: 80px;
            font-family: inherit;
        }
        .comment-input-area textarea:focus {
            outline: none;
            border-color: var(--primary);
        }
        .comment-input-area textarea::placeholder { color: #555; }

        .comment-submit {
            margin-top: 10px;
            width: 100%;
            background: linear-gradient(135deg, var(--primary), var(--secondary));
            border: none;
            padding: 10px;
            border-radius: 8px;
            color: #fff;
            font-weight: bold;
            cursor: pointer;
            transition: all 0.3s;
        }
        .comment-submit:hover { opacity: 0.9; }
        .comment-submit:disabled {
            opacity: 0.5;
            cursor: not-allowed;
        }

        /* ç©ºçŠ¶æ€ */
        .empty-state {
            text-align: center;
            padding: 60px 20px;
            color: #666;
        }
        .empty-state i {
            font-size: 4em;
            margin-bottom: 20px;
            opacity: 0.3;
        }

        /* ç™»å½•æç¤º */
        .login-prompt {
            text-align: center;
            padding: 20px;
            color: #888;
        }
        .login-prompt a {
            color: var(--primary);
            cursor: pointer;
        }

        /* Toast æ¶ˆæ¯ */
        .toast {
            position: fixed;
            top: 80px;
            right: 20px;
            background: var(--glass);
            border: 1px solid var(--glass-border);
            border-radius: 8px;
            padding: 15px 20px;
            display: flex;
            align-items: center;
            gap: 10px;
            z-index: 3000;
            transform: translateX(120%);
            transition: transform 0.3s;
        }
        .toast.show { transform: translateX(0); }
        .toast.success { border-color: #4caf50; }
        .toast.error { border-color: #f44336; }
        .toast.warning { border-color: #ff9800; }
        .toast i { font-size: 1.2em; }
        .toast.success i { color: #4caf50; }
        .toast.error i { color: #f44336; }
        .toast.warning i { color: #ff9800; }

        /* å“åº”å¼ */
        @media (max-width: 900px) {
            .comments-sidebar { display: none; }
            .main-content { padding: 20px; }
            .video-grid { grid-template-columns: repeat(auto-fill, minmax(250px, 1fr)); }
        }

        @media (max-width: 600px) {
            .top-nav { padding: 0 15px; }
            .nav-title span { display: none; }
            .membership-banner { flex-direction: column; gap: 15px; text-align: center; }
            .video-grid { grid-template-columns: 1fr; }
        }
    </style>
</head>
<body>
    <!-- èƒŒæ™¯ç‰¹æ•ˆ -->
    <canvas id="canvas"></canvas>
    <div class="cyber-grid"></div>

    <!-- é¡¶éƒ¨å¯¼èˆª -->
    <nav class="top-nav">
        <div class="nav-left">
            <a href="index.html" class="back-btn">
                <i class="fas fa-arrow-left"></i>
                <span>è¿”å›é¦–é¡µ</span>
            </a>
            <div class="nav-title">
                <i class="fas fa-play-circle"></i>
                <span>è§†é¢‘ä¸“åŒº</span>
                <span class="vip-badge">VIDEO</span>
            </div>
        </div>
        <div class="nav-right">
            <div id="authArea">
                <!-- æœªç™»å½• -->
                <div id="loginPrompt" style="display:none;">
                    <a href="index.html" style="color:var(--primary);">è¯·å…ˆç™»å½•</a>
                </div>
                <!-- å·²ç™»å½• -->
                <div id="userArea" class="user-info" style="display:none;">
                    <a href="video-admin.html" id="adminLink" class="admin-link" style="display:none;"><i class="fas fa-cog"></i> ç®¡ç†</a>
                    <span id="membershipBadge" class="membership-status free">æ™®é€šç”¨æˆ·</span>
                    <div class="user-avatar" id="userAvatar">ğŸ‘¤</div>
                    <span class="user-name" id="userName">ç”¨æˆ·</span>
                </div>
            </div>
        </div>
    </nav>

    <!-- ä¸»å†…å®¹ -->
    <div class="main-content">
        <!-- ä¼šå‘˜æ¨ªå¹… - éä¼šå‘˜æ˜¾ç¤º -->
        <div class="membership-banner" id="freeBanner">
            <div class="banner-content">
                <h3><i class="fas fa-lock"></i> æ‚¨å½“å‰æ˜¯æ™®é€šç”¨æˆ·</h3>
                <p>å¼€é€šæ°¸ä¹…ä¼šå‘˜ï¼Œè§£é”å…¨éƒ¨ç²¾åè¯¾ç¨‹ï¼Œä»·æ ¼ï¼š<strong style="color:var(--gold);">Â¥699</strong>ï¼ˆæ°¸ä¹…æœ‰æ•ˆï¼ŒæŒç»­æ›´æ–°ï¼‰</p>
            </div>
            <button class="banner-btn" onclick="showUpgradeModal()">
                <i class="fas fa-crown"></i> ç«‹å³å¼€é€š
            </button>
        </div>

        <!-- ä¼šå‘˜æ¨ªå¹… - ä¼šå‘˜æ˜¾ç¤º -->
        <div class="membership-banner banner-premium" id="premiumBanner" style="display:none;">
            <div class="banner-content">
                <h3><i class="fas fa-check-circle"></i> å°Šè´µçš„æ°¸ä¹…ä¼šå‘˜</h3>
                <p>æ„Ÿè°¢æ‚¨çš„æ”¯æŒï¼æ‚¨å¯ä»¥æ— é™åˆ¶è§‚çœ‹æ‰€æœ‰ç²¾åè¯¾ç¨‹ã€‚</p>
            </div>
        </div>

        <!-- è§†é¢‘åˆ—è¡¨ -->
        <div class="section-title">
            <i class="fas fa-play-circle"></i>
            ç²¾åè¯¾ç¨‹
            <span style="color:#666;font-size:0.8em;font-family:'Noto Sans SC';" id="videoCount">(0)</span>
        </div>

        <div class="video-grid" id="videoGrid">
            <!-- è§†é¢‘å¡ç‰‡é€šè¿‡JSæ¸²æŸ“ -->
            <div class="empty-state">
                <i class="fas fa-spinner fa-spin"></i>
                <p>åŠ è½½ä¸­...</p>
            </div>
        </div>
    </div>

    <!-- è§†é¢‘æ’­æ”¾å™¨æ¨¡æ€æ¡† -->
    <div class="player-modal" id="playerModal">
        <div class="player-header">
            <span class="player-title" id="playerTitle">è§†é¢‘æ ‡é¢˜</span>
            <button class="player-close" onclick="closePlayer()">
                <i class="fas fa-times"></i>
            </button>
        </div>
        <div class="player-body">
            <div class="player-main">
                <div class="video-container">
                    <video id="videoPlayer" controls>
                        <source src="" type="application/x-mpegURL">
                    </video>
                    <!-- é¢„è§ˆé™åˆ¶é®ç½© -->
                    <div class="preview-overlay" id="previewOverlay">
                        <i class="fas fa-lock"></i>
                        <h3>é¢„è§ˆå·²ç»“æŸ</h3>
                        <p>æ‚¨å·²è§‚çœ‹30ç§’é¢„è§ˆã€‚å¼€é€šæ°¸ä¹…ä¼šå‘˜å³å¯è§£é”å…¨éƒ¨å†…å®¹ï¼Œä»·æ ¼ä»…éœ€ Â¥699ã€‚</p>
                        <button class="unlock-btn" onclick="showUpgradeModal()">
                            <i class="fas fa-crown"></i> ç«‹å³å¼€é€šä¼šå‘˜
                        </button>
                        <button class="replay-btn" onclick="replayPreview()" style="margin-top:10px;background:transparent;border:1px solid #666;color:#888;padding:10px 20px;border-radius:5px;cursor:pointer;">
                            <i class="fas fa-redo"></i> é‡æ–°è§‚çœ‹é¢„è§ˆ
                        </button>
                    </div>
                </div>
            </div>
            <!-- è¯„è®ºä¾§è¾¹æ  -->
            <div class="comments-sidebar">
                <div class="comments-header">
                    <h4><i class="fas fa-comments"></i> è¯¾ç¨‹è®¨è®º</h4>
                    <span id="commentCount" style="color:#666;font-size:0.85em;">0æ¡è¯„è®º</span>
                </div>
                <div class="comments-list" id="commentsList">
                    <!-- è¯„è®ºåˆ—è¡¨ -->
                </div>
                <div class="comment-input-area" id="commentInputArea">
                    <div class="reply-hint" id="replyHint">
                        <i class="fas fa-reply"></i>
                        <span>å›å¤ <strong id="replyToName"></strong></span>
                        <button onclick="cancelReply()"><i class="fas fa-times"></i></button>
                    </div>
                    <textarea id="commentInput" placeholder="å‘è¡¨ä½ çš„çœ‹æ³•..." maxlength="300"></textarea>
                    <button class="comment-submit" id="commentSubmitBtn" onclick="submitComment()">
                        <i class="fas fa-paper-plane"></i> å‘é€è¯„è®º
                    </button>
                </div>
            </div>
        </div>
    </div>

    <!-- Toast -->
    <div class="toast" id="toast">
        <i class="fas fa-info-circle"></i>
        <span id="toastText">æ¶ˆæ¯</span>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/hls.js@latest"></script>
    <script>
        // Supabase é…ç½®
        const SUPABASE_URL = 'https://qzpvogxvlescfwpqahsn.supabase.co';
        const SUPABASE_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InF6cHZvZ3h2bGVzY2Z3cHFhaHNuIiwicm9sZSI6ImFub24iLCJpYXQiOjE3Njc5MzMyMzMsImV4cCI6MjA4MzUwOTIzM30.2uadJyp_KJNxRuFm1NIkuRPrTzq0-lBfuH3gb20LXGc';
        const ADMIN_UUID = '71c4e4e1-a1b6-47f8-aaa8-c62ae020e1eb';

        let currentUser = null;
        let isPremium = false;
        let currentVideo = null;
        let previewDuration = 30;
        let videoPlayer = null;
        let hlsPlayer = null;

        // Token åˆ·æ–°å‡½æ•°
        function refreshAccessToken() {
            var refreshToken = localStorage.getItem('nexus_refresh_token');
            if (!refreshToken) {
                return Promise.reject('No refresh token');
            }
            
            return fetch(SUPABASE_URL + '/auth/v1/token?grant_type=refresh_token', {
                method: 'POST',
                headers: {
                    'apikey': SUPABASE_KEY,
                    'Content-Type': 'application/json'
                },
                body: JSON.stringify({ refresh_token: refreshToken })
            })
            .then(function(response) {
                if (!response.ok) throw new Error('Refresh failed');
                return response.json();
            })
            .then(function(data) {
                if (data.access_token) {
                    localStorage.setItem('nexus_access_token', data.access_token);
                    if (data.refresh_token) {
                        localStorage.setItem('nexus_refresh_token', data.refresh_token);
                    }
                    if (data.user) {
                        currentUser = data.user;
                        localStorage.setItem('nexus_user', JSON.stringify(data.user));
                    }
                    return data.access_token;
                }
                throw new Error('No access token');
            });
        }
        
        // å¸¦è®¤è¯çš„è¯·æ±‚ï¼ˆè‡ªåŠ¨åˆ·æ–°tokenï¼‰
        function fetchWithAuth(url, options) {
            var accessToken = localStorage.getItem('nexus_access_token');
            
            if (!options) options = {};
            if (!options.headers) options.headers = {};
            
            options.headers['apikey'] = SUPABASE_KEY;
            options.headers['Authorization'] = 'Bearer ' + (accessToken || SUPABASE_KEY);
            
            return fetch(url, options)
                .then(function(response) {
                    if (response.status === 401 && accessToken) {
                        // Token è¿‡æœŸï¼Œå°è¯•åˆ·æ–°
                        return refreshAccessToken()
                            .then(function(newToken) {
                                options.headers['Authorization'] = 'Bearer ' + newToken;
                                return fetch(url, options);
                            })
                            .catch(function() {
                                return response;
                            });
                    }
                    return response;
                });
        }

        // åˆå§‹åŒ–
        document.addEventListener('DOMContentLoaded', function() {
            checkLoginStatus();
            loadVideos();
            initParticles();
        });

        // æ£€æŸ¥ç™»å½•çŠ¶æ€
        function checkLoginStatus() {
            const userData = localStorage.getItem('nexus_user');
            const accessToken = localStorage.getItem('nexus_access_token');
            
            if (userData && accessToken) {
                try {
                    currentUser = JSON.parse(userData);
                    updateUserUI();
                    checkMembership();
                } catch (e) {
                    showLoginPrompt();
                }
            } else {
                showLoginPrompt();
            }
        }

        function showLoginPrompt() {
            document.getElementById('loginPrompt').style.display = 'block';
            document.getElementById('userArea').style.display = 'none';
        }

        function updateUserUI() {
            document.getElementById('loginPrompt').style.display = 'none';
            document.getElementById('userArea').style.display = 'flex';
            
            var displayName = 'ç”¨æˆ·';
            var avatarHtml = 'ğŸ‘¤';
            
            if (currentUser.user_metadata) {
                if (currentUser.user_metadata.full_name) {
                    displayName = currentUser.user_metadata.full_name;
                }
                if (currentUser.user_metadata.avatar_url) {
                    avatarHtml = '<img src="' + currentUser.user_metadata.avatar_url + '" alt="å¤´åƒ">';
                } else if (currentUser.user_metadata.avatar) {
                    avatarHtml = currentUser.user_metadata.avatar;
                }
            }
            
            document.getElementById('userName').textContent = displayName;
            document.getElementById('userAvatar').innerHTML = avatarHtml;
            
            // ç«™é•¿æ˜¾ç¤ºç®¡ç†å…¥å£
            if (currentUser.id === ADMIN_UUID) {
                document.getElementById('adminLink').style.display = 'flex';
            }
        }

        // æ£€æŸ¥ä¼šå‘˜çŠ¶æ€
        function checkMembership() {
            if (!currentUser) return;
            
            var accessToken = localStorage.getItem('nexus_access_token');
            
            // ç«™é•¿è‡ªåŠ¨æ‹¥æœ‰ä¼šå‘˜æƒé™
            if (currentUser.id === ADMIN_UUID) {
                isPremium = true;
                document.getElementById('membershipBadge').textContent = 'ç«™é•¿';
                document.getElementById('membershipBadge').className = 'membership-status premium';
                document.getElementById('freeBanner').style.display = 'none';
                document.getElementById('premiumBanner').style.display = 'flex';
                return;
            }
            
            fetch(SUPABASE_URL + '/rest/v1/user_memberships?user_id=eq.' + currentUser.id + '&select=*', {
                method: 'GET',
                headers: {
                    'apikey': SUPABASE_KEY,
                    'Authorization': 'Bearer ' + accessToken
                }
            })
            .then(function(res) { return res.json(); })
            .then(function(data) {
                if (data && data.length > 0 && data[0].membership_type === 'premium') {
                    isPremium = true;
                    document.getElementById('membershipBadge').textContent = 'æ°¸ä¹…ä¼šå‘˜';
                    document.getElementById('membershipBadge').className = 'membership-status premium';
                    document.getElementById('freeBanner').style.display = 'none';
                    document.getElementById('premiumBanner').style.display = 'flex';
                }
            })
            .catch(function(err) {
                console.error('æ£€æŸ¥ä¼šå‘˜çŠ¶æ€å¤±è´¥:', err);
            });
        }

        // åŠ è½½è§†é¢‘åˆ—è¡¨
        function loadVideos() {
            fetch(SUPABASE_URL + '/rest/v1/videos?is_published=eq.true&order=sort_order.asc,created_at.desc', {
                method: 'GET',
                headers: {
                    'apikey': SUPABASE_KEY
                }
            })
            .then(function(res) { 
                console.log('è§†é¢‘APIå“åº”çŠ¶æ€:', res.status);
                return res.json(); 
            })
            .then(function(videos) {
                console.log('è§†é¢‘APIè¿”å›æ•°æ®:', videos);
                // æ£€æŸ¥æ˜¯å¦æ˜¯æ•°ç»„
                if (!Array.isArray(videos)) {
                    console.error('APIè¿”å›çš„ä¸æ˜¯æ•°ç»„:', videos);
                    // å¯èƒ½æ˜¯RLSæƒé™é—®é¢˜
                    if (videos.message) {
                        throw new Error(videos.message);
                    }
                    videos = [];
                }
                renderVideos(videos);
            })
            .catch(function(err) {
                console.error('åŠ è½½è§†é¢‘å¤±è´¥:', err);
                document.getElementById('videoGrid').innerHTML = '<div class="empty-state"><i class="fas fa-exclamation-triangle"></i><p>åŠ è½½å¤±è´¥ï¼Œè¯·åˆ·æ–°é‡è¯•</p></div>';
            });
        }

        // æ¸²æŸ“è§†é¢‘åˆ—è¡¨
        function renderVideos(videos) {
            var grid = document.getElementById('videoGrid');
            document.getElementById('videoCount').textContent = '(' + videos.length + ')';
            
            if (videos.length === 0) {
                grid.innerHTML = '<div class="empty-state"><i class="fas fa-video-slash"></i><p>æš‚æ— è¯¾ç¨‹ï¼Œæ•¬è¯·æœŸå¾…</p></div>';
                return;
            }
            
            var html = '';
            videos.forEach(function(video) {
                var duration = formatDuration(video.duration);
                var isFreeVideo = video.is_free === true;
                
                html += '<div class="video-card" onclick="openVideo(\'' + video.id + '\')">';
                html += '<div class="video-thumbnail">';
                if (video.cover_url) {
                    html += '<img src="' + video.cover_url + '" alt="' + escapeHtml(video.title) + '">';
                } else {
                    html += '<div style="width:100%;height:100%;background:linear-gradient(135deg,#1a1a2e,#16213e);display:flex;align-items:center;justify-content:center;"><i class="fas fa-play" style="font-size:2em;color:#333;"></i></div>';
                }
                html += '<div class="play-icon"><i class="fas fa-play"></i></div>';
                html += '<span class="video-duration">' + duration + '</span>';
                
                // æ˜¾ç¤ºå…è´¹æˆ–ä¼šå‘˜æ ‡ç­¾
                if (isFreeVideo) {
                    html += '<span class="video-free"><i class="fas fa-gift"></i> å…è´¹</span>';
                } else if (!isPremium) {
                    html += '<span class="video-lock"><i class="fas fa-lock"></i> ä¼šå‘˜</span>';
                }
                
                html += '</div>';
                html += '<div class="video-info">';
                html += '<div class="video-title">' + escapeHtml(video.title) + '</div>';
                html += '<div class="video-meta">';
                html += '<span class="video-category">' + escapeHtml(video.category || 'ç²¾åè¯¾ç¨‹') + '</span>';
                html += '<span><i class="fas fa-eye"></i> ' + (video.view_count || 0) + '</span>';
                html += '</div></div></div>';
            });
            
            grid.innerHTML = html;
        }

        // æ‰“å¼€è§†é¢‘
        function openVideo(videoId) {
            if (!currentUser) {
                showToast('è¯·å…ˆç™»å½•åè§‚çœ‹', 'warning');
                return;
            }
            
            // è·å–è§†é¢‘ä¿¡æ¯
            fetch(SUPABASE_URL + '/rest/v1/videos?id=eq.' + videoId, {
                method: 'GET',
                headers: { 'apikey': SUPABASE_KEY }
            })
            .then(function(res) { return res.json(); })
            .then(function(data) {
                if (data && data.length > 0) {
                    currentVideo = data[0];
                    previewDuration = currentVideo.preview_duration || 30;
                    showPlayer();
                    loadVideoComments(videoId);
                    incrementViewCount(videoId);
                }
            });
        }

        // æ˜¾ç¤ºæ’­æ”¾å™¨
        function showPlayer() {
            document.getElementById('playerTitle').textContent = currentVideo.title;
            document.getElementById('playerModal').classList.add('show');
            document.body.classList.add('modal-open');
            
            // é‡ç½®é¢„è§ˆé®ç½©
            document.getElementById('previewOverlay').classList.remove('show');
            
            // åˆå§‹åŒ–æ’­æ”¾å™¨
            initPlayer(currentVideo.video_url);
        }

        // åˆå§‹åŒ– HLS æ’­æ”¾å™¨
        function initPlayer(videoUrl) {
            videoPlayer = document.getElementById('videoPlayer');
            
            // é”€æ¯æ—§çš„ HLS å®ä¾‹
            if (hlsPlayer) {
                hlsPlayer.destroy();
            }
            
            if (videoUrl.includes('.m3u8') && Hls.isSupported()) {
                hlsPlayer = new Hls();
                hlsPlayer.loadSource(videoUrl);
                hlsPlayer.attachMedia(videoPlayer);
                hlsPlayer.on(Hls.Events.MANIFEST_PARSED, function() {
                    videoPlayer.play();
                });
            } else {
                videoPlayer.src = videoUrl;
                videoPlayer.play();
            }
            
            // åˆ¤æ–­æ˜¯å¦éœ€è¦é™åˆ¶ï¼šéä¼šå‘˜ ä¸” éå…è´¹è§†é¢‘
            var needLimit = !isPremium && !currentVideo.is_free;
            
            if (needLimit) {
                // ç›‘å¬æ—¶é—´æ›´æ–°
                videoPlayer.addEventListener('timeupdate', checkPreviewLimit);
                // ç›‘å¬æ‹–åŠ¨è¿›åº¦æ¡ï¼ˆseekingï¼‰
                videoPlayer.addEventListener('seeking', preventSeekBeyondPreview);
                // ç›‘å¬æ’­æ”¾é€Ÿåº¦å˜åŒ–ï¼Œç¦æ­¢åŠ é€Ÿ
                videoPlayer.addEventListener('ratechange', preventSpeedChange);
            }
        }

        // æ£€æŸ¥é¢„è§ˆæ—¶é—´é™åˆ¶
        function checkPreviewLimit() {
            // ä¼šå‘˜æˆ–å…è´¹è§†é¢‘ä¸é™åˆ¶
            if (isPremium || (currentVideo && currentVideo.is_free)) return;
            
            if (videoPlayer.currentTime >= previewDuration) {
                videoPlayer.pause();
                videoPlayer.currentTime = previewDuration; // å¼ºåˆ¶åœåœ¨é¢„è§ˆæ—¶é•¿
                showPreviewOverlay();
            }
        }
        
        // é˜»æ­¢æ‹–åŠ¨è¶…è¿‡é¢„è§ˆæ—¶é•¿
        function preventSeekBeyondPreview() {
            // ä¼šå‘˜æˆ–å…è´¹è§†é¢‘ä¸é™åˆ¶
            if (isPremium || (currentVideo && currentVideo.is_free)) return;
            
            if (videoPlayer.currentTime >= previewDuration) {
                videoPlayer.currentTime = previewDuration - 1; // æ‹‰å›åˆ°é¢„è§ˆæ—¶é•¿å‰1ç§’
                videoPlayer.pause();
                showPreviewOverlay();
            }
        }
        
        // ç¦æ­¢å€é€Ÿæ’­æ”¾
        function preventSpeedChange() {
            // ä¼šå‘˜æˆ–å…è´¹è§†é¢‘ä¸é™åˆ¶
            if (isPremium || (currentVideo && currentVideo.is_free)) return;
            
            if (videoPlayer.playbackRate !== 1) {
                videoPlayer.playbackRate = 1;
                showToast('éä¼šå‘˜ä¸æ”¯æŒå€é€Ÿæ’­æ”¾', 'warning');
            }
        }
        
        // æ˜¾ç¤ºé¢„è§ˆç»“æŸé®ç½©
        function showPreviewOverlay() {
            // ç«‹å³æš‚åœè§†é¢‘ï¼
            videoPlayer.pause();
            videoPlayer.currentTime = previewDuration;
            
            document.getElementById('previewOverlay').classList.add('show');
            
            // ç§»é™¤æ‰€æœ‰äº‹ä»¶ç›‘å¬
            videoPlayer.removeEventListener('timeupdate', checkPreviewLimit);
            videoPlayer.removeEventListener('seeking', preventSeekBeyondPreview);
            videoPlayer.removeEventListener('ratechange', preventSpeedChange);
            
            // æ·»åŠ æ’­æ”¾äº‹ä»¶ç›‘å¬ï¼Œé˜²æ­¢ç”¨æˆ·ç‚¹å‡»æ’­æ”¾æŒ‰é’®ç»§ç»­æ’­æ”¾
            videoPlayer.addEventListener('play', blockPlayAfterPreview);
        }
        
        // é˜»æ­¢é¢„è§ˆç»“æŸåç»§ç»­æ’­æ”¾
        function blockPlayAfterPreview() {
            // ä¼šå‘˜æˆ–å…è´¹è§†é¢‘ä¸é™åˆ¶
            if (isPremium || (currentVideo && currentVideo.is_free)) return;
            
            var overlay = document.getElementById('previewOverlay');
            if (overlay.classList.contains('show')) {
                videoPlayer.pause();
                videoPlayer.currentTime = previewDuration;
            }
        }
        
        // é‡æ–°è§‚çœ‹é¢„è§ˆ
        function replayPreview() {
            // ç§»é™¤é˜»æ­¢æ’­æ”¾çš„ç›‘å¬
            videoPlayer.removeEventListener('play', blockPlayAfterPreview);
            
            document.getElementById('previewOverlay').classList.remove('show');
            videoPlayer.currentTime = 0;
            videoPlayer.play();
            
            // é‡æ–°æ·»åŠ é™åˆ¶ç›‘å¬
            if (!isPremium) {
                videoPlayer.addEventListener('timeupdate', checkPreviewLimit);
                videoPlayer.addEventListener('seeking', preventSeekBeyondPreview);
                videoPlayer.addEventListener('ratechange', preventSpeedChange);
            }
        }

        // å…³é—­æ’­æ”¾å™¨
        function closePlayer() {
            document.getElementById('playerModal').classList.remove('show');
            document.body.classList.remove('modal-open');
            document.getElementById('previewOverlay').classList.remove('show');
            
            if (videoPlayer) {
                videoPlayer.pause();
                videoPlayer.removeEventListener('timeupdate', checkPreviewLimit);
                videoPlayer.removeEventListener('seeking', preventSeekBeyondPreview);
                videoPlayer.removeEventListener('ratechange', preventSpeedChange);
                videoPlayer.removeEventListener('play', blockPlayAfterPreview);
            }
            if (hlsPlayer) {
                hlsPlayer.destroy();
                hlsPlayer = null;
            }
            
            currentVideo = null;
        }

        // å¢åŠ è§‚çœ‹æ¬¡æ•°
        function incrementViewCount(videoId) {
            fetch(SUPABASE_URL + '/rest/v1/rpc/increment_view_count', {
                method: 'POST',
                headers: {
                    'apikey': SUPABASE_KEY,
                    'Content-Type': 'application/json'
                },
                body: JSON.stringify({ video_id: videoId })
            }).catch(function() {});
        }

        // åŠ è½½è¯„è®ºï¼ˆåŒ…å«å›å¤ï¼‰
        var replyToId = null;
        var replyToName = null;
        var commentsData = [];
        
        function loadVideoComments(videoId) {
            // åŠ è½½æ‰€æœ‰è¯„è®ºï¼ˆçˆ¶è¯„è®ºå’Œå›å¤ï¼‰
            fetch(SUPABASE_URL + '/rest/v1/video_comments_with_profile?video_id=eq.' + videoId + '&order=created_at.asc', {
                method: 'GET',
                headers: { 'apikey': SUPABASE_KEY }
            })
            .then(function(res) { return res.json(); })
            .then(function(comments) {
                commentsData = comments || [];
                renderComments();
            });
        }

        // æ¸²æŸ“è¯„è®ºï¼ˆæ”¯æŒæ¥¼ä¸­æ¥¼ï¼‰
        function renderComments() {
            var container = document.getElementById('commentsList');
            
            // åˆ†ç¦»çˆ¶è¯„è®ºå’Œå›å¤
            var parentComments = commentsData.filter(function(c) { return !c.parent_id; });
            var replies = commentsData.filter(function(c) { return c.parent_id; });
            
            // æŒ‰çˆ¶è¯„è®ºåˆ†ç»„å›å¤
            var repliesMap = {};
            replies.forEach(function(r) {
                if (!repliesMap[r.parent_id]) repliesMap[r.parent_id] = [];
                repliesMap[r.parent_id].push(r);
            });
            
            document.getElementById('commentCount').textContent = commentsData.length + 'æ¡è¯„è®º';
            
            if (parentComments.length === 0) {
                container.innerHTML = '<div style="text-align:center;color:#666;padding:40px;">æš‚æ— è¯„è®ºï¼Œæ¥å‘è¡¨ç¬¬ä¸€æ¡å§</div>';
                return;
            }
            
            var html = '';
            parentComments.forEach(function(c) {
                html += createCommentHTML(c, repliesMap[c.id] || []);
            });
            
            container.innerHTML = html;
        }
        
        // åˆ›å»ºå•æ¡è¯„è®ºHTML
        function createCommentHTML(comment, replies) {
            var avatarHtml = comment.avatar_url 
                ? '<img src="' + comment.avatar_url + '" alt="">' 
                : 'ğŸ‘¤';
            var isOwn = currentUser && currentUser.id === comment.user_id;
            var isAdminComment = comment.is_admin;
            
            var html = '<div class="comment-item" data-id="' + comment.id + '">';
            html += '<div class="comment-header">';
            html += '<div class="comment-avatar' + (isAdminComment ? ' admin' : '') + '">' + avatarHtml + '</div>';
            html += '<span class="comment-name' + (isAdminComment ? ' admin' : '') + '">' + escapeHtml(comment.user_name);
            if (isAdminComment) html += ' <i class="fas fa-crown" style="color:var(--gold);font-size:0.8em;"></i>';
            html += '</span>';
            html += '<span class="comment-time">' + getTimeAgo(comment.created_at) + '</span>';
            html += '</div>';
            html += '<div class="comment-content">' + escapeHtml(comment.content) + '</div>';
            
            // æ“ä½œæŒ‰é’®
            html += '<div class="comment-actions">';
            html += '<button onclick="replyTo(\'' + comment.id + '\', \'' + escapeHtml(comment.user_name) + '\')"><i class="fas fa-reply"></i> å›å¤</button>';
            if (isOwn || (currentUser && currentUser.id === ADMIN_UUID)) {
                html += '<button class="delete" onclick="deleteComment(\'' + comment.id + '\')"><i class="fas fa-trash"></i> åˆ é™¤</button>';
            }
            html += '</div>';
            
            // æ¸²æŸ“å›å¤ï¼ˆæ¥¼ä¸­æ¥¼ï¼‰
            if (replies.length > 0) {
                html += '<div class="comment-replies">';
                replies.forEach(function(r) {
                    html += createReplyHTML(r, comment.user_name);
                });
                html += '</div>';
            }
            
            html += '</div>';
            return html;
        }
        
        // åˆ›å»ºå›å¤HTML
        function createReplyHTML(reply, parentUserName) {
            var avatarHtml = reply.avatar_url 
                ? '<img src="' + reply.avatar_url + '" alt="">' 
                : 'ğŸ‘¤';
            var isOwn = currentUser && currentUser.id === reply.user_id;
            var isAdminReply = reply.is_admin;
            
            var html = '<div class="reply-item" data-id="' + reply.id + '">';
            html += '<div class="comment-header">';
            html += '<div class="comment-avatar' + (isAdminReply ? ' admin' : '') + '">' + avatarHtml + '</div>';
            html += '<span class="comment-name' + (isAdminReply ? ' admin' : '') + '">' + escapeHtml(reply.user_name);
            if (isAdminReply) html += ' <i class="fas fa-crown" style="color:var(--gold);font-size:0.7em;"></i>';
            html += '</span>';
            html += '<span class="comment-time">' + getTimeAgo(reply.created_at) + '</span>';
            html += '</div>';
            html += '<div class="comment-content">';
            html += '<span class="reply-to-hint">å›å¤ @' + escapeHtml(parentUserName) + 'ï¼š</span>';
            html += escapeHtml(reply.content);
            html += '</div>';
            
            // å›å¤çš„æ“ä½œæŒ‰é’®
            html += '<div class="comment-actions">';
            if (isOwn || (currentUser && currentUser.id === ADMIN_UUID)) {
                html += '<button class="delete" onclick="deleteComment(\'' + reply.id + '\')"><i class="fas fa-trash"></i> åˆ é™¤</button>';
            }
            html += '</div>';
            
            html += '</div>';
            return html;
        }
        
        // å›å¤æŸæ¡è¯„è®º
        function replyTo(commentId, userName) {
            if (!currentUser) {
                showToast('è¯·å…ˆç™»å½•', 'warning');
                return;
            }
            replyToId = commentId;
            replyToName = userName;
            document.getElementById('replyToName').textContent = userName;
            document.getElementById('replyHint').classList.add('show');
            document.getElementById('commentInput').focus();
            document.getElementById('commentInput').placeholder = 'å›å¤ ' + userName + '...';
        }
        
        // å–æ¶ˆå›å¤
        function cancelReply() {
            replyToId = null;
            replyToName = null;
            document.getElementById('replyHint').classList.remove('show');
            document.getElementById('commentInput').placeholder = 'å‘è¡¨ä½ çš„çœ‹æ³•...';
        }
        
        // åˆ é™¤è¯„è®º
        function deleteComment(commentId) {
            if (!confirm('ç¡®å®šè¦åˆ é™¤è¿™æ¡è¯„è®ºå—ï¼Ÿ')) return;
            
            var accessToken = localStorage.getItem('nexus_access_token');
            
            fetch(SUPABASE_URL + '/rest/v1/video_comments?id=eq.' + commentId, {
                method: 'DELETE',
                headers: {
                    'apikey': SUPABASE_KEY,
                    'Authorization': 'Bearer ' + accessToken
                }
            })
            .then(function(res) {
                if (res.ok) {
                    showToast('åˆ é™¤æˆåŠŸ', 'success');
                    loadVideoComments(currentVideo.id);
                } else {
                    showToast('åˆ é™¤å¤±è´¥', 'error');
                }
            });
        }

        // å‘è¡¨è¯„è®º
        function submitComment() {
            if (!currentUser) {
                showToast('è¯·å…ˆç™»å½•', 'warning');
                return;
            }
            
            var content = document.getElementById('commentInput').value.trim();
            if (!content) {
                showToast('è¯·è¾“å…¥è¯„è®ºå†…å®¹', 'warning');
                return;
            }
            
            var userName = currentUser.user_metadata?.full_name || 'ç”¨æˆ·';
            var isAdminUser = currentUser.id === ADMIN_UUID;
            
            var commentData = {
                video_id: currentVideo.id,
                user_id: currentUser.id,
                user_name: userName,
                content: content,
                parent_id: replyToId || null,
                is_admin: isAdminUser
            };
            
            document.getElementById('commentSubmitBtn').disabled = true;
            
            fetchWithAuth(SUPABASE_URL + '/rest/v1/video_comments', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                    'Prefer': 'return=minimal'
                },
                body: JSON.stringify(commentData)
            })
            .then(function(res) {
                if (!res.ok) {
                    return res.text().then(function(text) {
                        console.error('è¯„è®ºå¤±è´¥:', text);
                        throw new Error('å‘é€å¤±è´¥');
                    });
                }
                document.getElementById('commentInput').value = '';
                cancelReply();
                showToast('è¯„è®ºæˆåŠŸ', 'success');
                loadVideoComments(currentVideo.id);
            })
            .catch(function(err) {
                console.error('è¯„è®ºé”™è¯¯:', err);
                showToast('è¯„è®ºå¤±è´¥ï¼Œè¯·é‡è¯•', 'error');
            })
            .finally(function() {
                document.getElementById('commentSubmitBtn').disabled = false;
            });
        }

        // æ˜¾ç¤ºå¼€é€šä¼šå‘˜å¼¹çª—
        function showUpgradeModal() {
            closePlayer();
            showToast('è¯·å‰å¾€é¦–é¡µ â†’ åŠ å¯†ä¿¡ç®±ï¼Œè”ç³»ç«™é•¿å¼€é€šä¼šå‘˜', 'info');
            setTimeout(function() {
                window.location.href = 'index.html';
            }, 2000);
        }

        // å·¥å…·å‡½æ•°
        function formatDuration(seconds) {
            if (!seconds) return '00:00';
            var h = Math.floor(seconds / 3600);
            var m = Math.floor((seconds % 3600) / 60);
            var s = seconds % 60;
            if (h > 0) {
                return h + ':' + String(m).padStart(2, '0') + ':' + String(s).padStart(2, '0');
            }
            return String(m).padStart(2, '0') + ':' + String(s).padStart(2, '0');
        }

        function getTimeAgo(dateStr) {
            var date = new Date(dateStr);
            var now = new Date();
            var diff = Math.floor((now - date) / 1000);
            if (diff < 60) return 'åˆšåˆš';
            if (diff < 3600) return Math.floor(diff / 60) + 'åˆ†é’Ÿå‰';
            if (diff < 86400) return Math.floor(diff / 3600) + 'å°æ—¶å‰';
            if (diff < 2592000) return Math.floor(diff / 86400) + 'å¤©å‰';
            return date.toLocaleDateString();
        }

        function escapeHtml(str) {
            if (!str) return '';
            return str.replace(/&/g, '&amp;').replace(/</g, '&lt;').replace(/>/g, '&gt;').replace(/"/g, '&quot;');
        }

        function showToast(text, type) {
            var toast = document.getElementById('toast');
            var icon = toast.querySelector('i');
            document.getElementById('toastText').textContent = text;
            
            toast.className = 'toast ' + (type || 'info');
            icon.className = 'fas fa-' + (type === 'success' ? 'check-circle' : type === 'error' ? 'exclamation-circle' : type === 'warning' ? 'exclamation-triangle' : 'info-circle');
            
            toast.classList.add('show');
            setTimeout(function() { toast.classList.remove('show'); }, 3000);
        }

        // ç²’å­èƒŒæ™¯
        function initParticles() {
            const canvas = document.getElementById('canvas');
            const ctx = canvas.getContext('2d');
            canvas.width = window.innerWidth;
            canvas.height = window.innerHeight;
            
            let particles = [];
            
            class Particle {
                constructor() {
                    this.x = Math.random() * canvas.width;
                    this.y = Math.random() * canvas.height;
                    this.size = Math.random() * 2 + 0.5;
                    this.speedX = (Math.random() * 1 - 0.5);
                    this.speedY = (Math.random() * 1 - 0.5);
                }
                update() {
                    this.x += this.speedX;
                    this.y += this.speedY;
                    if (this.x > canvas.width || this.x < 0) this.speedX *= -1;
                    if (this.y > canvas.height || this.y < 0) this.speedY *= -1;
                }
                draw() {
                    ctx.fillStyle = 'rgba(0, 243, 255, 0.5)';
                    ctx.beginPath();
                    ctx.arc(this.x, this.y, this.size, 0, Math.PI * 2);
                    ctx.fill();
                }
            }
            
            for (let i = 0; i < 50; i++) {
                particles.push(new Particle());
            }
            
            function animate() {
                ctx.clearRect(0, 0, canvas.width, canvas.height);
                particles.forEach(p => { p.update(); p.draw(); });
                requestAnimationFrame(animate);
            }
            animate();
            
            window.addEventListener('resize', function() {
                canvas.width = window.innerWidth;
                canvas.height = window.innerHeight;
            });
        }
    </script>
</body>
</html>
