<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>三月空间控制台 | NEXUS CONSOLE</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.1/css/all.min.css">
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Orbitron:wght@400;700;900&family=Rajdhani:wght@500;700&family=Noto+Sans+SC:wght@300;400;500;700&display=swap');

        :root {
            --primary: #00f3ff;
            --secondary: #bc13fe;
            --gold: #ffd700;
            --bg: #050505;
            --glass: rgba(16, 16, 20, 0.85);
            --glass-border: rgba(255, 255, 255, 0.1);
            --sidebar-width: 260px;
        }

        * { margin: 0; padding: 0; box-sizing: border-box; }
        
        body {
            background-color: var(--bg);
            color: #e0e0e0;
            font-family: 'Noto Sans SC', sans-serif;
            overflow-x: hidden;
            min-height: 100vh;
            display: flex;
            flex-direction: column;
        }

        body.modal-open { overflow: hidden; padding-right: 17px; }

        /* === 背景特效 === */
        .scanline-moving {
            position: fixed; top: 0; left: 0; width: 100%; height: 100%;
            background: linear-gradient(to bottom, transparent 50%, rgba(0, 243, 255, 0.02) 51%, transparent 51%);
            background-size: 100% 4px;
            animation: scan-move 10s linear infinite;
            pointer-events: none; z-index: 0;
        }
        .scan-beam {
            position: fixed; top: -10%; left: 0; width: 100%; height: 20px;
            background: rgba(0, 243, 255, 0.15);
            box-shadow: 0 0 10px rgba(0, 243, 255, 0.2);
            filter: blur(5px);
            animation: beam-drop 8s linear infinite;
            pointer-events: none; z-index: 0;
        }

        .cyber-grid {
            position: fixed; bottom: -20%; left: -50%; width: 200%; height: 60%;
            background: 
                linear-gradient(transparent 0%, rgba(0, 243, 255, 0.1) 1px, transparent 2px),
                linear-gradient(90deg, transparent 0%, rgba(0, 243, 255, 0.1) 1px, transparent 2px);
            background-size: 60px 60px;
            transform: perspective(500px) rotateX(60deg);
            animation: grid-move 20s linear infinite;
            z-index: -2;
            mask-image: linear-gradient(to bottom, transparent, black 40%);
            -webkit-mask-image: linear-gradient(to bottom, transparent, black 40%);
        }

        @keyframes scan-move { 0% { background-position: 0 0; } 100% { background-position: 0 100%; } }
        @keyframes beam-drop { 0% { top: -10%; opacity: 0; } 20% { opacity: 1; } 100% { top: 110%; opacity: 0; } }
        @keyframes grid-move { 0% { background-position: 0 0; } 100% { background-position: 0 60px; } }

        #canvas { position: fixed; top: 0; left: 0; width: 100%; height: 100%; z-index: -1; }
        .scanlines {
            position: fixed; top: 0; left: 0; width: 100%; height: 100%;
            background: linear-gradient(to bottom, rgba(255,255,255,0), rgba(255,255,255,0) 50%, rgba(0,0,0,0.1) 50%, rgba(0,0,0,0.1));
            background-size: 100% 4px; pointer-events: none; z-index: 0; opacity: 0.6;
        }

        /* === 左右侧边栏 === */
        .sidebar {
            position: fixed; top: 0; bottom: 0; width: var(--sidebar-width);
            background: rgba(5, 5, 5, 0.6); backdrop-filter: blur(15px);
            border-left: 1px solid var(--glass-border); border-right: 1px solid var(--glass-border);
            z-index: 100; padding: 30px 20px; display: flex; flex-direction: column; gap: 15px;
            transition: transform 0.3s ease;
        }
        .sidebar-left { left: 0; border-right: 1px solid var(--glass-border); border-left: none; }
        .sidebar-right { right: 0; border-left: 1px solid var(--glass-border); border-right: none; }
        
        .sidebar-title {
            font-family: 'Orbitron'; color: var(--primary); font-size: 1.1em;
            margin-bottom: 10px; text-transform: uppercase; letter-spacing: 2px;
            border-bottom: 2px solid var(--primary); padding-bottom: 10px;
        }

        .tool-item {
            display: flex; align-items: center; gap: 12px; padding: 12px 15px;
            background: rgba(255,255,255,0.03); border: 1px solid transparent; border-radius: 8px;
            color: #aaa; text-decoration: none; transition: 0.3s;
            font-family: 'Rajdhani', sans-serif; font-weight: 600; font-size: 1.05em; cursor: pointer;
        }
        .tool-item:hover {
            background: rgba(0, 243, 255, 0.1); border-color: var(--primary);
            color: #fff; transform: translateX(5px);
        }
        .tool-item i { width: 20px; text-align: center; color: var(--primary); }

        .tool-item.warning-item {
            color: var(--gold);
            border: 1px solid rgba(255, 215, 0, 0.3);
            background: rgba(255, 215, 0, 0.05);
        }
        .tool-item.warning-item:hover {
            background: rgba(255, 215, 0, 0.15);
            border-color: var(--gold);
            color: var(--gold);
        }
        .tool-item.warning-item i {
            color: var(--gold);
        }

        /* === 主内容区域 === */
        .main-content {
            margin: 0 var(--sidebar-width); padding: 40px;
            display: flex; flex-direction: column; align-items: center;
            min-height: 100vh; z-index: 10;
        }

        header { text-align: center; margin-bottom: 40px; position: relative; width: 100%; max-width: 800px; }
        
        .logo-text {
            font-family: 'Orbitron', sans-serif; font-size: 3.5rem; font-weight: 900;
            background: linear-gradient(to right, #fff, #aaa); -webkit-background-clip: text; color: transparent;
            text-shadow: 0 0 30px rgba(255,255,255,0.3); margin-bottom: 5px;
        }
        .sub-logo {
            color: var(--primary); font-family: 'Rajdhani'; letter-spacing: 5px;
            font-size: 1.2rem; text-shadow: 0 0 10px var(--primary);
        }

        /* 音乐播放器 */
        .music-player-bar {
            background: rgba(0, 0, 0, 0.6); border: 1px solid var(--secondary);
            border-radius: 50px; padding: 8px 30px; display: flex; align-items: center; gap: 20px;
            margin: 25px auto 0; box-shadow: 0 0 20px rgba(188, 19, 254, 0.2);
            backdrop-filter: blur(10px); width: fit-content;
        }
        .music-visualizer { display: flex; gap: 3px; align-items: flex-end; height: 15px; }
        .bar { width: 3px; background: var(--secondary); animation: bounce 1s infinite ease-in-out; }
        .bar:nth-child(1) { animation-duration: 0.8s; height: 8px; }
        .bar:nth-child(2) { animation-duration: 1.2s; height: 12px; }
        .bar:nth-child(3) { animation-duration: 0.5s; height: 6px; }
        .bar:nth-child(4) { animation-duration: 1.0s; height: 14px; }
        .music-paused .bar { animation: none; height: 2px; }
        @keyframes bounce { 0%, 100% { height: 4px; } 50% { height: 15px; } }

        .player-controls button {
            background: none; border: none; color: white; font-size: 1rem;
            cursor: pointer; margin: 0 5px; transition: 0.3s;
        }
        .player-controls button:hover { color: var(--secondary); transform: scale(1.2); }
        .track-info { font-family: 'Rajdhani'; color: var(--secondary); font-weight: bold; min-width: 120px; text-align: center; font-size: 0.9em;}

        /* === 布局矩阵 === */
        .hero-grid {
            display: grid; grid-template-columns: repeat(4, 1fr); gap: 20px;
            width: 100%; max-width: 1200px; margin-bottom: 25px;
        }
        .resource-grid {
            display: grid; grid-template-columns: repeat(4, 1fr); gap: 20px;
            width: 100%; max-width: 1200px;
        }

        .holo-card {
            background: var(--glass); border: 1px solid var(--glass-border);
            border-radius: 12px; padding: 25px; position: relative; overflow: hidden;
            transition: all 0.4s cubic-bezier(0.175, 0.885, 0.32, 1.275);
            cursor: pointer; display: flex; flex-direction: column; justify-content: center;
        }

        .hero-card { min-height: 160px; align-items: flex-start; text-align: left; }
        .hero-card h2 { font-size: 1.1rem; color: #fff; margin: 10px 0 8px; font-family: 'Orbitron'; }
        .hero-card p { color: #aaa; font-size: 0.8rem; line-height: 1.5; }
        .hero-card i.main-icon { font-size: 1.8rem; color: var(--primary); }
        .hero-card .bg-icon {
            position: absolute; right: -15px; bottom: -15px; font-size: 5rem;
            opacity: 0.05; transform: rotate(-15deg); transition: 0.4s;
        }
        .hero-card:hover { transform: translateY(-5px); border-color: var(--primary); box-shadow: 0 10px 40px rgba(0, 243, 255, 0.15); }
        .hero-card:hover .bg-icon { opacity: 0.1; transform: rotate(0) scale(1.1); }

        .mini-card { text-align: center; align-items: center; padding: 25px 15px; }
        .mini-card i { font-size: 2rem; margin-bottom: 15px; color: #ccc; transition: 0.3s; }
        .mini-card h3 { font-size: 1.1rem; color: #eee; font-family: 'Rajdhani'; }
        .mini-card:hover { border-color: var(--secondary); background: rgba(188, 19, 254, 0.05); }
        .mini-card:hover i { color: var(--secondary); transform: scale(1.2); }

        .tag {
            position: absolute; top: 15px; right: 15px; padding: 4px 10px;
            border-radius: 4px; font-size: 0.7rem; font-weight: bold; font-family: 'Orbitron';
        }
        .tag-hot { background: rgba(255, 0, 100, 0.2); color: #ff0064; border: 1px solid #ff0064; }
        .tag-new { background: rgba(0, 243, 255, 0.2); color: var(--primary); border: 1px solid var(--primary); }
        .tag-vip { 
            background: linear-gradient(135deg, rgba(255, 215, 0, 0.3), rgba(255, 140, 0, 0.3)); 
            color: #ffd700; 
            border: 1px solid #ffd700;
            animation: vip-glow 2s ease-in-out infinite;
        }
        @keyframes vip-glow {
            0%, 100% { box-shadow: 0 0 5px rgba(255, 215, 0, 0.3); }
            50% { box-shadow: 0 0 15px rgba(255, 215, 0, 0.6); }
        }
        .vip-card {
            border-color: rgba(255, 215, 0, 0.3) !important;
        }
        .vip-card:hover {
            border-color: var(--gold) !important;
            box-shadow: 0 0 30px rgba(255, 215, 0, 0.3) !important;
        }
        
        /* 系统警告条 */
        .system-warning-bar {
            width: 100%; max-width: 1200px;
            background: linear-gradient(90deg, rgba(188, 19, 254, 0.1), rgba(0, 0, 0, 0.6), rgba(188, 19, 254, 0.1));
            border: 1px solid rgba(255, 215, 0, 0.3);
            color: #ddd;
            padding: 12px 20px;
            margin-bottom: 25px;
            border-radius: 8px;
            display: flex; align-items: center; justify-content: center; gap: 12px;
            cursor: pointer;
            transition: 0.3s;
            font-size: 0.95rem;
            backdrop-filter: blur(5px);
            animation: pulse-border 3s infinite;
        }
        .system-warning-bar:hover {
            background: rgba(255, 215, 0, 0.1);
            border-color: var(--gold);
            transform: scale(1.01);
            box-shadow: 0 0 20px rgba(255, 215, 0, 0.15);
        }
        .system-warning-bar i { color: var(--gold); font-size: 1.1em; }
        .highlight-text { color: var(--gold); font-weight: bold; text-decoration: underline; margin-left: 5px; }

        @keyframes pulse-border {
            0% { border-color: rgba(255, 215, 0, 0.3); }
            50% { border-color: rgba(255, 215, 0, 0.7); box-shadow: 0 0 10px rgba(255, 215, 0, 0.2); }
            100% { border-color: rgba(255, 215, 0, 0.3); }
        }

        /* === 弹窗样式 === */
        .modal-overlay {
            position: fixed; inset: 0; background: rgba(0,0,0,0.9); z-index: 2000;
            display: flex; justify-content: center; align-items: center;
            opacity: 0; 
            visibility: hidden; 
            pointer-events: none;
            transition: opacity 0.3s ease, visibility 0.3s ease;
            overflow-y: auto;
            padding: 20px 0;
        }

        .modal-overlay.visible { 
            opacity: 1; 
            visibility: visible; 
            pointer-events: auto;
        }

        .modal-content {
            background: #0f0f13; border: 1px solid var(--primary);
            box-shadow: 0 0 50px rgba(0, 243, 255, 0.15); border-radius: 16px;
            padding: 40px; width: 90%; max-width: 1000px; max-height: 85vh;
            overflow-y: auto; position: relative;
            transform: scale(0.95); transition: transform 0.3s ease;
        }
        .modal-overlay.visible .modal-content { transform: scale(1); }

        .modal-close { position: absolute; top: 20px; right: 25px; font-size: 28px; cursor: pointer; color: #666; transition:0.3s;}
        .modal-close:hover { color: #fff; transform: rotate(90deg); }
        
        .modal-section-title {
            color: var(--primary); font-size: 1.2em; border-left: 4px solid var(--secondary);
            padding-left: 15px; margin: 30px 0 15px; font-weight: bold; text-transform: uppercase;
        }

        .modal-network-tip {
            background: rgba(255, 215, 0, 0.1);
            border: 1px solid rgba(255, 215, 0, 0.3);
            border-radius: 8px;
            padding: 12px 15px;
            margin-bottom: 20px;
            display: flex;
            align-items: center;
            gap: 10px;
            font-size: 0.9em;
            color: #ccc;
        }
        .modal-network-tip i {
            color: var(--gold);
            font-size: 1.1em;
        }
        .modal-network-tip a {
            color: var(--primary);
            text-decoration: none;
            font-weight: 600;
        }
        .modal-network-tip a:hover {
            text-decoration: underline;
        }
        
        /* 核心业务金边标题 */
        .modal-section-title.gold-title {
            color: var(--gold); border-color: var(--gold);
            text-shadow: 0 0 10px rgba(255, 215, 0, 0.2);
        }

        .modal-grid { 
            display: grid; 
            grid-template-columns: repeat(auto-fill, minmax(240px, 1fr)); 
            gap: 15px; 
            margin-bottom: 25px;
        }
        
        .link-card {
            background: rgba(255,255,255,0.04); padding: 15px; border-radius: 10px;
            text-align: left; text-decoration: none; color: #ccc; border: 1px solid transparent;
            transition: 0.3s; display: flex; align-items: center; gap: 15px;
            min-height: 80px; /* 保证高度一致 */
        }
        .link-card:hover { background: rgba(0, 243, 255, 0.1); color: #fff; border-color: var(--primary); transform: translateX(5px); }
        .link-card i, .link-card img { width: 30px; height: 30px; object-fit: contain; text-align: center; font-size: 24px; color: var(--primary); flex-shrink: 0; }
        .link-card h3 { font-size: 1rem; margin: 0 0 4px 0; font-weight: 500; font-family: 'Rajdhani'; }
        .link-card p { font-size: 0.8rem; color: #777; margin: 0; line-height: 1.3; }
        
        .card-highlight { border: 1px solid var(--secondary); background: rgba(188, 19, 254, 0.05); }

        /* 核心业务金卡样式 */
        .link-card.gold-card {
            background: linear-gradient(145deg, rgba(255, 215, 0, 0.1), rgba(0, 0, 0, 0.6));
            border: 1px solid rgba(255, 215, 0, 0.5);
            box-shadow: 0 0 15px rgba(255, 215, 0, 0.1);
        }
        .link-card.gold-card:hover {
            transform: translateY(-3px);
            box-shadow: 0 0 25px rgba(255, 215, 0, 0.25);
            border-color: #ffd700;
        }
        .link-card.gold-card h3 { color: #ffd700; font-weight: bold; }
        .link-card.gold-card i { color: #ffd700; text-shadow: 0 0 10px rgba(255, 215, 0, 0.5); }
        .link-card.gold-card p { color: #e0e0e0; }

        /* VPS 分隔区 */
        .vps-divider {
            border-top: 1px dashed #333; margin: 30px 0 20px;
            position: relative; text-align: center;
        }
        .vps-divider span {
            background: #0f0f13; padding: 0 15px; position: relative; top: -12px;
            color: #666; font-family: 'Orbitron'; font-size: 0.9em;
        }

        /* 响应式 */
        @media (max-width: 1200px) {
            .sidebar { width: 70px; padding: 20px 5px; }
            .sidebar .tool-item { justify-content: center; } 
            .sidebar .tool-item span { display: none; }
            .sidebar-title { display: none; }
            .main-content { margin: 0 70px; }
        }
        @media (max-width: 768px) {
            .sidebar { display: none; }
            .main-content { margin: 0; padding: 20px; }
            .hero-grid { grid-template-columns: 1fr; }
            .resource-grid { grid-template-columns: 1fr 1fr; }
            .logo-text { font-size: 2.2rem; }
            .modal-content { padding: 25px 15px; }
            .system-warning-bar { font-size: 0.85rem; padding: 10px; text-align: left; }
            
            /* 移动端强制单列，防止挤压 */
            .modal-grid { grid-template-columns: 1fr; }
        }

        /* AI 视频模态框 */
        .ai-header { text-align: center; margin-bottom: 35px; }
        .ai-header h2 { font-family: 'Orbitron'; color: #fff; font-size: 2.2em; text-shadow: 0 0 20px rgba(188, 19, 254, 0.6); margin-bottom: 10px; }
        .ai-header p { color: #888; font-size: 0.95em; letter-spacing: 1px; }

        .pricing-container { display: flex; justify-content: center; gap: 25px; flex-wrap: wrap; margin-bottom: 30px; }
        .pricing-card {
            flex: 1; min-width: 260px; max-width: 320px; background: rgba(255, 255, 255, 0.03);
            border-radius: 16px; padding: 30px 20px; position: relative; overflow: hidden;
            transition: all 0.3s ease; display: flex; flex-direction: column; align-items: center;
            border: 1px solid rgba(255,255,255,0.1);
        }
        .pricing-card.premium {
            background: linear-gradient(160deg, rgba(188, 19, 254, 0.1), rgba(0,0,0,0.4));
            border: 1px solid rgba(188, 19, 254, 0.5); box-shadow: 0 0 30px rgba(188, 19, 254, 0.15);
        }
        .pricing-card.premium::before {
            content: 'RECOMMENDED'; position: absolute; top: 12px; right: -30px;
            background: var(--secondary); color: #fff; font-size: 0.7em; font-weight: bold;
            padding: 5px 30px; transform: rotate(45deg); box-shadow: 0 2px 10px rgba(0,0,0,0.5);
        }
        .pricing-card.premium:hover { transform: translateY(-5px); box-shadow: 0 10px 40px rgba(188, 19, 254, 0.3); border-color: #e066ff; }
        .pricing-card.basic { border: 1px solid rgba(255,255,255,0.1); }
        .pricing-card.basic:hover { background: rgba(255,255,255,0.06); border-color: #666; }
        .price-tag { margin: 20px 0; text-align: center; }
        .price-currency { font-size: 1.2em; vertical-align: top; color: #888; }
        .price-num { font-family: 'Orbitron'; font-size: 3em; font-weight: bold; color: #fff; }
        .premium .price-num { background: linear-gradient(to bottom, #fff, var(--secondary)); -webkit-background-clip: text; color: transparent; text-shadow: 0 0 20px rgba(188, 19, 254, 0.5); }
        .feature-list { list-style: none; width: 100%; padding: 0 10px; margin-top: 10px; }
        .feature-list li {
            display: flex; align-items: center; gap: 10px; color: #ccc; font-size: 0.9em; margin-bottom: 12px;
            border-bottom: 1px solid rgba(255,255,255,0.05); padding-bottom: 8px;
        }
        .feature-list li:last-child { border-bottom: none; }
        .feature-list i { font-size: 1em; width: 20px; text-align: center; }
        .check-icon { color: #00ff88; text-shadow: 0 0 5px #00ff88; }
        .cross-icon { color: #ff3366; opacity: 0.7; }
        .demo-banner {
            display: flex; align-items: center; gap: 20px;
            background: linear-gradient(90deg, rgba(188, 19, 254, 0.1), rgba(0, 243, 255, 0.05));
            border: 1px solid var(--secondary); border-radius: 12px; padding: 20px 30px; text-decoration: none;
            transition: 0.3s; position: relative; overflow: hidden; margin-top: 10px;
        }
        .demo-banner:hover {
            background: linear-gradient(90deg, rgba(188, 19, 254, 0.2), rgba(0, 243, 255, 0.1));
            border-color: #fff; transform: scale(1.02); box-shadow: 0 0 25px rgba(188, 19, 254, 0.4);
        }
        .play-btn-circle {
            width: 50px; height: 50px; background: var(--secondary); border-radius: 50%;
            display: flex; align-items: center; justify-content: center;
            box-shadow: 0 0 15px var(--secondary); color: #fff; font-size: 1.2em;
            animation: pulse 2s infinite; flex-shrink: 0;
        }
        .demo-info h3 { color: #fff; font-size: 1.1em; margin-bottom: 5px; font-family: 'Orbitron'; }
        .demo-info p { color: #bbb; font-size: 0.85em; }
        .demo-arrow { margin-left: auto; color: var(--secondary); font-size: 1.2em; transition:0.3s;}
        .demo-banner:hover .demo-arrow { transform: translateX(5px); color: #fff; }


        /* === 针对文字变长后的优化样式 === */

/* 1. 让弹窗变宽 */
.modal-content {
    /* 增加宽度到 1280px，让横向能容纳更多内容 */
    max-width: 1280px; 
    width: 95%; /* 移动端保持95% */
}

/* 2. 让卡片变宽，适应长文字 */
.modal-grid {
    display: grid;
    /* minmax改到320px，保证卡片足够宽，文字不至于挤成一团 */
    grid-template-columns: repeat(auto-fill, minmax(320px, 1fr)); 
    gap: 20px;
    margin-bottom: 25px;
}

/* 3. 卡片内部排版微调 */
.link-card {
    display: flex;
    align-items: center; /* 垂直居中 */
    gap: 18px; /* 图标和文字的间距 */
    padding: 20px; /* 增加内边距 */
    min-height: 100px; /* 保证最小高度，视觉更整齐 */
}

/* 图标固定宽度，防止被文字挤压 */
.link-card i, .link-card img {
    flex-shrink: 0; 
    width: 40px; 
    font-size: 28px;
}

/* 文字区域 */
.link-card div {
    flex: 1; /* 占满剩余空间 */
    min-width: 0; /* 防止文字溢出容器 */
}

/* 标题 */
.link-card h3 {
    font-size: 1.05rem;
    margin: 0 0 6px 0; /* 标题和描述之间增加间距 */
    font-weight: 500; 
    font-family: 'Rajdhani';
    /* white-space: nowrap; /* 标题尽量不换行 - 这个可能会导致长标题溢出 */
    /* overflow: hidden; */
    /* text-overflow: ellipsis; */
}

/* 描述文字 (您加字的地方) */
.link-card p {
    font-size: 0.85rem;
    color: #888;
    line-height: 1.5; /* 增加行间距，多行文字更好看 */
    opacity: 0.8;
}

/* 手机端适配：一行一个 */
@media (max-width: 768px) {
    .modal-grid { grid-template-columns: 1fr; }
    .modal-content { padding: 20px; }
}


/* === 优化后的卡片文字样式 === */

/* 1. 描述文字整体加亮 */
.link-card p {
    font-size: 0.85rem;
    color: #ccc; /* 从 #888 改为 #ccc，更亮更清晰 */
    line-height: 1.6; /* 增加行高，让长文字阅读更舒服 */
    margin: 4px 0 0 0;
    font-weight: 400; /*稍微加粗一点点*/
}

/* 2. 优惠码专属样式 (金色背景块) */
.code-badge {
    background: rgba(255, 215, 0, 0.15);
    color: #ffd700;
    border: 1px solid rgba(255, 215, 0, 0.3);
    padding: 2px 6px;
    border-radius: 4px;
    font-weight: bold;
    font-family: 'Rajdhani';
    margin-left: 5px;
    display: inline-block; /* 防止断行太难看 */
    white-space: nowrap; /* 防止内部文字换行 */
}

/* 3. 重点提示高亮 (如：SSR中转) */
.text-highlight {
    color: var(--primary);
    font-weight: bold;
}

/* === 登录/注册系统样式 === */
.auth-header-btn {
    position: fixed;
    top: 20px;
    right: calc(var(--sidebar-width) + 20px);
    z-index: 150;
    display: flex;
    gap: 10px;
    align-items: center;
}

.auth-btn {
    padding: 10px 20px;
    border-radius: 8px;
    font-family: 'Rajdhani', sans-serif;
    font-weight: 600;
    font-size: 0.95em;
    cursor: pointer;
    transition: all 0.3s ease;
    text-decoration: none;
    display: inline-flex;
    align-items: center;
    gap: 8px;
}

.auth-btn-outline {
    background: transparent;
    border: 1px solid var(--primary);
    color: var(--primary);
}

.auth-btn-outline:hover {
    background: rgba(0, 243, 255, 0.1);
    box-shadow: 0 0 15px rgba(0, 243, 255, 0.3);
}

.auth-btn-filled {
    background: linear-gradient(135deg, var(--primary), #00a8b5);
    border: none;
    color: #000;
}

.auth-btn-filled:hover {
    box-shadow: 0 0 20px rgba(0, 243, 255, 0.5);
    transform: translateY(-2px);
}

/* 用户信息显示 */
.user-info {
    display: flex;
    align-items: center;
    gap: 12px;
    padding: 8px 15px;
    background: rgba(0, 243, 255, 0.1);
    border: 1px solid var(--primary);
    border-radius: 8px;
}

.user-avatar {
    width: 36px;
    height: 36px;
    border-radius: 50%;
    background: linear-gradient(135deg, var(--primary), var(--secondary));
    display: flex;
    align-items: center;
    justify-content: center;
    font-family: 'Orbitron';
    font-weight: bold;
    color: #000;
    font-size: 1rem;
    overflow: hidden;
}

.user-avatar img {
    width: 100%;
    height: 100%;
    object-fit: cover;
}

.user-name {
    color: #fff;
    font-family: 'Rajdhani';
    font-weight: 600;
}

.logout-btn {
    background: transparent;
    border: 1px solid #ff4757;
    color: #ff4757;
    padding: 6px 12px;
    border-radius: 6px;
    cursor: pointer;
    font-size: 0.85em;
    transition: all 0.3s;
}

.logout-btn:hover {
    background: rgba(255, 71, 87, 0.2);
}

/* 登录/注册弹窗 */
.auth-modal-content {
    background: linear-gradient(145deg, #0f0f13, #1a1a22);
    border: 1px solid var(--primary);
    box-shadow: 0 0 60px rgba(0, 243, 255, 0.2);
    border-radius: 20px;
    padding: 50px 40px;
    width: 90%;
    max-width: 450px;
    max-height: 85vh;
    overflow-y: auto;
    position: relative;
}

.auth-modal-content::before {
    content: '';
    position: absolute;
    top: 0;
    left: 0;
    right: 0;
    height: 3px;
    background: linear-gradient(90deg, var(--primary), var(--secondary), var(--primary));
    background-size: 200% 100%;
    animation: gradientMove 3s linear infinite;
}

@keyframes gradientMove {
    0% { background-position: 0% 50%; }
    100% { background-position: 200% 50%; }
}

.auth-title {
    text-align: center;
    margin-bottom: 30px;
}

.auth-title h2 {
    font-family: 'Orbitron';
    font-size: 1.8em;
    color: #fff;
    margin-bottom: 8px;
    text-shadow: 0 0 20px rgba(0, 243, 255, 0.3);
}

.auth-title p {
    color: #888;
    font-size: 0.9em;
}

.auth-form {
    display: flex;
    flex-direction: column;
    gap: 20px;
}

.form-group {
    position: relative;
}

.form-group label {
    display: block;
    color: var(--primary);
    font-family: 'Rajdhani';
    font-weight: 600;
    margin-bottom: 8px;
    font-size: 0.95em;
}

.form-group input {
    width: 100%;
    padding: 14px 18px;
    padding-right: 45px;
    background: rgba(255, 255, 255, 0.05);
    border: 1px solid rgba(255, 255, 255, 0.1);
    border-radius: 10px;
    color: #fff;
    font-size: 1em;
    transition: all 0.3s ease;
    outline: none;
}

.form-group input:focus {
    border-color: var(--primary);
    box-shadow: 0 0 15px rgba(0, 243, 255, 0.2);
    background: rgba(0, 243, 255, 0.05);
}

.form-group input::placeholder {
    color: #666;
}

/* 密码可见性切换 */
.password-toggle {
    position: absolute;
    right: 15px;
    top: 42px;
    color: #666;
    cursor: pointer;
    transition: 0.3s;
    z-index: 10;
}

.password-toggle:hover {
    color: var(--primary);
}

.submit-btn {
    width: 100%;
    padding: 15px;
    background: linear-gradient(135deg, var(--primary), #00a8b5);
    border: none;
    border-radius: 10px;
    color: #000;
    font-family: 'Orbitron';
    font-size: 1em;
    font-weight: bold;
    cursor: pointer;
    transition: all 0.3s ease;
    margin-top: 10px;
    position: relative;
    overflow: hidden;
}

.submit-btn:hover {
    box-shadow: 0 0 30px rgba(0, 243, 255, 0.5);
    transform: translateY(-2px);
}

.submit-btn:disabled {
    background: #333;
    color: #666;
    cursor: not-allowed;
    transform: none;
    box-shadow: none;
}

.submit-btn .btn-loader {
    display: none;
    width: 20px;
    height: 20px;
    border: 2px solid #000;
    border-top-color: transparent;
    border-radius: 50%;
    animation: spin 0.8s linear infinite;
    margin: 0 auto;
}

.submit-btn.loading .btn-text {
    display: none;
}

.submit-btn.loading .btn-loader {
    display: inline-block;
}

@keyframes spin {
    to { transform: rotate(360deg); }
}

.auth-switch {
    text-align: center;
    margin-top: 25px;
    color: #888;
    font-size: 0.95em;
}

.auth-switch a {
    color: var(--primary);
    text-decoration: none;
    font-weight: 600;
    transition: 0.3s;
}

.auth-switch a:hover {
    text-shadow: 0 0 10px var(--primary);
}

/* 消息提示 */
.message-toast {
    position: fixed;
    top: 30px;
    left: 50%;
    transform: translateX(-50%) translateY(-100px);
    padding: 15px 30px;
    border-radius: 10px;
    font-family: 'Rajdhani';
    font-weight: 600;
    z-index: 9999;
    transition: transform 0.4s cubic-bezier(0.68, -0.55, 0.265, 1.55);
    display: flex;
    align-items: center;
    gap: 10px;
    min-width: 300px;
    justify-content: center;
}

.message-toast.show {
    transform: translateX(-50%) translateY(0);
}

.message-toast.success {
    background: linear-gradient(135deg, rgba(0, 255, 136, 0.9), rgba(0, 200, 100, 0.9));
    color: #000;
    box-shadow: 0 5px 30px rgba(0, 255, 136, 0.4);
}

.message-toast.error {
    background: linear-gradient(135deg, rgba(255, 71, 87, 0.9), rgba(200, 50, 60, 0.9));
    color: #fff;
    box-shadow: 0 5px 30px rgba(255, 71, 87, 0.4);
}

.message-toast.warning {
    background: linear-gradient(135deg, rgba(255, 215, 0, 0.9), rgba(200, 160, 0, 0.9));
    color: #000;
    box-shadow: 0 5px 30px rgba(255, 215, 0, 0.4);
}

.message-toast.info {
    background: linear-gradient(135deg, rgba(0, 243, 255, 0.9), rgba(0, 150, 200, 0.9));
    color: #000;
    box-shadow: 0 5px 30px rgba(0, 243, 255, 0.4);
}

/* 表单验证样式 */
.form-group.error input {
    border-color: #ff4757;
    background: rgba(255, 71, 87, 0.1);
}

.form-group .error-text {
    color: #ff4757;
    font-size: 0.8em;
    margin-top: 5px;
    display: none;
}

.form-group.error .error-text {
    display: block;
}

/* 密码强度指示器 */
.password-strength {
    display: flex;
    gap: 5px;
    margin-top: 8px;
}

.strength-bar {
    flex: 1;
    height: 4px;
    background: rgba(255, 255, 255, 0.1);
    border-radius: 2px;
    transition: all 0.3s;
}

.strength-bar.weak { background: #ff4757; }
.strength-bar.medium { background: #ffd700; }
.strength-bar.strong { background: #00ff88; }

.strength-text {
    font-size: 0.75em;
    margin-top: 5px;
    color: #888;
}

/* 响应式 */
@media (max-width: 1200px) {
    .auth-header-btn {
        right: 90px;
    }
}

/* 头像选择器样式 */
.avatar-selector {
    display: flex;
    flex-wrap: wrap;
    gap: 10px;
    padding: 10px 0;
}

.avatar-option {
    width: 40px;
    height: 40px;
    border-radius: 50%;
    background: rgba(255, 255, 255, 0.05);
    border: 2px solid rgba(255, 255, 255, 0.1);
    display: flex;
    align-items: center;
    justify-content: center;
    font-size: 1.3em;
    cursor: pointer;
    transition: all 0.3s ease;
}

.avatar-option:hover {
    border-color: var(--primary);
    transform: scale(1.1);
}

.avatar-option.selected {
    border-color: var(--primary);
    background: rgba(0, 243, 255, 0.2);
    box-shadow: 0 0 15px rgba(0, 243, 255, 0.3);
}

/* 头像上传区域 */
.avatar-upload-section {
    display: flex;
    flex-direction: column;
    align-items: center;
    padding: 20px 0;
    border-bottom: 1px solid rgba(255,255,255,0.1);
    margin-bottom: 15px;
}

.avatar-preview-container {
    position: relative;
    width: 100px;
    height: 100px;
}

.avatar-preview {
    width: 100px;
    height: 100px;
    border-radius: 50%;
    background: rgba(255, 255, 255, 0.1);
    border: 3px solid var(--primary);
    display: flex;
    align-items: center;
    justify-content: center;
    font-size: 3em;
    overflow: hidden;
    box-shadow: 0 0 20px rgba(0, 243, 255, 0.3);
}

.avatar-preview img {
    width: 100%;
    height: 100%;
    object-fit: cover;
}

.avatar-upload-btn {
    position: absolute;
    bottom: 0;
    right: 0;
    width: 32px;
    height: 32px;
    border-radius: 50%;
    background: var(--secondary);
    color: #fff;
    display: flex;
    align-items: center;
    justify-content: center;
    cursor: pointer;
    transition: all 0.3s;
    border: 2px solid #1a1a2e;
}

.avatar-upload-btn:hover {
    background: #d946ef;
    transform: scale(1.1);
}

.avatar-upload-hint {
    margin-top: 10px;
    font-size: 0.8em;
    color: #888;
}

.avatar-emoji-section {
    padding-top: 10px;
}

.avatar-emoji-label {
    font-size: 0.85em;
    color: #888;
    margin-bottom: 8px;
}

@media (max-width: 768px) {
    .auth-header-btn {
        right: 20px;
        top: 15px;
    }
    
    .auth-btn {
        padding: 8px 12px;
        font-size: 0.85em;
    }
    
    .auth-modal-content {
        padding: 30px 20px;
        margin: 10px;
        max-height: 90vh;
        overflow-y: auto;
    }
    
    .user-info {
        padding: 6px 10px;
    }
    
    .user-name {
        display: none;
    }
}

/* ================= 通讯终端样式 ================= */
.comm-terminal {
    margin: 30px 0 40px 0;
    padding: 0;
    width: 100%;
    max-width: 1200px;
}

.comm-container {
    display: flex;
    background: rgba(10, 10, 15, 0.9);
    border: 1px solid rgba(0, 243, 255, 0.3);
    border-radius: 15px;
    overflow: hidden;
    box-shadow: 0 0 30px rgba(0, 243, 255, 0.1);
    min-height: 450px;
}

/* 左侧频道栏 */
.comm-sidebar {
    width: 180px;
    background: rgba(0, 0, 0, 0.5);
    border-right: 1px solid rgba(0, 243, 255, 0.2);
    padding: 20px 10px;
    display: flex;
    flex-direction: column;
    gap: 10px;
}

.comm-channel {
    display: flex;
    align-items: center;
    gap: 10px;
    padding: 15px;
    border-radius: 10px;
    cursor: pointer;
    transition: all 0.3s;
    color: #888;
    position: relative;
}

.comm-channel i {
    font-size: 1.1em;
    width: 20px;
    text-align: center;
}

.comm-channel span {
    font-size: 0.95em;
    white-space: nowrap;
}

.comm-channel:hover {
    background: rgba(0, 243, 255, 0.1);
    color: var(--primary);
}

.comm-channel.active {
    background: linear-gradient(135deg, rgba(0, 243, 255, 0.2), rgba(188, 19, 254, 0.1));
    color: var(--primary);
    border: 1px solid rgba(0, 243, 255, 0.3);
}

.channel-badge {
    position: absolute;
    right: 10px;
    background: #ff4757;
    color: #fff;
    font-size: 0.75em;
    padding: 2px 6px;
    border-radius: 10px;
    animation: pulse 1.5s infinite;
}

@keyframes pulse {
    0%, 100% { opacity: 1; }
    50% { opacity: 0.6; }
}

/* 右侧内容区 */
.comm-main {
    flex: 1;
    display: flex;
    flex-direction: column;
    padding: 20px;
}

/* 顶部状态栏 */
.comm-header {
    display: flex;
    justify-content: space-between;
    align-items: center;
    padding-bottom: 15px;
    border-bottom: 1px solid rgba(0, 243, 255, 0.2);
    margin-bottom: 15px;
}

.comm-title {
    display: flex;
    align-items: center;
    gap: 10px;
    font-family: 'Orbitron', sans-serif;
    color: var(--primary);
    font-size: 1.1em;
}

.comm-status {
    display: flex;
    align-items: center;
    gap: 8px;
    font-size: 0.85em;
    color: #888;
}

.status-dot {
    width: 8px;
    height: 8px;
    background: #00ff88;
    border-radius: 50%;
    box-shadow: 0 0 10px #00ff88;
    animation: pulse 2s infinite;
}

.status-divider {
    color: #444;
}

/* 频道说明 */
.comm-description {
    background: rgba(0, 243, 255, 0.05);
    border: 1px solid rgba(0, 243, 255, 0.15);
    border-radius: 8px;
    padding: 12px 15px;
    font-size: 0.9em;
    color: #aaa;
    margin-bottom: 20px;
}

.comm-description i {
    color: var(--primary);
    margin-right: 8px;
}

/* 发布区域 */
.comm-input-area {
    margin-bottom: 20px;
}

.input-wrapper {
    background: rgba(0, 0, 0, 0.3);
    border: 1px solid rgba(255, 255, 255, 0.1);
    border-radius: 10px;
    overflow: hidden;
    transition: border-color 0.3s;
}

.input-wrapper:focus-within {
    border-color: var(--primary);
}

.input-wrapper textarea {
    width: 100%;
    background: transparent;
    border: none;
    padding: 15px;
    color: #e0e0e0;
    font-size: 1em;
    resize: none;
    font-family: inherit;
}

.input-wrapper textarea:focus {
    outline: none;
}

.input-wrapper textarea::placeholder {
    color: #555;
}

.input-footer {
    display: flex;
    justify-content: space-between;
    align-items: center;
    padding: 10px 15px;
    background: rgba(0, 0, 0, 0.2);
    border-top: 1px solid rgba(255, 255, 255, 0.05);
    flex-wrap: wrap;
    gap: 10px;
}

/* 标签选择器 */
.tag-selector {
    display: flex;
    align-items: center;
    gap: 8px;
    flex-wrap: wrap;
}

.tag-label {
    color: #666;
    font-size: 0.85em;
}

.tag-btn {
    background: rgba(255, 255, 255, 0.05);
    border: 1px solid rgba(255, 255, 255, 0.1);
    color: #888;
    padding: 5px 12px;
    border-radius: 15px;
    font-size: 0.8em;
    cursor: pointer;
    transition: all 0.3s;
}

.tag-btn:hover {
    background: rgba(0, 243, 255, 0.1);
    border-color: var(--primary);
    color: var(--primary);
}

.tag-btn.active {
    background: rgba(0, 243, 255, 0.2);
    border-color: var(--primary);
    color: var(--primary);
}

.input-actions {
    display: flex;
    align-items: center;
    gap: 15px;
}

.char-count {
    font-size: 0.85em;
    color: #555;
}

.execute-btn {
    background: linear-gradient(135deg, var(--primary), #00a8b5);
    border: none;
    color: #000;
    padding: 10px 20px;
    border-radius: 8px;
    font-weight: 600;
    cursor: pointer;
    display: flex;
    align-items: center;
    gap: 8px;
    transition: all 0.3s;
    font-family: 'Rajdhani', sans-serif;
}

.execute-btn:hover {
    transform: translateY(-2px);
    box-shadow: 0 5px 20px rgba(0, 243, 255, 0.4);
}

.execute-btn:disabled {
    background: #333;
    color: #666;
    cursor: not-allowed;
    transform: none;
    box-shadow: none;
}

.login-hint {
    background: rgba(255, 193, 7, 0.1);
    border: 1px solid rgba(255, 193, 7, 0.3);
    border-radius: 8px;
    padding: 15px;
    text-align: center;
    color: #ffc107;
}

.login-hint a {
    color: var(--primary);
    text-decoration: none;
    font-weight: 600;
}

/* 回复提示条 */
.reply-bar {
    display: flex;
    justify-content: space-between;
    align-items: center;
    background: rgba(188, 19, 254, 0.1);
    border: 1px solid rgba(188, 19, 254, 0.3);
    border-radius: 8px;
    padding: 10px 15px;
    margin-bottom: 15px;
    color: #bc13fe;
    font-size: 0.9em;
}

.reply-bar button {
    background: transparent;
    border: none;
    color: #888;
    cursor: pointer;
    font-size: 0.9em;
}

.reply-bar button:hover {
    color: #ff4757;
}

/* 图片上传按钮 */
.image-upload-btn {
    width: 36px;
    height: 36px;
    border-radius: 8px;
    background: rgba(0, 243, 255, 0.1);
    border: 1px solid rgba(0, 243, 255, 0.3);
    color: var(--primary);
    display: flex;
    align-items: center;
    justify-content: center;
    cursor: pointer;
    transition: all 0.3s;
    margin-right: 10px;
}

.image-upload-btn:hover {
    background: rgba(0, 243, 255, 0.2);
    transform: scale(1.05);
}

/* 图片预览区 */
.image-preview-area {
    padding: 10px;
    border-top: 1px solid rgba(255, 255, 255, 0.1);
}

.image-preview-item {
    position: relative;
    display: inline-block;
    max-width: 200px;
    border-radius: 8px;
    overflow: hidden;
    border: 2px solid rgba(0, 243, 255, 0.3);
}

.image-preview-item img {
    max-width: 100%;
    max-height: 150px;
    display: block;
}

.remove-image-btn {
    position: absolute;
    top: 5px;
    right: 5px;
    width: 24px;
    height: 24px;
    border-radius: 50%;
    background: rgba(255, 71, 87, 0.9);
    border: none;
    color: #fff;
    cursor: pointer;
    display: flex;
    align-items: center;
    justify-content: center;
    font-size: 12px;
    transition: all 0.3s;
}

.remove-image-btn:hover {
    background: #ff4757;
    transform: scale(1.1);
}

/* 拖拽遮罩 */
.comm-input-area {
    position: relative;
}

.drag-overlay {
    position: absolute;
    top: 0;
    left: 0;
    right: 0;
    bottom: 0;
    background: rgba(0, 243, 255, 0.1);
    border: 3px dashed var(--primary);
    border-radius: 12px;
    display: none;
    flex-direction: column;
    align-items: center;
    justify-content: center;
    gap: 10px;
    color: var(--primary);
    font-size: 1.2em;
    z-index: 10;
    backdrop-filter: blur(5px);
}

.drag-overlay i {
    font-size: 3em;
    animation: bounce-up 1s infinite;
}

@keyframes bounce-up {
    0%, 100% { transform: translateY(0); }
    50% { transform: translateY(-10px); }
}

.comm-input-area.dragging .drag-overlay {
    display: flex;
}

/* 消息中的图片 */
.message-image {
    max-width: 100%;
    max-height: 300px;
    border-radius: 8px;
    margin-top: 10px;
    cursor: pointer;
    transition: transform 0.3s;
    border: 1px solid rgba(255, 255, 255, 0.1);
}

.message-image:hover {
    transform: scale(1.02);
}

/* 图片灯箱 */
.image-lightbox {
    position: fixed;
    top: 0;
    left: 0;
    right: 0;
    bottom: 0;
    background: rgba(0, 0, 0, 0.95);
    display: none;
    align-items: center;
    justify-content: center;
    z-index: 10000;
    cursor: zoom-out;
}

.image-lightbox.show {
    display: flex;
}

.image-lightbox img {
    max-width: 90%;
    max-height: 90%;
    border-radius: 8px;
}

/* 消息列表 */
.comm-messages {
    flex: 1;
    overflow-y: auto;
    padding-right: 10px;
}

.comm-messages::-webkit-scrollbar {
    width: 5px;
}

.comm-messages::-webkit-scrollbar-track {
    background: rgba(0, 0, 0, 0.3);
}

.comm-messages::-webkit-scrollbar-thumb {
    background: var(--primary);
    border-radius: 5px;
}

.loading-messages {
    display: flex;
    align-items: center;
    justify-content: center;
    gap: 10px;
    padding: 40px;
    color: #666;
}

/* 单条消息 */
.message-card {
    background: rgba(255, 255, 255, 0.02);
    border: 1px solid rgba(255, 255, 255, 0.05);
    border-radius: 10px;
    padding: 15px;
    margin-bottom: 15px;
    transition: all 0.3s;
}

.message-card:hover {
    background: rgba(255, 255, 255, 0.04);
    border-color: rgba(255, 255, 255, 0.1);
}

.message-card.pinned {
    background: rgba(255, 215, 0, 0.05);
    border-color: rgba(255, 215, 0, 0.3);
}

.message-card.pending {
    opacity: 0.6;
    border-style: dashed;
}

.message-header {
    display: flex;
    justify-content: space-between;
    align-items: flex-start;
    margin-bottom: 10px;
}

.message-user {
    display: flex;
    align-items: center;
    gap: 10px;
}

.message-avatar {
    width: 40px;
    height: 40px;
    border-radius: 50%;
    background: rgba(0, 243, 255, 0.1);
    border: 2px solid rgba(0, 243, 255, 0.3);
    display: flex;
    align-items: center;
    justify-content: center;
    font-size: 1.2em;
    overflow: hidden;
    flex-shrink: 0;
}

.message-avatar img {
    width: 100%;
    height: 100%;
    object-fit: cover;
}

.message-avatar.admin {
    background: linear-gradient(135deg, rgba(255, 215, 0, 0.2), rgba(255, 140, 0, 0.2));
    border-color: var(--gold);
    box-shadow: 0 0 15px rgba(255, 215, 0, 0.3);
    animation: admin-glow 2s ease-in-out infinite;
}

@keyframes admin-glow {
    0%, 100% { box-shadow: 0 0 15px rgba(255, 215, 0, 0.3); }
    50% { box-shadow: 0 0 25px rgba(255, 215, 0, 0.5); }
}

.message-info {
    display: flex;
    flex-direction: column;
    gap: 3px;
}

.message-name {
    font-weight: 600;
    color: #e0e0e0;
    display: flex;
    align-items: center;
    gap: 8px;
}

.message-name.admin {
    color: var(--gold);
}

.admin-badge {
    background: linear-gradient(135deg, var(--gold), #ff8c00);
    color: #000;
    font-size: 0.7em;
    padding: 2px 6px;
    border-radius: 3px;
    font-weight: 700;
}

.message-meta {
    font-size: 0.8em;
    color: #666;
    display: flex;
    align-items: center;
    gap: 10px;
}

.message-tag {
    background: rgba(0, 243, 255, 0.1);
    color: var(--primary);
    padding: 2px 8px;
    border-radius: 10px;
    font-size: 0.75em;
}

.message-status {
    color: #ffc107;
    font-size: 0.75em;
}

.message-actions {
    display: flex;
    gap: 10px;
}

.message-actions button {
    background: transparent;
    border: none;
    color: #555;
    cursor: pointer;
    padding: 5px;
    transition: color 0.3s;
    font-size: 0.85em;
}

.message-actions button:hover {
    color: var(--primary);
}

.message-actions button.delete:hover {
    color: #ff4757;
}

.message-content {
    color: #ccc;
    line-height: 1.6;
    white-space: pre-wrap;
    word-break: break-word;
}

.message-card.admin-message {
    background: linear-gradient(135deg, rgba(255, 215, 0, 0.05), rgba(255, 140, 0, 0.03));
    border-color: rgba(255, 215, 0, 0.2);
}

/* 回复消息 */
.message-replies {
    margin-top: 15px;
    padding-left: 20px;
    border-left: 2px solid rgba(0, 243, 255, 0.2);
}

.reply-card {
    background: rgba(0, 0, 0, 0.2);
    border-radius: 8px;
    padding: 12px;
    margin-bottom: 10px;
}

.reply-card:last-child {
    margin-bottom: 0;
}

.reply-to-hint {
    color: var(--primary);
    font-size: 0.9em;
    margin-right: 5px;
}

.reply-indicator {
    color: #666;
    font-size: 0.85em;
    margin-bottom: 8px;
}

.reply-indicator i {
    margin-right: 5px;
}

/* 加载更多 */
.load-more {
    text-align: center;
    padding: 20px;
}

.load-more button {
    background: rgba(0, 243, 255, 0.1);
    border: 1px solid rgba(0, 243, 255, 0.3);
    color: var(--primary);
    padding: 12px 30px;
    border-radius: 8px;
    cursor: pointer;
    transition: all 0.3s;
    font-family: 'Rajdhani', sans-serif;
    font-size: 0.95em;
}

.pagination-info {
    text-align: center;
    padding: 10px;
    color: #666;
    font-size: 0.85em;
}

.load-more button:hover {
    background: rgba(0, 243, 255, 0.2);
}

/* 空状态 */
.empty-messages {
    text-align: center;
    padding: 60px 20px;
    color: #555;
}

.empty-messages i {
    font-size: 3em;
    margin-bottom: 15px;
    color: #333;
}

/* 置顶标记 */
.pinned-badge {
    background: linear-gradient(135deg, var(--gold), #ff8c00);
    color: #000;
    font-size: 0.7em;
    padding: 2px 8px;
    border-radius: 3px;
    font-weight: 600;
    margin-left: 8px;
}

/* ================= 私信聊天样式 ================= */
.dm-chat-container {
    display: flex;
    flex-direction: column;
    gap: 15px;
    padding: 10px 0;
}

.dm-bubble {
    display: flex;
    align-items: flex-start;
    gap: 10px;
    max-width: 85%;
}

.dm-bubble.dm-mine {
    align-self: flex-end;
    flex-direction: row-reverse;
}

.dm-bubble.dm-other {
    align-self: flex-start;
}

.dm-avatar {
    width: 36px;
    height: 36px;
    border-radius: 50%;
    background: rgba(0, 243, 255, 0.1);
    border: 2px solid rgba(0, 243, 255, 0.3);
    display: flex;
    align-items: center;
    justify-content: center;
    font-size: 1.1em;
    flex-shrink: 0;
    overflow: hidden;
}

.dm-avatar img {
    width: 100%;
    height: 100%;
    object-fit: cover;
}

.dm-avatar.admin {
    background: linear-gradient(135deg, rgba(255, 215, 0, 0.2), rgba(255, 140, 0, 0.2));
    border-color: var(--gold);
    box-shadow: 0 0 10px rgba(255, 215, 0, 0.3);
}

.dm-content-wrap {
    display: flex;
    flex-direction: column;
    gap: 5px;
}

.dm-sender {
    font-size: 0.8em;
    color: #666;
}

.dm-sender .admin-name {
    color: var(--gold);
    font-weight: 600;
}

.dm-time {
    color: #555;
    margin-left: 8px;
}

.dm-text {
    background: rgba(0, 243, 255, 0.1);
    border: 1px solid rgba(0, 243, 255, 0.2);
    border-radius: 12px;
    padding: 12px 16px;
    color: #ddd;
    line-height: 1.5;
    word-break: break-word;
}

.dm-mine .dm-text {
    background: rgba(188, 19, 254, 0.15);
    border-color: rgba(188, 19, 254, 0.3);
}

.dm-other .dm-text {
    background: linear-gradient(135deg, rgba(255, 215, 0, 0.1), rgba(255, 140, 0, 0.05));
    border-color: rgba(255, 215, 0, 0.2);
}

/* 私信用户列表（站长视角） */
.dm-user-list {
    display: flex;
    flex-direction: column;
    gap: 10px;
}

.dm-user-item {
    display: flex;
    align-items: center;
    gap: 12px;
    padding: 15px;
    background: rgba(255, 255, 255, 0.02);
    border: 1px solid rgba(255, 255, 255, 0.05);
    border-radius: 10px;
    cursor: pointer;
    transition: all 0.3s;
}

.dm-user-item:hover {
    background: rgba(0, 243, 255, 0.1);
    border-color: rgba(0, 243, 255, 0.3);
}

.dm-user-avatar {
    width: 45px;
    height: 45px;
    border-radius: 50%;
    background: rgba(0, 243, 255, 0.1);
    border: 2px solid rgba(0, 243, 255, 0.3);
    display: flex;
    align-items: center;
    justify-content: center;
    font-size: 1.3em;
    flex-shrink: 0;
}

.dm-user-info {
    flex: 1;
    min-width: 0;
}

.dm-user-name {
    font-weight: 600;
    color: #e0e0e0;
    display: flex;
    align-items: center;
    gap: 8px;
    margin-bottom: 4px;
}

.dm-unread-badge {
    background: #ff4757;
    color: #fff;
    font-size: 0.7em;
    padding: 2px 6px;
    border-radius: 10px;
    font-weight: 600;
}

.dm-user-preview {
    font-size: 0.85em;
    color: #888;
    white-space: nowrap;
    overflow: hidden;
    text-overflow: ellipsis;
}

.dm-user-time {
    font-size: 0.8em;
    color: #555;
    white-space: nowrap;
}

/* 响应式 */
@media (max-width: 768px) {
    .comm-container {
        flex-direction: column;
    }
    
    .comm-sidebar {
        width: 100%;
        flex-direction: row;
        padding: 10px;
        overflow-x: auto;
        border-right: none;
        border-bottom: 1px solid rgba(0, 243, 255, 0.2);
    }
    
    .comm-channel {
        padding: 10px 15px;
        white-space: nowrap;
    }
    
    .comm-channel span {
        font-size: 0.85em;
    }
    
    .comm-header {
        flex-direction: column;
        gap: 10px;
        align-items: flex-start;
    }
    
    .input-footer {
        flex-direction: column;
        align-items: stretch;
    }
    
    .tag-selector {
        justify-content: flex-start;
        overflow-x: auto;
        padding-bottom: 5px;
    }
    
    .input-actions {
        justify-content: space-between;
    }
}
    </style>
</head>
<body>

    <!-- 消息提示容器 -->
    <div id="messageToast" class="message-toast"></div>

    <!-- 登录/注册按钮区域 -->
    <div class="auth-header-btn" id="authHeaderBtn">
        <!-- 未登录状态 -->
        <div id="authBtnsContainer">
            <button class="auth-btn auth-btn-outline" onclick="openAuthModal('login')">
                <i class="fas fa-sign-in-alt"></i> 登录
            </button>
            <button class="auth-btn auth-btn-filled" onclick="openAuthModal('register')">
                <i class="fas fa-user-plus"></i> 注册
            </button>
        </div>
        <!-- 已登录状态 -->
        <div id="userInfoContainer" style="display: none;">
            <div class="user-info">
                <div class="user-avatar" id="userAvatar" onclick="openSettingsModal()" style="cursor: pointer;" title="点击修改资料">U</div>
                <span class="user-name" id="userName" onclick="openSettingsModal()" style="cursor: pointer;" title="点击修改资料">用户</span>
                <button class="logout-btn" onclick="handleLogout()">
                    <i class="fas fa-sign-out-alt"></i> 退出
                </button>
            </div>
        </div>
    </div>

    <!-- 背景特效 -->
    <div class="scanlines"></div>
    <canvas id="canvas"></canvas>
    
    <!-- 音乐播放器 -->
    <audio id="audioPlayer" preload="auto"></audio>

    <!-- 左侧常驻工具栏 (System) -->
    <aside class="sidebar sidebar-left">
        <div class="sidebar-title">Tools</div>
        <div onclick="openModal('query-tools')" class="tool-item">
            <i class="fas fa-globe"></i> <span>查询工具</span>
        </div>
        <div onclick="openModal('proxy-tools')" class="tool-item">
            <i class="fas fa-microchip"></i> <span>科学软件</span>
        </div>
        <div onclick="openModal('speed-tools')" class="tool-item">
            <i class="fas fa-tachometer-alt"></i> <span>测速工具</span>
        </div>
        <a href="javascript:alert('功能开发中')" class="tool-item">
            <i class="fas fa-terminal"></i> <span>命令终端</span>
        </a>
    </aside>

    <!-- 右侧常驻工具栏 (Links) -->
    <aside class="sidebar sidebar-right">
        <div class="sidebar-title">Links</div>
        <a href="https://3yuedaohang.com/contact-modal" target="_blank" class="tool-item">
            <i class="fab fa-telegram-plane"></i> <span>站长社群</span>
        </a>
        <div class="tool-item" onclick="openModal('streaming')">
            <i class="fas fa-play-circle"></i> <span>流媒体大全</span>
        </div>
        <div class="tool-item" onclick="openModal('ai-tools')">
            <i class="fas fa-brain"></i> <span>AI 工具库</span>
        </div>
        <div class="tool-item" onclick="openModal('social')">
            <i class="fas fa-hashtag"></i> <span>社交媒体</span>
        </div>
    </aside>

    <!-- 主内容区 -->
    <main class="main-content">
        <header>
            <div class="logo-text">NEXUS LINK</div>
            <div class="sub-logo">三月空间控制台</div>
            
            <!-- 音乐播放器UI -->
            <div class="music-player-bar">
                <div class="music-visualizer music-paused" id="visualizer">
                    <div class="bar"></div><div class="bar"></div><div class="bar"></div><div class="bar"></div>
                </div>
                <div class="track-info" id="trackNameDisplay">System Ready</div>
                <div class="player-controls">
                    <button onclick="prevTrack()"><i class="fas fa-step-backward"></i></button>
                    <button onclick="togglePlay()" id="playBtn"><i class="fas fa-play"></i></button>
                    <button onclick="nextTrack()"><i class="fas fa-step-forward"></i></button>
                </div>
            </div>
        </header>

        <!-- 核心业务区 -->
        <div class="hero-grid">
            <!-- 基础环境 -->
            <div class="holo-card hero-card" onclick="openModal('basic-env')">
                <i class="fas fa-layer-group main-icon"></i>
                <i class="fas fa-cog bg-icon"></i>
                <h2>基础环境</h2>
                <p>新手导航、账号储备、海外云手机</p>
            </div>

            <!-- IP配置 -->
            <div class="holo-card hero-card" onclick="openModal('ip-config')">
                <i class="fas fa-network-wired main-icon" style="color: #bc13fe;"></i>
                <i class="fas fa-globe bg-icon"></i>
                <h2>IP配置</h2>
                <p>专线机场、静态住宅IP、原生ISP</p>
            </div>

            <!-- 软路由 -->
            <div class="holo-card hero-card" onclick="openModal('router')">
                <i class="fas fa-server main-icon" style="color: #ffd700;"></i>
                <i class="fas fa-wifi bg-icon"></i>
                <h2>软路由</h2>
                <p>全屋无感跨境网络方案</p>
            </div>

            <!-- 搭建课程 -->
            <div class="holo-card hero-card" onclick="openModal('course')">
                <i class="fas fa-graduation-cap main-icon" style="color: #00ff9d;"></i>
                <i class="fas fa-book bg-icon"></i>
                <h2>搭建课程</h2>
                <p>独享节点搭建，告别封号焦虑</p>
            </div>

            <!-- 站长陪跑 -->
            <div class="holo-card hero-card" onclick="openModal('peipao')">
                <span class="tag tag-hot">HOT</span>
                <i class="fas fa-user-shield main-icon" style="color: #ff6b81;"></i>
                <i class="fas fa-hands-helping bg-icon"></i>
                <h2>站长陪跑</h2>
                <p>1对1指导，你只管发视频</p>
            </div>

            <!-- VPS服务器 -->
            <div class="holo-card hero-card" onclick="openModal('vps')">
                <i class="fas fa-cloud main-icon" style="color: #74b9ff;"></i>
                <i class="fas fa-database bg-icon"></i>
                <h2>VPS服务器</h2>
                <p>自建节点服务器推荐</p>
            </div>

            <!-- AI 视频工作流 -->
            <div class="holo-card hero-card" onclick="openModal('ai-video')">
                <span class="tag tag-new">AUTO</span>
                <i class="fas fa-robot main-icon" style="color: var(--secondary);"></i>
                <i class="fas fa-video bg-icon"></i>
                <h2>AI视频工作流</h2>
                <p>N8N自动化，AI剪辑解说去重</p>
            </div>

            <!-- 会员专区 -->
            <!-- <div class="holo-card hero-card vip-card" onclick="goToVip()">
                <span class="tag tag-vip">VIP</span>
                <i class="fas fa-crown main-icon" style="color: #ffd700;"></i>
                <i class="fas fa-gem bg-icon"></i>
                <h2>会员专区</h2>
                <p>精华课程，国内独家内容</p>
            </div> -->
        </div>

        <!-- ================= 通讯终端 ================= -->
        <section class="comm-terminal" id="commTerminal">
            <div class="comm-container">
                <!-- 左侧频道切换 -->
                <div class="comm-sidebar">
                    <div class="comm-channel active" data-channel="public" onclick="switchChannel('public')">
                        <i class="fas fa-globe"></i>
                        <span>公共频段</span>
                        <div class="channel-badge" id="publicBadge" style="display:none;">0</div>
                    </div>
                    <div class="comm-channel" data-channel="private" onclick="switchChannel('private')">
                        <i class="fas fa-lock"></i>
                        <span>加密信箱</span>
                        <div class="channel-badge" id="privateBadge" style="display:none;">0</div>
                    </div>
                    <div class="comm-channel" data-channel="notice" onclick="switchChannel('notice')">
                        <i class="fas fa-bullhorn"></i>
                        <span>站务公告</span>
                    </div>
                </div>

            <!-- 右侧内容区 -->
            <div class="comm-main">
                <!-- 顶部状态栏 -->
                <div class="comm-header">
                    <div class="comm-title">
                        <i class="fas fa-satellite-dish"></i>
                        <span id="channelTitle">公共频段 · PUBLIC CHANNEL</span>
                    </div>
                    <div class="comm-status">
                        <span class="status-dot"></span>
                        <span>连接稳定</span>
                        <span class="status-divider">|</span>
                        <span id="onlineCount">正在监听...</span>
                    </div>
                </div>

                <!-- 频道说明 -->
                <div class="comm-description" id="channelDesc">
                    <i class="fas fa-info-circle"></i>
                    因各平台限制严格、频繁封号，且私信无法留敏感内容。考虑到很多朋友没有TG/WhatsApp，站长特开放此留言区。有需求尽管留言，站长会通过注册手机联系你。
                </div>

                <!-- 发布区域 -->
                <div class="comm-input-area" id="messageInputArea">
                    <div class="input-wrapper">
                        <textarea id="messageInput" placeholder="输入情报..." maxlength="500" rows="3"></textarea>
                        
                        <!-- 图片预览区 -->
                        <div class="image-preview-area" id="imagePreviewArea" style="display:none;">
                            <div class="image-preview-item" id="imagePreviewItem">
                                <img id="imagePreview" src="" alt="预览">
                                <button type="button" class="remove-image-btn" onclick="removeImage()">
                                    <i class="fas fa-times"></i>
                                </button>
                            </div>
                        </div>
                        
                        <div class="input-footer">
                            <div class="tag-selector" id="tagSelector">
                                <span class="tag-label">标签:</span>
                                <button type="button" class="tag-btn" data-tag="网络故障" onclick="selectTag(this)">网络故障</button>
                                <button type="button" class="tag-btn" data-tag="资源求助" onclick="selectTag(this)">资源求助</button>
                                <button type="button" class="tag-btn" data-tag="小白提问" onclick="selectTag(this)">小白提问</button>
                                <button type="button" class="tag-btn" data-tag="经验分享" onclick="selectTag(this)">经验分享</button>
                                <button type="button" class="tag-btn" data-tag="BUG反馈" onclick="selectTag(this)">BUG反馈</button>
                            </div>
                            <div class="input-actions">
                                <!-- 图片上传按钮 -->
                                <label class="image-upload-btn" for="messageImageInput" title="上传图片">
                                    <i class="fas fa-image"></i>
                                </label>
                                <input type="file" id="messageImageInput" accept="image/*" style="display:none;" onchange="handleMessageImage(event)">
                                
                                <span class="char-count"><span id="charCount">0</span>/500</span>
                                <button type="button" class="execute-btn" onclick="submitMessage()">
                                    <i class="fas fa-paper-plane"></i>
                                    <span>执行 EXECUTE</span>
                                </button>
                            </div>
                        </div>
                    </div>
                    
                    <!-- 拖拽提示遮罩 -->
                    <div class="drag-overlay" id="dragOverlay">
                        <i class="fas fa-cloud-upload-alt"></i>
                        <span>释放以上传图片</span>
                    </div>
                    
                    <div class="login-hint" id="loginHint" style="display:none;">
                        <i class="fas fa-exclamation-triangle"></i>
                        请先 <a href="javascript:void(0)" onclick="openAuthModal('login')">登录</a> 后发布留言
                    </div>
                </div>

                <!-- 回复提示条 -->
                <div class="reply-bar" id="replyBar" style="display:none;">
                    <span><i class="fas fa-reply"></i> 回复 <strong id="replyToName"></strong>：</span>
                    <button type="button" onclick="cancelReply()"><i class="fas fa-times"></i> 取消</button>
                </div>

                <!-- 消息列表 -->
                <div class="comm-messages" id="messageList">
                    <div class="loading-messages" id="loadingMessages">
                        <i class="fas fa-spinner fa-spin"></i>
                        <span>正在接收信号...</span>
                    </div>
                </div>

                <!-- 加载更多 -->
                <div class="load-more" id="loadMoreBtn" style="display:none;">
                    <button type="button" onclick="loadMoreMessages()">
                        <i class="fas fa-chevron-down"></i>
                        加载更多情报
                    </button>
                </div>
                <div class="pagination-info" id="paginationInfo"></div>
            </div>
        </div>
    </section>
    </main>

    <!-- ================= 弹窗区域 ================= -->

<!-- 网络服务弹窗 (高亮优化版) -->
<!-- 基础环境弹窗 -->
<div id="basic-env-modal" class="modal-overlay">
    <div class="modal-content" style="max-width: 700px;">
        <span class="modal-close" onclick="closeModal('basic-env')">&times;</span>
        <h2><i class="fas fa-layer-group" style="color: var(--primary); margin-right: 10px;"></i>基础环境 & 账号 & 云手机</h2>
        <div class="modal-grid">
            <a href="rumen.html" target="_blank" class="link-card">
                <i class="fas fa-compass" style="color: #00f3ff;"></i>
                <div>
                    <h3>新手导航</h3>
                    <p>小白第一步，防封避坑指南。</p>
                </div>
            </a>
            <a href="https://accboyytbsydh.acceboy.com" target="_blank" class="link-card" 
               style="border: 1px solid rgba(0, 255, 157, 0.5); background: linear-gradient(145deg, rgba(0, 255, 157, 0.05), rgba(0, 0, 0, 0.4));">
                <i class="fas fa-shopping-cart" style="color: #00ff9d;"></i>
                <div>
                    <h3>基础账号储备 <span style="font-size:0.6rem; background:rgba(0, 255, 157, 0.15); color:#00ff9d; border:1px solid #00ff9d; padding:0 4px; border-radius:3px;">自动发货</span></h3>
                    <p style="color: #00ff9d;">苹果带🚀 | 谷歌号 | TK白号 | Facebook | ChatGPT | Netflix/Spotify等</p>
                </div>
            </a>
            <a href="https://www.duoplus.cn/share/tNVaXc" target="_blank" class="link-card"
               style="border: 1px solid rgba(32, 227, 178, 0.4); background: linear-gradient(145deg, rgba(32, 227, 178, 0.08), rgba(0, 0, 0, 0.4));">
                <i class="fas fa-mobile-alt" style="color: #20e3b2;"></i> 
                <div>
                    <h3 style="color: #20e3b2;">DuoPlus 海外云手机</h3>
                    <p>无需买真机 | 独享原生环境 | <span style="color: #20e3b2; font-weight: bold;">养号/发视频都可以</span></p>
                </div>
            </a>
        </div>
    </div>
</div>

<!-- IP配置弹窗 -->
<div id="ip-config-modal" class="modal-overlay">
    <div class="modal-content" style="max-width: 800px;">
        <span class="modal-close" onclick="closeModal('ip-config')">&times;</span>
        <h2><i class="fas fa-network-wired" style="color: #bc13fe; margin-right: 10px;"></i>IP配置 (机场 & 静态IP)</h2>
        
        <div class="modal-section-title">专线机场</div>
        <div class="modal-grid">
            <a href="https://st1.hosbb.com/#/register?code=0uqD01qw" target="_blank" class="link-card">
                <i class="fas fa-plane-departure" style="color: #bc13fe;"></i>
                <div>
                    <h3>专线机场 SSR <span class="code-badge" style="background: rgba(188, 19, 254, 0.15); border: 1px solid rgba(188, 19, 254, 0.3); color: #bc13fe;">推荐</span></h3>
                    <p>使用海外顶级AI必备 | 住宅IP前置代理必备。</p>
                </div>
            </a>
            <a href="https://candytally3.com/web/#/login?code=UXbg9gDv" target="_blank" class="link-card">
                <i class="fas fa-cloud" style="color: #ff69b4;"></i>
                <div>
                    <h3>专线机场 (糖果云) <span class="code-badge" style="background: rgba(188, 19, 254, 0.15); border: 1px solid rgba(188, 19, 254, 0.3); color: #bc13fe;">推荐</span></h3>
                    <p>稳定高速 | 住宅IP前置代理。</p>
                </div>
            </a>
        </div>
        
        <div class="modal-section-title">静态住宅IP</div>
        <div class="modal-grid">
            <a href="https://www.miyaip.com/signup?invitecode=9143527" target="_blank" class="link-card"
               style="background: rgba(255, 255, 255, 0.04); border: 1px solid rgba(255, 215, 0, 0.3); box-shadow: 0 0 15px rgba(255, 215, 0, 0.1);">
                <i class="fas fa-fire" style="color:#ffd700; text-shadow: 0 0 10px rgba(255, 215, 0, 0.5);"></i>
                <div>
                    <h3 style="color: #ffd700;">米亚IP (新手短视频推荐) <span style="font-size: 0.7rem; color: #ffd700; background: rgba(255, 215, 0, 0.15); border: 1px solid rgba(255, 215, 0, 0.4); padding: 2px 6px; border-radius: 4px;">扫码直连</span></h3>
                    <p><span style="color: #ffd700; font-weight: bold;">⚡ 无需中转</span> | 9折码：<span class="code-badge">3yuejiuzhhe</span></p>
                </div>
            </a>
            <a href="https://www.985proxy.com/?invite=EAUDSR" target="_blank" class="link-card" 
               style="background: linear-gradient(145deg, rgba(255, 80, 0, 0.15), rgba(0, 0, 0, 0.6)); border: 1px solid rgba(255, 80, 0, 0.5);">
                <i class="fas fa-meteor" style="color: #ff6600;"></i>
                <div>
                    <h3 style="color: #ff9933;">985 Proxy (最便宜原生IP，批量起号专用)</h3>
                    <p><span style="color: #ffcc00; font-weight:bold;">批量找站长拿6-9折</span> | <span class="code-badge" style="border: 1px solid #ff6600; color: #ff9966; background: rgba(255, 80, 0, 0.1);">需SSR中转</span></p>
                </div>
            </a>
            <a href="https://www.kookeey.com/register.html?aff=33435631" target="_blank" class="link-card">
                <i class="fas fa-globe" style="color: #00bcd4;"></i>
                <div>
                    <h3>Kookeey (短视频/直播推荐)</h3>
                    <p>国家多 | <span class="text-highlight">需机场SSR中转</span></p>
                </div>
            </a>
            <a href="https://www.vircs.com/welcome?vcd=1d1b3b78" target="_blank" class="link-card">
                <i class="fas fa-home" style="color: #00bfff;"></i>
                <div>
                    <h3 style="color: #66ccff;">美国真实住宅家庭宽带ATT</h3>
                    <p>稀缺家庭IP资源 | <span style="color: #00bfff; font-weight:bold;">原生独享</span></p>
                </div>
            </a>
            <a href="https://www.proxystore.net/?ref=28502" target="_blank" class="link-card">
                <i class="fab fa-paypal" style="color:#003087;"></i>
                <div>
                    <h3>ProxyStore</h3>
                    <p>英美巨头住宅IP | <span class="text-highlight">不支持国内支付</span> | paypal/stripe</p>
                </div>
            </a>
        </div>
    </div>
</div>

<!-- 软路由弹窗 -->
<div id="router-modal" class="modal-overlay">
    <div class="modal-content" style="max-width: 600px;">
        <span class="modal-close" onclick="closeModal('router')">&times;</span>
        <h2><i class="fas fa-server" style="color: #ffd700; margin-right: 10px;"></i>软路由 / 硬件环境</h2>
        <div class="modal-grid" style="grid-template-columns: 1fr;">
            <a href="https://dajian.cyou/lesson/ly" target="_blank" class="link-card gold-card" style="padding: 25px;">
                <i class="fas fa-server" style="font-size: 2rem;"></i>
                <div>
                    <h3 style="font-size: 1.2rem;">软路由配置方案</h3>
                    <p style="font-size: 0.95rem;">工作室首选，打造全屋无感跨境网络。一次配置，全家科学上网，无需每台设备单独设置。</p>
                </div>
            </a>
        </div>
    </div>
</div>

<!-- 搭建课程弹窗 -->
<div id="course-modal" class="modal-overlay">
    <div class="modal-content" style="max-width: 600px;">
        <span class="modal-close" onclick="closeModal('course')">&times;</span>
        <h2><i class="fas fa-graduation-cap" style="color: #00ff9d; margin-right: 10px;"></i>独享节点搭建课程</h2>
        <div class="modal-grid" style="grid-template-columns: 1fr;">
            <a href="https://dajian.cyou/lesson/lesson" target="_blank" class="link-card gold-card" style="padding: 25px;">
                <i class="fas fa-graduation-cap" style="font-size: 2rem;"></i>
                <div>
                    <h3 style="font-size: 1.2rem;">节点搭建教学</h3>
                    <p style="font-size: 0.95rem;">授人以渔，彻底告别封号焦虑。从零开始搭建自己的专属节点，不再依赖第三方。</p>
                </div>
            </a>
        </div>
    </div>
</div>

<!-- 站长陪跑弹窗 -->
<div id="peipao-modal" class="modal-overlay">
    <div class="modal-content" style="max-width: 600px;">
        <span class="modal-close" onclick="closeModal('peipao')">&times;</span>
        <h2><i class="fas fa-user-shield" style="color: #ff6b81; margin-right: 10px;"></i>站长陪跑项目</h2>
        <div class="modal-grid" style="grid-template-columns: 1fr;">
            <a href="https://dajian.cyou/lesson/peipao" target="_blank" class="link-card" style="padding: 25px; border-color: #ff4757; background: linear-gradient(145deg, rgba(255, 71, 87, 0.15), rgba(0, 0, 0, 0.6));">
                <i class="fas fa-user-shield" style="font-size: 2rem; color: #ff6b81;"></i>
                <div>
                    <h3 style="font-size: 1.2rem; color: #ff6b81;">账号环境稳定陪跑 <span style="font-size:0.7em; border:1px solid #ff4757; padding:2px 6px; border-radius:3px; margin-left:8px;">NEW</span></h3>
                    <p style="font-size: 0.95rem; color: #e0e0e0;">1对1全程指导 | 你只管发视频，其余问题站长帮你搞定 | <span style="color:#fff; font-weight:bold;">小白首选</span></p>
                </div>
            </a>
        </div>
    </div>
</div>

<!-- VPS服务器弹窗 -->
<div id="vps-modal" class="modal-overlay">
    <div class="modal-content" style="max-width: 800px;">
        <span class="modal-close" onclick="closeModal('vps')">&times;</span>
        <h2><i class="fas fa-cloud" style="color: #74b9ff; margin-right: 10px;"></i>高阶 · 自建节点服务器 (VPS)</h2>
        <div class="modal-grid">
            <a href="https://lisahost.com/aff.php?aff=5553" target="_blank" class="link-card">
                <i class="fas fa-network-wired" style="color: #00f3ff;"></i>
                <div>
                    <h3>LisaHost 大带宽 <span class="code-badge" style="background: rgba(0, 243, 255, 0.15); border: 1px solid rgba(0, 243, 255, 0.3); color: #00f3ff;">TK推荐</span></h3>
                    <p>大量用户反馈，配置影响流量 | 双ISP/解锁强</p>
                </div>
            </a>
            <a href="cn2/banwagong.html" target="_blank" class="link-card">
                <i class="fas fa-crown" style="color: #ff9900;"></i>
                <div>
                    <h3>搬瓦工 CN2 GIA <span class="code-badge" style="background: rgba(255, 153, 0, 0.15); border: 1px solid rgba(255, 153, 0, 0.3); color: #ff9900;">速度之王</span></h3>
                    <p>个人能用最好的线路，没有之一</p>
                </div>
            </a>
            <a href="https://www.666clouds.com/aff.php?aff=2809" target="_blank" class="link-card">
                <i class="fas fa-cloud" style="color: #9c88ff;"></i>
                <div>
                    <h3>66云 纯净住宅</h3>
                    <p>适合多业务场景</p>
                </div>
            </a>
            <a href="https://ipraft.com/?i950472" target="_blank" class="link-card">
                <i class="fas fa-lock" style="color: #00cec9;"></i>
                <div>
                    <h3>IPRaft 原生VPS</h3>
                    <p>优质线路推荐</p>
                </div>
            </a>
            <a href="https://my.zorocloud.com/aff.php?aff=639" target="_blank" class="link-card">
                <i class="fas fa-bolt" style="color: #fdcb6e;"></i>
                <div>
                    <h3>ZoroCloud 优化</h3>
                    <p>性价比之选</p>
                </div>
            </a>
            <a href="https://wepc.au/aff.php?aff=1603" target="_blank" class="link-card">
                <i class="fas fa-globe-asia" style="color: #74b9ff;"></i>
                <div>
                    <h3>WEPC VPS</h3>
                    <p>澳洲/香港线路</p>
                </div>
            </a>
        </div>
    </div>
</div>

    <div id="ai-video-modal" class="modal-overlay">
        <div class="modal-content" style="max-width: 900px;">
            <span class="modal-close" onclick="closeModal('ai-video')">&times;</span>
            
            <div class="ai-header">
                <h2>N8N 视频创作母体</h2>
                <p>AI 全自动化流水线 · 解放双手 · 矩阵运营必备</p>
            </div>
            
            <!-- 价格卡片区 -->
            <div class="pricing-container">
                <!-- 卡片1：尊贵版 -->
                <div class="pricing-card premium">
                    <h3 style="color:#e0e0e0; letter-spacing:2px;">站长配置版</h3>
                    <div class="price-tag">
                        <span class="price-currency">¥</span>
                        <span class="price-num">899</span>
                    </div>
                    <ul class="feature-list">
                        <li><i class="fas fa-check-circle check-icon"></i> <span>包含核心 N8N 工作流文件</span></li>
                        <li><i class="fas fa-check-circle check-icon"></i> <span>一对一远程安装调试</span></li>
                        <li><i class="fas fa-check-circle check-icon"></i> <span>永久授权 + 后续更新</span></li>
                        <li><i class="fas fa-check-circle check-icon"></i> <span>赠送 50G 混剪素材库</span></li>
                    </ul>
                </div>

                <!-- 卡片2：源码版 -->
                <div class="pricing-card basic">
                    <h3 style="color:#888;">源码自部署</h3>
                    <div class="price-tag">
                        <span class="price-currency">¥</span>
                        <span class="price-num" style="color:#aaa; text-shadow:none;">499</span>
                    </div>
                    <ul class="feature-list">
                        <li><i class="fas fa-check-circle check-icon" style="color:#888; text-shadow:none;"></i> <span>提供完整 JSON 源码</span></li>
                        <li><i class="fas fa-check-circle check-icon" style="color:#888; text-shadow:none;"></i> <span>附带基础部署文档</span></li>
                        <li><i class="fas fa-times-circle cross-icon"></i> <span style="color:#666;">不含远程协助与配置</span></li>
                        <li><i class="fas fa-times-circle cross-icon"></i> <span style="color:#666;">不含素材库赠送</span></li>
                    </ul>
                </div>
            </div>
            
            <!-- 案例展示通栏 -->
            <div style="margin-top: 10px;">
                <div class="modal-section-title" style="margin: 0 0 15px 0; border:none; padding:0;">🔥 实战效果演示</div>
                <a href="n8n/n8n.html" target="_blank" class="demo-banner">
                    <div class="play-btn-circle"><i class="fas fa-play"></i></div>
                    <div class="demo-info">
                        <h3>WATCH DEMO: 视频自动切片与二创</h3>
                        <p>点击观看完整工作流运行实录，见证 10 分钟产出 100 条视频的效率。</p>
                    </div>
                    <i class="fas fa-chevron-right demo-arrow"></i>
                </a>
            </div>

        </div>
    </div>

    <!-- 科学软件弹窗 -->
    <div id="proxy-tools-modal" class="modal-overlay">
        <div class="modal-content" style="max-width:600px;">
            <span class="modal-close" onclick="closeModal('proxy-tools')">&times;</span>
            <h2>科学客户端</h2>
            <div class="modal-grid" style="grid-template-columns: 1fr;">
                <a href="https://github.com/2dust/v2rayN/releases" target="_blank" class="link-card"><i class="fab fa-windows"></i> V2RayN (Windows 推荐)</a>
                <a href="https://github.com/MatsuriDayo/NekoBoxForAndroid/releases" target="_blank" class="link-card"><i class="fab fa-android"></i> NekoBox (安卓 推荐)</a>
                <a href="http://www.hostbuf.com/" target="_blank" class="link-card"><i class="fas fa-terminal"></i> Finalshell SSH工具</a>
            </div>
        </div>
    </div>

    <!-- 测速弹窗 -->
    <div id="speed-tools-modal" class="modal-overlay">
        <div class="modal-content" style="max-width:600px;">
            <span class="modal-close" onclick="closeModal('speed-tools')">&times;</span>
            <h2>测速与环境</h2>
            <div class="modal-grid" style="grid-template-columns: 1fr;">
                <a href="https://www.speedtest.net/" target="_blank" class="link-card"><i class="fas fa-tachometer-alt"></i> SpeedTest 测速</a>
                <a href="https://speed.cloudflare.com/" target="_blank" class="link-card"><i class="fas fa-cloud"></i> Cloudflare 测速</a>
                <a href="https://fast.com/" target="_blank" class="link-card"><i class="fas fa-film"></i> Netflix Fast 测速</a>
                <a href="https://www.adspower.net/share/ZaYRHd" target="_blank" class="link-card"><i class="fas fa-fingerprint"></i> ADS 指纹浏览器</a>
            </div>
        </div>
    </div>

    <!-- 流媒体弹窗 -->
    <div id="streaming-modal" class="modal-overlay">
        <div class="modal-content">
            <span class="modal-close" onclick="closeModal('streaming')">&times;</span>
            <h2>全球流媒体</h2>
            <div class="modal-network-tip">
                <i class="fas fa-info-circle"></i>
                <span>使用以下内容需要科学上网。如果没有网络可以购买 <a href="#" onclick="closeModal('streaming');openModal('network');">SSR机场</a> 或 <a href="#" onclick="closeModal('streaming');openModal('network');">糖果云</a>，里面也有教学视频。</span>
            </div>
            <div class="modal-grid">
                <a href="https://www.netflix.com/" target="_blank" class="link-card"><img src="icon/netflix-1-logo-svgrepo-com.svg" onerror="this.src='';this.className='fas fa-play'"/> <h3>Netflix</h3></a>
                <a href="https://www.disneyplus.com/" target="_blank" class="link-card"><img src="icon/desney.svg" onerror="this.src='';this.className='fas fa-video'"/> <h3>Disney+</h3></a>
                <a href="https://www.primevideo.com/" target="_blank" class="link-card"><img src="icon/primevideo.svg" onerror="this.src='';this.className='fas fa-play'"/> <h3>Prime Video</h3></a>
                <a href="https://www.max.com/" target="_blank" class="link-card"><img src="icon/icons8-hbo.svg" onerror="this.src='';this.className='fas fa-tv'"/> <h3>HBO Max</h3></a>
                <a href="https://www.spotify.com/" target="_blank" class="link-card"><img src="icon/icons8-spotify.svg" onerror="this.src='';this.className='fas fa-music'"/> <h3>Spotify</h3></a>
                <a href="https://kalos.reelhunter.online/" target="_blank" class="link-card"><i class="fas fa-theater-masks"></i> <h3>Kalos TV</h3></a>
                <a href="https://www.twitch.tv/" target="_blank" class="link-card"><img src="icon/twitch-svgrepo-com.svg" onerror="this.src='';this.className='fas fa-gamepad'"/> <h3>Twitch</h3></a>
            </div>
        </div>
    </div>

    <!-- AI 工具弹窗 -->
    <div id="ai-tools-modal" class="modal-overlay">
        <div class="modal-content">
            <span class="modal-close" onclick="closeModal('ai-tools')">&times;</span>
            <h2>AI 前沿工具库</h2>
            <div class="modal-network-tip">
                <i class="fas fa-info-circle"></i>
                <span>使用以下内容需要科学上网。如果没有网络可以购买 <a href="#" onclick="closeModal('ai-tools');openModal('network');">SSR机场</a> 或 <a href="#" onclick="closeModal('ai-tools');openModal('network');">糖果云</a>，里面也有教学视频。</span>
            </div>
            <div class="modal-grid">
                <a href="https://nf.video/OXYNE" target="_blank" class="link-card card-highlight"><i class="fas fa-shopping-bag"></i> <h3>AI/影音合租</h3></a>
                <a href="https://www.heygen.com/invite/FGZD5C5C" target="_blank" class="link-card"><img src="icon/heygen.svg" onerror="this.src='';this.className='fas fa-user-astronaut'"/> <h3>Heygen 数字人</h3></a>
                <a href="https://aistudio.google.com/" target="_blank" class="link-card"><img src="icon/aistudio.svg" onerror="this.src='';this.className='fas fa-code'"/> <h3>Google AI Studio</h3></a>
                <a href="https://www.google.com/gemini" target="_blank" class="link-card"><img src="icon/gemini.svg" onerror="this.src='';this.className='fas fa-brain'"/> <h3>Gemini</h3></a>
                <a href="https://chat.openai.com/" target="_blank" class="link-card"><img src="icon/chatgpt.svg" onerror="this.src='';this.className='fas fa-robot'"/> <h3>ChatGPT</h3></a>
                <a href="https://claude.ai/" target="_blank" class="link-card"><img src="icon/claude.svg" onerror="this.src='';this.className='fas fa-comments'"/> <h3>Claude 3</h3></a>
                <a href="https://www.meta.ai/" target="_blank" class="link-card"><img src="icon/meta.svg" onerror="this.src='';this.className='fab fa-meta'"/> <h3>Meta AI</h3></a>
                <a href="https://grok.com/" target="_blank" class="link-card"><img src="icon/grok.svg" onerror="this.src='';this.className='fas fa-rocket'"/> <h3>Grok</h3></a>
                <a href="https://www.perplexity.ai/" target="_blank" class="link-card"><img src="icon/perplexity.svg" onerror="this.src='';this.className='fas fa-search'"/> <h3>Perplexity</h3></a>
            </div>
        </div>
    </div>

    <!-- 社交媒体弹窗 -->
    <div id="social-modal" class="modal-overlay">
        <div class="modal-content">
            <span class="modal-close" onclick="closeModal('social')">&times;</span>
            <h2>热门社交媒体</h2>
            <div class="modal-network-tip">
                <i class="fas fa-info-circle"></i>
                <span>使用以下内容需要科学上网。如果没有网络可以购买 <a href="#" onclick="closeModal('social');openModal('network');">SSR机场</a> 或 <a href="#" onclick="closeModal('social');openModal('network');">糖果云</a>，里面也有教学视频。</span>
            </div>
            <div class="modal-grid">
                <a href="https://www.youtube.com/" target="_blank" class="link-card"><img src="icon/youtube-color-svgrepo-com.svg" onerror="this.src='';this.className='fab fa-youtube'"/> <h3>YouTube</h3></a>
                <a href="https://www.tiktok.com/" target="_blank" class="link-card"><img src="icon/tiktok.svg" onerror="this.src='';this.className='fab fa-tiktok'"/> <h3>TikTok</h3></a>
                <a href="https://www.instagram.com/" target="_blank" class="link-card"><img src="icon/instagram-1-svgrepo-com.svg" onerror="this.src='';this.className='fab fa-instagram'"/> <h3>Instagram</h3></a>
                <a href="https://twitter.com/" target="_blank" class="link-card"><img src="icon/twitter-color-svgrepo-com.svg" onerror="this.src='';this.className='fab fa-twitter'"/> <h3>X (Twitter)</h3></a>
                <a href="https://www.threads.net/" target="_blank" class="link-card"><img src="icon/threads.svg" onerror="this.src='';this.className='fas fa-at'"/> <h3>Threads</h3></a>
                <a href="https://www.facebook.com/" target="_blank" class="link-card"><img src="icon/facebook-svgrepo-com.svg" onerror="this.src='';this.className='fab fa-facebook'"/> <h3>Facebook</h3></a>
                <a href="https://discord.com/" target="_blank" class="link-card"><img src="icon/discord.svg" onerror="this.src='';this.className='fab fa-discord'"/> <h3>Discord</h3></a>
                <a href="https://www.snapchat.com/" target="_blank" class="link-card"><img src="icon/snapchat-svgrepo-com.svg" onerror="this.src='';this.className='fab fa-snapchat'"/> <h3>Snapchat</h3></a>
                <a href="https://www.reddit.com/" target="_blank" class="link-card"><img src="icon/reddit-svgrepo-com.svg" onerror="this.src='';this.className='fab fa-reddit'"/> <h3>Reddit</h3></a>
                 <a href="https://www.pinterest.com/" target="_blank" class="link-card"><img src="icon/pinterest-color-svgrepo-com.svg" onerror="this.src='';this.className='fab fa-pinterest'"/> <h3>Pinterest</h3></a>
            </div>
        </div>
    </div>

    <!-- ================= 登录弹窗 ================= -->
    <div id="login-modal" class="modal-overlay">
        <div class="auth-modal-content">
            <span class="modal-close" onclick="closeAuthModal('login')">&times;</span>
            
            <div class="auth-title">
                <h2><i class="fas fa-rocket"></i> 欢迎回来</h2>
                <p>登录您的 NEXUS 账户</p>
            </div>
            
            <div class="auth-form" id="loginForm">
                <div class="form-group" id="loginEmailGroup">
                    <label><i class="fas fa-envelope"></i> 邮箱地址</label>
                    <input type="email" id="loginEmail" placeholder="请输入邮箱">
                    <span class="error-text">请输入有效的邮箱地址</span>
                </div>
                
                <div class="form-group" id="loginPasswordGroup">
                    <label><i class="fas fa-lock"></i> 密码</label>
                    <input type="password" id="loginPassword" placeholder="请输入密码" onkeypress="if(event.keyCode===13)handleLogin()">
                    <i class="fas fa-eye password-toggle" onclick="togglePassword('loginPassword', this)"></i>
                    <span class="error-text">密码不能为空</span>
                </div>
                
                <button type="button" class="submit-btn" id="loginSubmitBtn" onclick="handleLogin()">
                    <span class="btn-text">登 录</span>
                    <div class="btn-loader"></div>
                </button>
            </div>
            
            <div class="auth-switch">
                还没有账户？<a href="javascript:void(0)" onclick="switchToRegister()">立即注册</a>
            </div>
        </div>
    </div>

    <!-- ================= 注册弹窗 ================= -->
    <div id="register-modal" class="modal-overlay">
        <div class="auth-modal-content">
            <span class="modal-close" onclick="closeAuthModal('register')">&times;</span>
            
            <div class="auth-title">
                <h2><i class="fas fa-user-astronaut"></i> 创建账户</h2>
                <p>加入 NEXUS 空间站</p>
            </div>
            
            <div class="auth-form" id="registerForm">
                <!-- 头像上传 -->
                <div class="form-group" id="registerAvatarGroup">
                    <label><i class="fas fa-camera"></i> 头像 <span style="color:#666;font-weight:normal;font-size:0.85em;">(可选)</span></label>
                    <div style="display:flex;align-items:center;gap:15px;">
                        <div id="registerAvatarPreview" style="width:60px;height:60px;border-radius:50%;background:rgba(0,243,255,0.1);border:2px dashed rgba(0,243,255,0.3);display:flex;align-items:center;justify-content:center;font-size:1.5em;overflow:hidden;cursor:pointer;" onclick="document.getElementById('registerAvatarInput').click()">
                            👤
                        </div>
                        <div style="flex:1;">
                            <input type="file" id="registerAvatarInput" accept="image/*" style="display:none;" onchange="previewRegisterAvatar(this)">
                            <button type="button" onclick="document.getElementById('registerAvatarInput').click()" style="padding:8px 15px;background:rgba(0,243,255,0.2);border:1px solid var(--primary);border-radius:8px;color:var(--primary);cursor:pointer;font-size:0.85em;">
                                <i class="fas fa-upload"></i> 选择头像
                            </button>
                            <button type="button" id="removeRegisterAvatarBtn" onclick="removeRegisterAvatar()" style="display:none;margin-left:10px;padding:8px 15px;background:rgba(255,71,87,0.2);border:1px solid #ff4757;border-radius:8px;color:#ff4757;cursor:pointer;font-size:0.85em;">
                                <i class="fas fa-times"></i> 移除
                            </button>
                        </div>
                    </div>
                </div>

                <div class="form-group" id="registerNameGroup">
                    <label><i class="fas fa-user"></i> 昵称 <span style="color:#666;font-weight:normal;font-size:0.85em;">(唯一标识)</span></label>
                    <div style="display:flex;gap:10px;">
                        <input type="text" id="registerName" placeholder="请输入昵称" minlength="2" maxlength="20" style="flex:1;">
                        <button type="button" onclick="fillRandomNickname()" style="padding:10px 15px;background:rgba(0,243,255,0.2);border:1px solid var(--primary);border-radius:8px;color:var(--primary);cursor:pointer;white-space:nowrap;font-size:0.9em;" title="随机生成昵称">
                            <i class="fas fa-dice"></i> 随机
                        </button>
                    </div>
                    <span class="error-text">昵称长度应为2-20个字符</span>
                </div>
                
                <div class="form-group" id="registerEmailGroup">
                    <label><i class="fas fa-envelope"></i> 邮箱地址</label>
                    <input type="email" id="registerEmail" placeholder="请输入邮箱">
                    <span class="error-text">请输入有效的邮箱地址</span>
                </div>
                
                <div class="form-group" id="registerPhoneGroup">
                    <label><i class="fas fa-phone"></i> 手机号码 <span style="color:#ff4757;">*</span></label>
                    <input type="tel" id="registerPhone" placeholder="请输入手机号码" required>
                    <span class="error-text">请输入有效的11位手机号码</span>
                    <div style="font-size: 0.75em; color: #666; margin-top: 5px;">
                        <i class="fas fa-info-circle"></i> 仅用于站长回访或重要通知，不会泄露给第三方
                    </div>
                </div>
                
                <div class="form-group" id="registerPasswordGroup">
                    <label><i class="fas fa-lock"></i> 设置密码</label>
                    <input type="password" id="registerPassword" placeholder="至少6位字符" minlength="6" oninput="checkPasswordStrength(this.value)">
                    <i class="fas fa-eye password-toggle" onclick="togglePassword('registerPassword', this)"></i>
                    <span class="error-text">密码长度至少6位</span>
                    <div class="password-strength">
                        <div class="strength-bar" id="strengthBar1"></div>
                        <div class="strength-bar" id="strengthBar2"></div>
                        <div class="strength-bar" id="strengthBar3"></div>
                    </div>
                    <div class="strength-text" id="strengthText"></div>
                </div>
                
                <div class="form-group" id="registerConfirmGroup">
                    <label><i class="fas fa-lock"></i> 确认密码</label>
                    <input type="password" id="registerConfirm" placeholder="再次输入密码" onkeypress="if(event.keyCode===13)handleRegister()">
                    <i class="fas fa-eye password-toggle" onclick="togglePassword('registerConfirm', this)"></i>
                    <span class="error-text">两次密码输入不一致</span>
                </div>
                
                <button type="button" class="submit-btn" id="registerSubmitBtn" onclick="handleRegister()">
                    <span class="btn-text">注 册</span>
                    <div class="btn-loader"></div>
                </button>
            </div>
            
            <div class="auth-switch">
                已有账户？<a href="javascript:void(0)" onclick="switchToLogin()">立即登录</a>
            </div>
        </div>
    </div>

    <!-- ================= 用户设置弹窗 ================= -->
    <div id="settings-modal" class="modal-overlay">
        <div class="auth-modal-content">
            <span class="modal-close" onclick="closeAuthModal('settings')">&times;</span>
            
            <div class="auth-title">
                <h2><i class="fas fa-cog"></i> 账户设置</h2>
                <p>管理您的个人信息</p>
            </div>
            
            <div class="auth-form" id="settingsForm">
                <!-- 头像选择 -->
                <div class="form-group">
                    <label><i class="fas fa-image"></i> 头像设置</label>
                    <div class="avatar-upload-section">
                        <!-- 头像预览 -->
                        <div class="avatar-preview-container">
                            <div class="avatar-preview" id="avatarPreview">👤</div>
                            <label class="avatar-upload-btn" for="avatarFileInput">
                                <i class="fas fa-camera"></i>
                            </label>
                            <input type="file" id="avatarFileInput" accept="image/*" style="display:none;" onchange="handleAvatarUpload(event)">
                        </div>
                        <div class="avatar-upload-hint">点击相机图标上传图片</div>
                    </div>
                    
                    <!-- emoji头像选择 -->
                    <div class="avatar-emoji-section">
                        <div class="avatar-emoji-label">或选择表情头像：</div>
                        <div class="avatar-selector" id="avatarSelector">
                            <div class="avatar-option" data-avatar="👤" onclick="selectAvatar(this)">👤</div>
                            <div class="avatar-option" data-avatar="😀" onclick="selectAvatar(this)">😀</div>
                            <div class="avatar-option" data-avatar="😎" onclick="selectAvatar(this)">😎</div>
                            <div class="avatar-option" data-avatar="🚀" onclick="selectAvatar(this)">🚀</div>
                            <div class="avatar-option" data-avatar="⭐" onclick="selectAvatar(this)">⭐</div>
                            <div class="avatar-option" data-avatar="🎮" onclick="selectAvatar(this)">🎮</div>
                            <div class="avatar-option" data-avatar="💻" onclick="selectAvatar(this)">💻</div>
                            <div class="avatar-option" data-avatar="🎵" onclick="selectAvatar(this)">🎵</div>
                            <div class="avatar-option" data-avatar="🌙" onclick="selectAvatar(this)">🌙</div>
                            <div class="avatar-option" data-avatar="🔥" onclick="selectAvatar(this)">🔥</div>
                            <div class="avatar-option" data-avatar="💎" onclick="selectAvatar(this)">💎</div>
                            <div class="avatar-option" data-avatar="🎯" onclick="selectAvatar(this)">🎯</div>
                        </div>
                    </div>
                </div>
                
                <div class="form-group" id="settingsNameGroup">
                    <label><i class="fas fa-user"></i> 昵称</label>
                    <input type="text" id="settingsName" placeholder="请输入昵称" minlength="2" maxlength="20">
                    <span class="error-text">昵称长度应为2-20个字符</span>
                </div>
                
                <div class="form-group">
                    <label><i class="fas fa-envelope"></i> 邮箱地址</label>
                    <input type="email" id="settingsEmail" disabled style="opacity: 0.6; cursor: not-allowed;">
                    <div style="font-size: 0.75em; color: #666; margin-top: 5px;">
                        <i class="fas fa-lock"></i> 邮箱为登录账号，不可修改
                    </div>
                </div>
                
                <div class="form-group" id="settingsPhoneGroup">
                    <label><i class="fas fa-phone"></i> 手机号码</label>
                    <input type="tel" id="settingsPhone" placeholder="请输入手机号码">
                    <span class="error-text">请输入有效的手机号码</span>
                    <div style="font-size: 0.75em; color: #666; margin-top: 5px;">
                        <i class="fas fa-info-circle"></i> 仅用于站长回访或重要通知
                    </div>
                </div>
                
                <button type="button" class="submit-btn" id="settingsSubmitBtn" onclick="handleUpdateProfile()">
                    <span class="btn-text">保存修改</span>
                    <div class="btn-loader"></div>
                </button>
            </div>
        </div>
    </div>

    <!-- 查询工具弹窗 -->
    <div id="query-tools-modal" class="modal-overlay">
        <div class="modal-content" style="max-width:600px;">
            <span class="modal-close" onclick="closeModal('query-tools')">&times;</span>
            <h2>环境与 IP 检测</h2>
            <div class="modal-grid" style="grid-template-columns: 1fr;">
                <a href="https://zh.wikipedia.org/wiki/ISO_3166-1" target="_blank" class="link-card"><i class="fas fa-globe"></i> 国家代码查询</a>
                <a href="https://fofa.info" target="_blank" class="link-card"><i class="fas fa-satellite-dish"></i> FOFA网络空间搜索</a>
                <a href="https://ipinfo.io" target="_blank" class="link-card"><i class="fas fa-map-marker-alt"></i> IPInfo.io 详情</a>
                <a href="https://ping0.cc/" target="_blank" class="link-card"><i class="fas fa-map"></i> Ping0.cc IP检测</a>
                <a href="https://whoer.net/zh" target="_blank" class="link-card"><i class="fas fa-user-secret"></i> Whoer 匿名度评估</a>
                <a href="https://scamalytics.com/ip/" target="_blank" class="link-card"><i class="fas fa-shield-alt"></i> Scamalytics 欺诈值</a>
                <a href="https://ping.pe/" target="_blank" class="link-card"><i class="fas fa-network-wired"></i> Ping.pe 被墙检测</a>
                <a href="https://tools.ipip.net/traceroute.php" target="_blank" class="link-card"><i class="fas fa-route"></i> 路由追踪</a>
                <a href="https://ipleak.net/" target="_blank" class="link-card"><i class="fas fa-tint"></i> DNS泄漏查询</a>
            </div>
        </div>
    </div>

    <script>
        /* ================= Supabase 认证系统 (REST API 版本) ================= */
        const SUPABASE_URL = 'https://qzpvogxvlescfwpqahsn.supabase.co';
        const SUPABASE_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InF6cHZvZ3h2bGVzY2Z3cHFhaHNuIiwicm9sZSI6ImFub24iLCJpYXQiOjE3Njc5MzMyMzMsImV4cCI6MjA4MzUwOTIzM30.2uadJyp_KJNxRuFm1NIkuRPrTzq0-lBfuH3gb20LXGc';
        
        // 站长邮箱
        const ADMIN_EMAIL = 'terminos888@gmail.com';
        const ADMIN_UUID = '71c4e4e1-a1b6-47f8-aaa8-c62ae020e1eb';
        
        // 留言系统变量
        var currentChannel = 'public';
        var messagesData = [];
        var currentPage = 0;
        var pageSize = 10;
        var hasMoreMessages = true;
        var replyToId = null;
        var replyToName = '';
        var selectedTag = null;
        var isRefreshing = false;
        var pendingMessageImage = null; // 待发送的图片URL
        
        // Token 刷新函数
        function refreshAccessToken() {
            return new Promise(function(resolve, reject) {
                var refreshToken = localStorage.getItem('nexus_refresh_token');
                if (!refreshToken) {
                    reject(new Error('No refresh token'));
                    return;
                }
                
                if (isRefreshing) {
                    // 如果正在刷新，等待一下再试
                    setTimeout(function() { resolve(); }, 1000);
                    return;
                }
                
                isRefreshing = true;
                
                fetch(SUPABASE_URL + '/auth/v1/token?grant_type=refresh_token', {
                    method: 'POST',
                    headers: {
                        'apikey': SUPABASE_KEY,
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({
                        refresh_token: refreshToken
                    })
                })
                .then(function(response) {
                    if (!response.ok) {
                        throw new Error('Refresh failed');
                    }
                    return response.json();
                })
                .then(function(data) {
                    if (data.access_token) {
                        localStorage.setItem('nexus_access_token', data.access_token);
                        localStorage.setItem('nexus_refresh_token', data.refresh_token);
                        localStorage.setItem('nexus_user', JSON.stringify(data.user));
                        currentUser = data.user;
                        console.log('Token 刷新成功');
                        resolve(data.access_token);
                    } else {
                        throw new Error('No access token in response');
                    }
                })
                .catch(function(error) {
                    console.error('Token 刷新失败:', error);
                    // 刷新失败，清除登录状态
                    handleLogout();
                    reject(error);
                })
                .finally(function() {
                    isRefreshing = false;
                });
            });
        }
        
        // 带自动刷新的 fetch 封装
        function fetchWithAuth(url, options) {
            var accessToken = localStorage.getItem('nexus_access_token');
            
            if (!options) options = {};
            if (!options.headers) options.headers = {};
            
            options.headers['apikey'] = SUPABASE_KEY;
            options.headers['Authorization'] = 'Bearer ' + (accessToken || SUPABASE_KEY);
            
            return fetch(url, options).then(function(response) {
                if (response.status === 401 && accessToken) {
                    // Token 过期，尝试刷新
                    return refreshAccessToken().then(function(newToken) {
                        options.headers['Authorization'] = 'Bearer ' + newToken;
                        return fetch(url, options);
                    });
                }
                return response;
            });
        }
        
        // 页面加载时检查并刷新 token
        function checkAndRefreshToken() {
            var accessToken = localStorage.getItem('nexus_access_token');
            var refreshToken = localStorage.getItem('nexus_refresh_token');
            
            if (accessToken && refreshToken) {
                // 尝试用当前 token 获取用户信息
                fetch(SUPABASE_URL + '/auth/v1/user', {
                    method: 'GET',
                    headers: {
                        'apikey': SUPABASE_KEY,
                        'Authorization': 'Bearer ' + accessToken
                    }
                })
                .then(function(response) {
                    if (response.status === 401) {
                        // Token 过期，刷新
                        return refreshAccessToken();
                    }
                    return response.json();
                })
                .then(function(data) {
                    if (data && data.id) {
                        currentUser = data;
                        localStorage.setItem('nexus_user', JSON.stringify(data));
                        updateAuthUI(true);
                    }
                })
                .catch(function(error) {
                    console.error('Token 验证失败:', error);
                });
            }
        }
        
        // 随机昵称生成器
        var nicknameAdjectives = ['快乐', '神秘', '赛博', '星际', '暗夜', '闪电', '量子', '幻影', '极光', '烈焰', '冰霜', '雷霆', '风暴', '梦幻', '自由', '无畏', '光速', '深空', '迷雾', '破晓'];
        var nicknameNouns = ['星球', '旅人', '水手', '骑士', '猎人', '行者', '使者', '守望', '飞鸟', '游侠', '精灵', '战士', '探索', '漫步', '流浪', '追风', '逐梦', '先锋', '领航', '开拓'];
        
        function generateRandomNickname() {
            var adj = nicknameAdjectives[Math.floor(Math.random() * nicknameAdjectives.length)];
            var noun = nicknameNouns[Math.floor(Math.random() * nicknameNouns.length)];
            var num = Math.floor(Math.random() * 9000) + 1000; // 1000-9999
            return adj + noun + num;
        }
        
        // 检查昵称是否已存在
        function checkNicknameExists(nickname) {
            return fetch(SUPABASE_URL + '/rest/v1/profiles?full_name=eq.' + encodeURIComponent(nickname) + '&select=id', {
                method: 'GET',
                headers: {
                    'apikey': SUPABASE_KEY,
                    'Authorization': 'Bearer ' + SUPABASE_KEY
                }
            })
            .then(function(response) {
                return response.json();
            })
            .then(function(data) {
                return data && data.length > 0; // true = 已存在
            })
            .catch(function() {
                return false;
            });
        }
        
        // 生成唯一昵称（如果重复就重新生成）
        function generateUniqueNickname() {
            return new Promise(function(resolve) {
                var tryGenerate = function(attempts) {
                    if (attempts > 10) {
                        // 超过10次，加时间戳确保唯一
                        resolve('用户' + Date.now());
                        return;
                    }
                    var nickname = generateRandomNickname();
                    checkNicknameExists(nickname).then(function(exists) {
                        if (exists) {
                            tryGenerate(attempts + 1);
                        } else {
                            resolve(nickname);
                        }
                    });
                };
                tryGenerate(0);
            });
        }
        
        // 当前用户状态
        let currentUser = null;
        
        // 页面加载时检查登录状态
        document.addEventListener('DOMContentLoaded', function() {
            checkLoginStatus();
        });
        
        // 检查登录状态
        function checkLoginStatus() {
            const userData = localStorage.getItem('nexus_user');
            const accessToken = localStorage.getItem('nexus_access_token');
            const refreshToken = localStorage.getItem('nexus_refresh_token');
            
            if (userData && accessToken) {
                try {
                    currentUser = JSON.parse(userData);
                    updateAuthUI(true);
                    
                    // 后台验证token有效性并获取最新用户数据
                    fetchLatestUserData(accessToken);
                } catch (e) {
                    clearAuthData();
                    updateAuthUI(false);
                }
            } else if (refreshToken) {
                // 有refresh token但没有access token，尝试刷新
                refreshAccessToken().then(function() {
                    updateAuthUI(true);
                }).catch(function() {
                    clearAuthData();
                    updateAuthUI(false);
                });
            } else {
                updateAuthUI(false);
            }
        }
        
        // 获取最新用户数据
        function fetchLatestUserData(accessToken) {
            fetch(SUPABASE_URL + '/auth/v1/user', {
                method: 'GET',
                headers: {
                    'apikey': SUPABASE_KEY,
                    'Authorization': 'Bearer ' + accessToken
                }
            })
            .then(function(response) {
                if (response.status === 401) {
                    // Token过期，尝试刷新
                    return refreshAccessToken().then(function() {
                        updateAuthUI(true);
                    });
                }
                return response.json();
            })
            .then(function(data) {
                if (data && data.id) {
                    currentUser = data;
                    localStorage.setItem('nexus_user', JSON.stringify(data));
                    updateAuthUI(true);
                }
            })
            .catch(function(error) {
                console.error('获取用户数据失败:', error);
            });
        }
        
        // 清除认证数据
        function clearAuthData() {
            localStorage.removeItem('nexus_user');
            localStorage.removeItem('nexus_access_token');
            localStorage.removeItem('nexus_refresh_token');
            currentUser = null;
        }
        
        // 更新认证UI
        function updateAuthUI(isLoggedIn) {
            var authBtns = document.getElementById('authBtnsContainer');
            var userInfo = document.getElementById('userInfoContainer');
            
            if (isLoggedIn && currentUser) {
                authBtns.style.display = 'none';
                userInfo.style.display = 'block';
                
                // 从 profiles 表获取最新的用户资料（包括头像）
                fetchLatestProfile(currentUser.id);
                
                // 先用 user_metadata 显示，等 profiles 加载完会更新
                var avatar = document.getElementById('userAvatar');
                var userName = document.getElementById('userName');
                
                var displayName = '用户';
                var displayAvatar = '👤';
                
                if (currentUser.user_metadata) {
                    if (currentUser.user_metadata.full_name) {
                        displayName = currentUser.user_metadata.full_name;
                    }
                    if (currentUser.user_metadata.avatar) {
                        displayAvatar = currentUser.user_metadata.avatar;
                    }
                }
                
                if (displayName === '用户' && currentUser.email) {
                    displayName = currentUser.email.split('@')[0];
                }
                
                avatar.textContent = displayAvatar;
                userName.textContent = displayName;
            } else {
                authBtns.style.display = 'flex';
                userInfo.style.display = 'none';
            }
        }
        
        // 从 profiles 表获取最新用户资料
        function fetchLatestProfile(userId) {
            fetch(SUPABASE_URL + '/rest/v1/profiles?id=eq.' + userId + '&select=full_name,avatar_url', {
                method: 'GET',
                headers: {
                    'apikey': SUPABASE_KEY
                }
            })
            .then(function(res) { return res.json(); })
            .then(function(data) {
                if (data && data.length > 0) {
                    var profile = data[0];
                    console.log('从profiles获取的资料:', profile);
                    
                    // 更新 currentUser 的 user_metadata
                    if (!currentUser.user_metadata) {
                        currentUser.user_metadata = {};
                    }
                    if (profile.full_name) {
                        currentUser.user_metadata.full_name = profile.full_name;
                    }
                    if (profile.avatar_url) {
                        currentUser.user_metadata.avatar_url = profile.avatar_url;
                    }
                    
                    // 更新localStorage
                    localStorage.setItem('nexus_user', JSON.stringify(currentUser));
                    
                    // 更新界面显示
                    var avatar = document.getElementById('userAvatar');
                    var userName = document.getElementById('userName');
                    
                    if (profile.avatar_url) {
                        var imgUrl = profile.avatar_url + '?t=' + Date.now();
                        avatar.innerHTML = '<img src="' + imgUrl + '" alt="头像">';
                    }
                    if (profile.full_name) {
                        userName.textContent = profile.full_name;
                    }
                }
            })
            .catch(function(err) {
                console.error('获取用户资料失败:', err);
            });
        }
        
        // 显示消息提示
        function showMessage(text, type) {
            type = type || 'info';
            const toast = document.getElementById('messageToast');
            const iconMap = {
                success: 'check-circle',
                error: 'exclamation-circle',
                warning: 'exclamation-triangle',
                info: 'info-circle'
            };
            toast.innerHTML = '<i class="fas fa-' + (iconMap[type] || 'info-circle') + '"></i> ' + text;
            toast.className = 'message-toast ' + type;
            
            setTimeout(function() { toast.classList.add('show'); }, 10);
            setTimeout(function() { toast.classList.remove('show'); }, 3500);
        }
        
        // 打开认证弹窗
        function openAuthModal(type) {
            var modalId = type + '-modal';
            var modal = document.getElementById(modalId);
            if (modal) {
                modal.classList.add('visible');
                document.body.classList.add('modal-open');
            }
        }
        
        // 关闭认证弹窗
        function closeAuthModal(type) {
            var modalId = type + '-modal';
            var modal = document.getElementById(modalId);
            if (modal) {
                modal.classList.remove('visible');
                if (document.querySelectorAll('.modal-overlay.visible').length === 0) {
                    document.body.classList.remove('modal-open');
                }
            }
        }
        
        // 切换密码可见性
        function togglePassword(inputId, icon) {
            var input = document.getElementById(inputId);
            if (input.type === 'password') {
                input.type = 'text';
                icon.classList.remove('fa-eye');
                icon.classList.add('fa-eye-slash');
            } else {
                input.type = 'password';
                icon.classList.remove('fa-eye-slash');
                icon.classList.add('fa-eye');
            }
        }
        
        // 密码强度检测
        function checkPasswordStrength(password) {
            var bar1 = document.getElementById('strengthBar1');
            var bar2 = document.getElementById('strengthBar2');
            var bar3 = document.getElementById('strengthBar3');
            var text = document.getElementById('strengthText');
            
            bar1.className = 'strength-bar';
            bar2.className = 'strength-bar';
            bar3.className = 'strength-bar';
            
            if (!password) {
                text.textContent = '';
                return;
            }
            
            var strength = 0;
            if (password.length >= 6) strength++;
            if (password.length >= 10) strength++;
            if (/\d/.test(password)) strength++;
            if (/[a-zA-Z]/.test(password)) strength++;
            if (/[!@#$%^&*(),.?":{}|<>]/.test(password)) strength++;
            if (/[a-z]/.test(password) && /[A-Z]/.test(password)) strength++;
            
            if (strength <= 2) {
                bar1.classList.add('weak');
                text.textContent = '密码强度：弱';
                text.style.color = '#ff4757';
            } else if (strength <= 4) {
                bar1.classList.add('medium');
                bar2.classList.add('medium');
                text.textContent = '密码强度：中';
                text.style.color = '#ffd700';
            } else {
                bar1.classList.add('strong');
                bar2.classList.add('strong');
                bar3.classList.add('strong');
                text.textContent = '密码强度：强';
                text.style.color = '#00ff88';
            }
        }
        
        // 表单验证
        function validateEmail(email) {
            return /^[^\s@]+@[^\s@]+\.[^\s@]+$/.test(email);
        }
        
        function validatePhone(phone) {
            if (!phone) return true;
            return /^1[3-9]\d{9}$/.test(phone);
        }
        
        function setFieldError(groupId, hasError) {
            var group = document.getElementById(groupId);
            if (hasError) {
                group.classList.add('error');
            } else {
                group.classList.remove('error');
            }
        }
        
        // 切换到注册
        function switchToRegister() {
            closeAuthModal('login');
            setTimeout(function() { 
                openAuthModal('register');
                // 自动生成一个随机昵称
                fillRandomNickname();
            }, 200);
        }
        
        // 填充随机昵称
        function fillRandomNickname() {
            var input = document.getElementById('registerName');
            var btn = event ? event.target.closest('button') : null;
            if (btn) {
                btn.disabled = true;
                btn.innerHTML = '<i class="fas fa-spinner fa-spin"></i>';
            }
            
            generateUniqueNickname().then(function(nickname) {
                input.value = nickname;
                if (btn) {
                    btn.disabled = false;
                    btn.innerHTML = '<i class="fas fa-dice"></i> 随机';
                }
            });
        }
        
        // 切换到登录
        function switchToLogin() {
            closeAuthModal('register');
            setTimeout(function() { openAuthModal('login'); }, 200);
        }
        
        // 设置按钮加载状态
        function setButtonLoading(btnId, loading) {
            var btn = document.getElementById(btnId);
            if (loading) {
                btn.classList.add('loading');
                btn.disabled = true;
            } else {
                btn.classList.remove('loading');
                btn.disabled = false;
            }
        }
        
        // 登录处理 - 使用 Supabase Auth REST API
        function handleLogin() {
            var email = document.getElementById('loginEmail').value.trim();
            var password = document.getElementById('loginPassword').value;
            
            // 验证
            var hasError = false;
            
            if (!validateEmail(email)) {
                setFieldError('loginEmailGroup', true);
                hasError = true;
            } else {
                setFieldError('loginEmailGroup', false);
            }
            
            if (!password) {
                setFieldError('loginPasswordGroup', true);
                hasError = true;
            } else {
                setFieldError('loginPasswordGroup', false);
            }
            
            if (hasError) {
                showMessage('请检查输入信息', 'error');
                return;
            }
            
            setButtonLoading('loginSubmitBtn', true);
            
            // 调用 Supabase Auth API
            fetch(SUPABASE_URL + '/auth/v1/token?grant_type=password', {
                method: 'POST',
                headers: {
                    'apikey': SUPABASE_KEY,
                    'Content-Type': 'application/json'
                },
                body: JSON.stringify({
                    email: email,
                    password: password
                })
            })
            .then(function(response) {
                return response.json().then(function(data) {
                    return { ok: response.ok, data: data };
                });
            })
            .then(function(result) {
                if (!result.ok) {
                    var errorMsg = result.data.error_description || result.data.msg || result.data.message || '登录失败';
                    
                    // 更友好的错误提示
                    if (errorMsg.includes('Invalid login credentials')) {
                        showMessage('账号不存在或密码错误，请检查后重试', 'error');
                    } else if (errorMsg.includes('Email not confirmed')) {
                        showMessage('请先验证您的邮箱后再登录', 'warning');
                    } else if (errorMsg.includes('Too many requests') || errorMsg.includes('rate limit')) {
                        showMessage('操作过于频繁，请1分钟后再试', 'warning');
                    } else if (errorMsg.includes('network') || errorMsg.includes('fetch')) {
                        showMessage('网络连接失败，请检查网络后重试', 'error');
                    } else {
                        showMessage('登录失败: ' + errorMsg, 'error');
                    }
                    setButtonLoading('loginSubmitBtn', false);
                    return;
                }
                
                // 登录成功
                currentUser = result.data.user;
                localStorage.setItem('nexus_user', JSON.stringify(result.data.user));
                localStorage.setItem('nexus_access_token', result.data.access_token);
                localStorage.setItem('nexus_refresh_token', result.data.refresh_token);
                
                showMessage('登录成功！欢迎回来', 'success');
                updateAuthUI(true);
                
                setTimeout(function() {
                    closeAuthModal('login');
                    setButtonLoading('loginSubmitBtn', false);
                    document.getElementById('loginEmail').value = '';
                    document.getElementById('loginPassword').value = '';
                }, 1000);
            })
            .catch(function(error) {
                console.error('登录错误:', error);
                showMessage('网络连接失败，请检查网络后重试', 'error');
                setButtonLoading('loginSubmitBtn', false);
            });
        }
        
        // 注册头像相关变量
        var registerAvatarUrl = null;  // 存储已上传的头像URL
        var isUploadingAvatar = false; // 是否正在上传
        
        // 预览并上传注册头像
        function previewRegisterAvatar(input) {
            if (input.files && input.files[0]) {
                var file = input.files[0];
                
                // 验证文件
                if (!file.type.startsWith('image/')) {
                    showMessage('请选择图片文件', 'error');
                    return;
                }
                if (file.size > 2 * 1024 * 1024) {
                    showMessage('图片大小不能超过2MB', 'error');
                    return;
                }
                
                // 先显示预览
                var reader = new FileReader();
                reader.onload = function(e) {
                    document.getElementById('registerAvatarPreview').innerHTML = '<img src="' + e.target.result + '" style="width:100%;height:100%;object-fit:cover;">';
                    document.getElementById('removeRegisterAvatarBtn').style.display = 'inline-block';
                };
                reader.readAsDataURL(file);
                
                // 立即上传头像
                uploadRegisterAvatarNow(file);
            }
        }
        
        // 立即上传头像
        function uploadRegisterAvatarNow(file) {
            isUploadingAvatar = true;
            var btn = document.getElementById('registerSubmitBtn');
            btn.disabled = true;
            btn.querySelector('.btn-text').textContent = '头像上传中...';
            
            var ext = file.name.split('.').pop();
            var filename = 'reg_' + Date.now() + '_' + Math.random().toString(36).substr(2, 9) + '.' + ext;
            
            fetch(SUPABASE_URL + '/storage/v1/object/avatars/' + filename, {
                method: 'POST',
                headers: {
                    'apikey': SUPABASE_KEY,
                    'Authorization': 'Bearer ' + SUPABASE_KEY,
                    'Content-Type': file.type
                },
                body: file
            })
            .then(function(res) {
                if (!res.ok) throw new Error('上传失败');
                registerAvatarUrl = SUPABASE_URL + '/storage/v1/object/public/avatars/' + filename;
                showMessage('头像上传成功', 'success');
            })
            .catch(function(err) {
                console.error('头像上传失败:', err);
                showMessage('头像上传失败，请重试', 'error');
                registerAvatarUrl = null;
            })
            .finally(function() {
                isUploadingAvatar = false;
                btn.disabled = false;
                btn.querySelector('.btn-text').textContent = '注 册';
            });
        }
        
        // 移除注册头像
        function removeRegisterAvatar() {
            registerAvatarUrl = null;
            document.getElementById('registerAvatarPreview').innerHTML = '👤';
            document.getElementById('registerAvatarInput').value = '';
            document.getElementById('removeRegisterAvatarBtn').style.display = 'none';
        }
        
        // 注册处理 - 使用 Supabase Auth REST API
        function handleRegister() {
            var name = document.getElementById('registerName').value.trim();
            var email = document.getElementById('registerEmail').value.trim();
            var phone = document.getElementById('registerPhone').value.trim();
            var password = document.getElementById('registerPassword').value;
            var confirmPassword = document.getElementById('registerConfirm').value;
            
            // 验证
            var hasError = false;
            
            if (name.length < 2 || name.length > 20) {
                setFieldError('registerNameGroup', true);
                hasError = true;
            } else {
                setFieldError('registerNameGroup', false);
            }
            
            if (!validateEmail(email)) {
                setFieldError('registerEmailGroup', true);
                hasError = true;
            } else {
                setFieldError('registerEmailGroup', false);
            }
            
            if (!phone || !validatePhone(phone)) {
                setFieldError('registerPhoneGroup', true);
                hasError = true;
            } else {
                setFieldError('registerPhoneGroup', false);
            }
            
            if (password.length < 6) {
                setFieldError('registerPasswordGroup', true);
                hasError = true;
            } else {
                setFieldError('registerPasswordGroup', false);
            }
            
            if (password !== confirmPassword) {
                setFieldError('registerConfirmGroup', true);
                hasError = true;
            } else {
                setFieldError('registerConfirmGroup', false);
            }
            
            if (hasError) {
                showMessage('请检查输入信息', 'error');
                return;
            }
            
            setButtonLoading('registerSubmitBtn', true);
            
            // 先检查昵称是否已存在
            checkNicknameExists(name).then(function(exists) {
                if (exists) {
                    showMessage('该昵称已被使用，请换一个或点击随机生成', 'warning');
                    setFieldError('registerNameGroup', true);
                    setButtonLoading('registerSubmitBtn', false);
                    return;
                }
                
                // 昵称可用，继续注册
                doRegister(name, email, phone, password);
            }).catch(function() {
                // 检查失败，仍然尝试注册
                doRegister(name, email, phone, password);
            });
        }
        
        // 执行注册
        function doRegister(name, email, phone, password) {
            // 检查是否正在上传头像
            if (isUploadingAvatar) {
                showMessage('请等待头像上传完成', 'warning');
                setButtonLoading('registerSubmitBtn', false);
                return;
            }
            
            // 直接使用已上传的头像URL
            doRegisterWithAvatar(name, email, phone, password, registerAvatarUrl);
        }
        
        // 带头像URL的注册
        function doRegisterWithAvatar(name, email, phone, password, avatarUrl) {
            // 调用 Supabase Auth API 注册
            fetch(SUPABASE_URL + '/auth/v1/signup', {
                method: 'POST',
                headers: {
                    'apikey': SUPABASE_KEY,
                    'Content-Type': 'application/json'
                },
                body: JSON.stringify({
                    email: email,
                    password: password,
                    data: {
                        full_name: name,
                        phone: phone,
                        avatar: '👤',
                        avatar_url: avatarUrl || null
                    }
                })
            })
            .then(function(response) {
                return response.json().then(function(data) {
                    return { ok: response.ok, status: response.status, data: data };
                });
            })
            .then(function(result) {
                if (!result.ok) {
                    var errorMsg = result.data.error_description || result.data.msg || result.data.message || '注册失败';
                    
                    if (errorMsg.includes('already registered') || errorMsg.includes('already been registered')) {
                        showMessage('该邮箱已被注册', 'warning');
                    } else if (errorMsg.includes('Password')) {
                        showMessage('密码不符合要求，请使用更强的密码', 'error');
                    } else {
                        showMessage(errorMsg, 'error');
                    }
                    setButtonLoading('registerSubmitBtn', false);
                    return;
                }
                
                // 注册成功，将用户信息写入 profiles 表（带头像）
                var userId = result.data.user ? result.data.user.id : null;
                if (userId) {
                    saveUserProfile(userId, name, email, phone, avatarUrl);
                }
                
                // 检查是否需要邮箱验证
                if (result.data.user && !result.data.session && !result.data.access_token) {
                    showMessage('注册成功！请检查邮箱完成验证后登录', 'success');
                } else if (result.data.access_token || result.data.session) {
                    // 直接登录成功
                    var userData = result.data.user;
                    var accessToken = result.data.access_token || (result.data.session && result.data.session.access_token);
                    var refreshToken = result.data.refresh_token || (result.data.session && result.data.session.refresh_token);
                    
                    currentUser = userData;
                    localStorage.setItem('nexus_user', JSON.stringify(userData));
                    localStorage.setItem('nexus_access_token', accessToken);
                    localStorage.setItem('nexus_refresh_token', refreshToken);
                    showMessage('注册成功！欢迎加入 NEXUS', 'success');
                    updateAuthUI(true);
                } else {
                    showMessage('注册成功！请登录', 'success');
                }
                
                setTimeout(function() {
                    closeAuthModal('register');
                    setButtonLoading('registerSubmitBtn', false);
                    document.getElementById('registerName').value = '';
                    document.getElementById('registerEmail').value = '';
                    document.getElementById('registerPhone').value = '';
                    document.getElementById('registerPassword').value = '';
                    document.getElementById('registerConfirm').value = '';
                    document.getElementById('strengthBar1').className = 'strength-bar';
                    document.getElementById('strengthBar2').className = 'strength-bar';
                    document.getElementById('strengthBar3').className = 'strength-bar';
                    document.getElementById('strengthText').textContent = '';
                    // 清理注册头像
                    removeRegisterAvatar();
                }, 1500);
            })
            .catch(function(error) {
                console.error('注册错误:', error);
                showMessage('注册失败: 网络错误，请稍后重试', 'error');
                setButtonLoading('registerSubmitBtn', false);
            });
        }
        
        // 保存用户资料到 profiles 表
        function saveUserProfile(userId, fullName, email, phone, avatarUrl) {
            var profileData = {
                id: userId,
                full_name: fullName,
                email_contact: email,
                phone_number: phone || null
            };
            
            if (avatarUrl) {
                profileData.avatar_url = avatarUrl;
            }
            
            fetch(SUPABASE_URL + '/rest/v1/profiles', {
                method: 'POST',
                headers: {
                    'apikey': SUPABASE_KEY,
                    'Authorization': 'Bearer ' + SUPABASE_KEY,
                    'Content-Type': 'application/json',
                    'Prefer': 'return=minimal'
                },
                body: JSON.stringify(profileData)
            })
            .then(function(response) {
                if (!response.ok) {
                    console.error('保存用户资料失败');
                }
            })
            .catch(function(error) {
                console.error('保存用户资料错误:', error);
            });
        }
        
        // 退出登录
        function handleLogout() {
            var accessToken = localStorage.getItem('nexus_access_token');
            
            if (accessToken) {
                fetch(SUPABASE_URL + '/auth/v1/logout', {
                    method: 'POST',
                    headers: {
                        'apikey': SUPABASE_KEY,
                        'Authorization': 'Bearer ' + accessToken
                    }
                }).catch(function() {});
            }
            
            clearAuthData();
            updateAuthUI(false);
            showMessage('已安全退出登录', 'info');
        }
        
        // 打开设置弹窗时填充当前用户信息
        function openSettingsModal() {
            if (!currentUser) {
                showMessage('请先登录', 'warning');
                return;
            }
            
            var displayName = '';
            var avatar = '👤';
            var phone = '';
            var avatarUrl = '';
            
            if (currentUser.user_metadata) {
                if (currentUser.user_metadata.full_name) {
                    displayName = currentUser.user_metadata.full_name;
                }
                if (currentUser.user_metadata.avatar) {
                    avatar = currentUser.user_metadata.avatar;
                }
                if (currentUser.user_metadata.avatar_url) {
                    avatarUrl = currentUser.user_metadata.avatar_url;
                }
                if (currentUser.user_metadata.phone) {
                    phone = currentUser.user_metadata.phone;
                }
            }
            
            if (!displayName && currentUser.email) {
                displayName = currentUser.email.split('@')[0];
            }
            
            document.getElementById('settingsName').value = displayName;
            document.getElementById('settingsEmail').value = currentUser.email || '';
            document.getElementById('settingsPhone').value = phone;
            
            // 设置头像预览
            var avatarPreview = document.getElementById('avatarPreview');
            if (avatarUrl) {
                avatarPreview.innerHTML = '<img src="' + avatarUrl + '" alt="头像">';
                avatarPreview.setAttribute('data-type', 'image');
                avatarPreview.setAttribute('data-url', avatarUrl);
            } else {
                avatarPreview.innerHTML = avatar;
                avatarPreview.setAttribute('data-type', 'emoji');
                avatarPreview.removeAttribute('data-url');
            }
            
            // 设置头像选中状态
            var avatarOptions = document.querySelectorAll('.avatar-option');
            avatarOptions.forEach(function(opt) {
                opt.classList.remove('selected');
                if (!avatarUrl && opt.getAttribute('data-avatar') === avatar) {
                    opt.classList.add('selected');
                }
            });
            
            openAuthModal('settings');
        }
        
        // 头像选择（emoji）
        function selectAvatar(element) {
            document.querySelectorAll('.avatar-option').forEach(function(opt) {
                opt.classList.remove('selected');
            });
            element.classList.add('selected');
            
            // 更新预览
            var avatar = element.getAttribute('data-avatar');
            var avatarPreview = document.getElementById('avatarPreview');
            avatarPreview.innerHTML = avatar;
            avatarPreview.setAttribute('data-type', 'emoji');
            avatarPreview.removeAttribute('data-url');
        }
        
        // 上传头像变量
        var uploadedAvatarUrl = null;
        
        // 处理头像上传
        function handleAvatarUpload(event) {
            var file = event.target.files[0];
            if (!file) return;
            
            // 检查文件类型
            if (!file.type.startsWith('image/')) {
                showMessage('请选择图片文件', 'error');
                return;
            }
            
            // 检查文件大小（最大2MB）
            if (file.size > 2 * 1024 * 1024) {
                showMessage('图片大小不能超过2MB', 'error');
                return;
            }
            
            // 显示上传中状态
            var avatarPreview = document.getElementById('avatarPreview');
            avatarPreview.innerHTML = '<i class="fas fa-spinner fa-spin" style="font-size:2rem;color:var(--primary);"></i>';
            
            // 读取文件并预览
            var reader = new FileReader();
            reader.onload = function(e) {
                // 先显示本地预览
                avatarPreview.innerHTML = '<img src="' + e.target.result + '" alt="头像">';
                avatarPreview.setAttribute('data-type', 'image');
                
                // 上传到 Supabase Storage
                uploadAvatarToStorage(file);
            };
            reader.readAsDataURL(file);
        }
        
        // 设置头像上传状态
        var isUploadingSettingsAvatar = false;
        
        // 上传头像到 Supabase Storage
        function uploadAvatarToStorage(file) {
            var accessToken = localStorage.getItem('nexus_access_token');
            if (!accessToken || !currentUser) {
                showMessage('请先登录', 'error');
                return;
            }
            
            // 禁用保存按钮
            isUploadingSettingsAvatar = true;
            var saveBtn = document.getElementById('settingsSubmitBtn');
            saveBtn.disabled = true;
            saveBtn.querySelector('.btn-text').textContent = '头像上传中...';
            
            // 获取旧头像URL（用于删除）
            var oldAvatarUrl = null;
            if (currentUser.user_metadata && currentUser.user_metadata.avatar_url) {
                oldAvatarUrl = currentUser.user_metadata.avatar_url;
            }
            
            // 使用用户ID作为文件名，每次上传覆盖旧文件
            var fileExt = file.name.split('.').pop().toLowerCase();
            var fileName = currentUser.id + '.' + fileExt;
            
            // 先删除可能存在的旧头像（不同扩展名）
            var deleteOldAvatar = Promise.resolve();
            if (oldAvatarUrl) {
                var oldFileName = oldAvatarUrl.split('/').pop();
                if (oldFileName && oldFileName !== fileName) {
                    deleteOldAvatar = fetch(SUPABASE_URL + '/storage/v1/object/avatars/' + oldFileName, {
                        method: 'DELETE',
                        headers: {
                            'apikey': SUPABASE_KEY,
                            'Authorization': 'Bearer ' + accessToken
                        }
                    }).catch(function() { /* 忽略删除失败 */ });
                }
            }
            
            deleteOldAvatar.then(function() {
                return fetch(SUPABASE_URL + '/storage/v1/object/avatars/' + fileName, {
                    method: 'POST',
                    headers: {
                        'apikey': SUPABASE_KEY,
                        'Authorization': 'Bearer ' + accessToken,
                        'Content-Type': file.type,
                        'x-upsert': 'true'
                    },
                    body: file
                });
            })
            .then(function(response) {
                if (!response.ok) {
                    return response.text().then(function(text) {
                        console.error('上传失败响应:', text);
                        throw new Error('上传失败: ' + text);
                    });
                }
                return response.json();
            })
            .then(function(data) {
                // 获取公开URL（添加时间戳防止缓存）
                uploadedAvatarUrl = SUPABASE_URL + '/storage/v1/object/public/avatars/' + fileName + '?t=' + Date.now();
                
                var avatarPreview = document.getElementById('avatarPreview');
                avatarPreview.setAttribute('data-url', uploadedAvatarUrl);
                avatarPreview.innerHTML = '<img src="' + uploadedAvatarUrl + '" alt="头像">';
                
                // 清除emoji选中状态
                document.querySelectorAll('.avatar-option').forEach(function(opt) {
                    opt.classList.remove('selected');
                });
                
                showMessage('头像上传成功，请点击保存', 'success');
            })
            .catch(function(error) {
                console.error('头像上传失败:', error);
                showMessage('头像上传失败: ' + error.message, 'error');
                
                // 恢复默认头像
                var avatarPreview = document.getElementById('avatarPreview');
                avatarPreview.innerHTML = '👤';
                avatarPreview.setAttribute('data-type', 'emoji');
            })
            .finally(function() {
                // 恢复保存按钮
                isUploadingSettingsAvatar = false;
                var saveBtn = document.getElementById('settingsSubmitBtn');
                saveBtn.disabled = false;
                saveBtn.querySelector('.btn-text').textContent = '保存修改';
            });
        }
        
        // 获取当前选中的头像
        function getSelectedAvatar() {
            var avatarPreview = document.getElementById('avatarPreview');
            var type = avatarPreview.getAttribute('data-type');
            
            if (type === 'image') {
                return { type: 'image', url: avatarPreview.getAttribute('data-url') };
            } else {
                var selected = document.querySelector('.avatar-option.selected');
                return { type: 'emoji', avatar: selected ? selected.getAttribute('data-avatar') : '👤' };
            }
        }
        
        // 修改用户资料
        function handleUpdateProfile() {
            var newName = document.getElementById('settingsName').value.trim();
            var newPhone = document.getElementById('settingsPhone').value.trim();
            var newAvatar = getSelectedAvatar();
            
            // 检查是否正在上传头像
            if (isUploadingSettingsAvatar) {
                showMessage('请等待头像上传完成', 'warning');
                return;
            }
            
            // 验证
            var hasError = false;
            
            if (newName.length < 2 || newName.length > 20) {
                setFieldError('settingsNameGroup', true);
                hasError = true;
            } else {
                setFieldError('settingsNameGroup', false);
            }
            
            if (newPhone && !validatePhone(newPhone)) {
                setFieldError('settingsPhoneGroup', true);
                hasError = true;
            } else {
                setFieldError('settingsPhoneGroup', false);
            }
            
            if (hasError) {
                showMessage('请检查输入信息', 'error');
                return;
            }
            
            var accessToken = localStorage.getItem('nexus_access_token');
            if (!accessToken) {
                showMessage('登录已过期，请重新登录', 'error');
                handleLogout();
                return;
            }
            
            setButtonLoading('settingsSubmitBtn', true);
            
            // 获取当前昵称
            var currentName = '';
            if (currentUser && currentUser.user_metadata && currentUser.user_metadata.full_name) {
                currentName = currentUser.user_metadata.full_name;
            }
            
            // 如果昵称改变了，检查唯一性
            if (newName !== currentName) {
                checkNicknameExists(newName).then(function(exists) {
                    if (exists) {
                        showMessage('该昵称已被使用，请换一个', 'warning');
                        setFieldError('settingsNameGroup', true);
                        setButtonLoading('settingsSubmitBtn', false);
                        return;
                    }
                    doUpdateProfile(newName, newPhone, newAvatar, accessToken);
                }).catch(function() {
                    doUpdateProfile(newName, newPhone, newAvatar, accessToken);
                });
            } else {
                doUpdateProfile(newName, newPhone, newAvatar, accessToken);
            }
        }
        
        // 执行更新资料
        function doUpdateProfile(newName, newPhone, newAvatar, accessToken) {
            // 处理头像数据
            var avatarEmoji = '👤';
            var avatarUrl = null;
            
            if (newAvatar.type === 'image') {
                avatarUrl = newAvatar.url;
            } else {
                avatarEmoji = newAvatar.avatar;
            }
            
            // 调用 Supabase Auth API 更新用户信息
            fetch(SUPABASE_URL + '/auth/v1/user', {
                method: 'PUT',
                headers: {
                    'apikey': SUPABASE_KEY,
                    'Authorization': 'Bearer ' + accessToken,
                    'Content-Type': 'application/json'
                },
                body: JSON.stringify({
                    data: {
                        full_name: newName,
                        avatar: avatarEmoji,
                        avatar_url: avatarUrl,
                        phone: newPhone
                    }
                })
            })
            .then(function(response) {
                return response.json().then(function(data) {
                    return { ok: response.ok, data: data };
                });
            })
            .then(function(result) {
                if (!result.ok) {
                    var errorMsg = result.data.error_description || result.data.msg || result.data.message || '更新失败';
                    if (errorMsg.includes('JWT') || errorMsg.includes('token') || errorMsg.includes('expired')) {
                        showMessage('登录已过期，请重新登录', 'error');
                        handleLogout();
                    } else if (errorMsg.includes('rate limit') || errorMsg.includes('Too many')) {
                        showMessage('操作过于频繁，请稍后再试', 'warning');
                    } else {
                        showMessage('更新失败: ' + errorMsg, 'error');
                    }
                    setButtonLoading('settingsSubmitBtn', false);
                    return;
                }
                
                // 更新本地存储的用户信息
                currentUser = result.data;
                localStorage.setItem('nexus_user', JSON.stringify(result.data));
                
                // 同步更新 profiles 表中的昵称
                if (currentUser && currentUser.id) {
                    updateProfilesTable(currentUser.id, newName, newPhone, avatarUrl);
                }
                
                showMessage('资料修改成功！', 'success');
                updateAuthUI(true);
                
                setTimeout(function() {
                    closeAuthModal('settings');
                    setButtonLoading('settingsSubmitBtn', false);
                }, 1000);
            })
            .catch(function(error) {
                console.error('更新资料错误:', error);
                showMessage('网络连接失败，请检查网络后重试', 'error');
                setButtonLoading('settingsSubmitBtn', false);
            });
        }
        
        // 更新 profiles 表（头像通过视图自动关联，无需更新 messages）
        function updateProfilesTable(userId, fullName, phone, avatarUrl) {
            var accessToken = localStorage.getItem('nexus_access_token');
            
            var updateData = {
                full_name: fullName,
                phone_number: phone || null
            };
            if (avatarUrl) {
                updateData.avatar_url = avatarUrl;
            }
            
            // 更新 profiles 表
            fetch(SUPABASE_URL + '/rest/v1/profiles?id=eq.' + userId, {
                method: 'PATCH',
                headers: {
                    'apikey': SUPABASE_KEY,
                    'Authorization': 'Bearer ' + accessToken,
                    'Content-Type': 'application/json',
                    'Prefer': 'return=minimal'
                },
                body: JSON.stringify(updateData)
            }).then(function() {
                console.log('profiles表更新成功');
            }).catch(function(error) {
                console.error('更新profiles表失败:', error);
            });
        }
        
        // 登录注册设置弹窗只能通过点击X关闭，不需要点击遮罩关闭

        /* ================= 1. 粒子背景逻辑 ================= */
        const canvas = document.getElementById('canvas');
        const ctx = canvas.getContext('2d');
        canvas.width = window.innerWidth; 
        canvas.height = window.innerHeight;
        
        let particles = [];
        const mouse = { x: null, y: null, radius: 250 };

        window.addEventListener('mousemove', (e) => { mouse.x = e.x; mouse.y = e.y; });
        
        class Particle {
            constructor() {
                this.x = Math.random() * canvas.width;
                this.y = Math.random() * canvas.height;
                this.size = Math.random() * 2 + 0.5;
                this.speedX = (Math.random() * 1.5 - 0.75);
                this.speedY = (Math.random() * 1.5 - 0.75);
            }
            update() {
                this.x += this.speedX; this.y += this.speedY;
                if(this.x > canvas.width || this.x < 0) this.speedX *= -1;
                if(this.y > canvas.height || this.y < 0) this.speedY *= -1;
                
                const dx = mouse.x - this.x; const dy = mouse.y - this.y;
                const distance = Math.sqrt(dx*dx + dy*dy);
                if(distance < mouse.radius) {
                    if (distance < 100) {
                         this.x -= dx/10; this.y -= dy/10;
                    }
                }
            }
            draw() {
                ctx.fillStyle = '#00f3ff'; ctx.beginPath();
                ctx.arc(this.x, this.y, this.size, 0, Math.PI * 2); ctx.fill();
            }
        }

        function initParticles() {
            particles = []; 
            let numberOfParticles = (canvas.width * canvas.height) / 8000; 
            for(let i=0; i<numberOfParticles; i++) particles.push(new Particle());
        }

        function animateParticles() {
            ctx.clearRect(0,0,canvas.width,canvas.height);
            particles.forEach(p => { p.update(); p.draw(); });
            connectParticles(); 
            requestAnimationFrame(animateParticles);
        }

        function connectParticles() {
            for(let a=0; a<particles.length; a++){
                for(let b=a; b<particles.length; b++){
                    const dx = particles[a].x - particles[b].x;
                    const dy = particles[a].y - particles[b].y;
                    const dist = Math.sqrt(dx*dx + dy*dy);
                    if(dist < 120) {
                        ctx.strokeStyle = `rgba(0, 243, 255, ${1 - dist/120})`;
                        ctx.lineWidth = 0.8; ctx.beginPath();
                        ctx.moveTo(particles[a].x, particles[a].y); ctx.lineTo(particles[b].x, particles[b].y);
                        ctx.stroke();
                    }
                }
            }
        }
        initParticles(); animateParticles();
        window.addEventListener('resize', () => { canvas.width = window.innerWidth; canvas.height = window.innerHeight; initParticles(); });

        /* ================= 3D 卡片悬浮特效 ================= */
        const cards = document.querySelectorAll('.holo-card');
        
        cards.forEach(card => {
            card.addEventListener('mousemove', (e) => {
                const rect = card.getBoundingClientRect();
                const x = e.clientX - rect.left;
                const y = e.clientY - rect.top;
                const centerX = rect.width / 2;
                const centerY = rect.height / 2;
                
                const rotateX = (centerY - y) / 10;
                const rotateY = (x - centerX) / 10;
                
                card.style.transform = `perspective(1000px) rotateX(${rotateX}deg) rotateY(${rotateY}deg) scale(1.02)`;
                card.style.borderColor = 'var(--primary)';
                card.style.zIndex = '10';
            });

            card.addEventListener('mouseleave', () => {
                card.style.transform = `perspective(1000px) rotateX(0) rotateY(0) scale(1)`;
                card.style.borderColor = 'var(--glass-border)';
                card.style.zIndex = '1';
            });
        });


        /* ================= 2. 音乐播放器 (纯手动模式) ================= */
        
        const playlist = [
            // 'https://pub-24a821a3b60e4e7c9e58082c112dec4f.r2.dev/-%E5%AD%A4%E7%8B%AC.mp3',
            // 'https://pub-24a821a3b60e4e7c9e58082c112dec4f.r2.dev/(%E9%BB%84%E6%98%8F).mp3',
            // 'https://pub-24a821a3b60e4e7c9e58082c112dec4f.r2.dev/%E6%89%93%E5%BC%80(%E3%81%A8).mp3',
            // 'https://pub-24a821a3b60e4e7c9e58082c112dec4f.r2.dev/%E6%BC%82%E6%B3%8A.mp3',
            // 'https://pub-24a821a3b60e4e7c9e58082c112dec4f.r2.dev/%E5%A4%B1%E6%84%8F-%E9%AB%98%E6%A2%A8%E5%BA%B7%E6%B2%BB.mp3',
            // 'https://pub-24a821a3b60e4e7c9e58082c112dec4f.r2.dev/%E5%86%8D%E4%B8%8D%E6%96%A9_%E7%99%BD(%E5%86%8D%E4%B8%8D%E6%96%A9%EF%BC%88%E3%82%82%E3%82%82%E3%81%A1%20%E3%82%B6%E3%83%96%E3%82%B6%EF%BC%89%20%EF%BC%86%20%E7%99%BD_%E3%83%8F%E3%82%AF_).mp3',
            // 'https://pub-24a821a3b60e4e7c9e58082c112dec4f.r2.dev/(%E5%8D%A1%E5%8D%A1%E8%A5%BF%E4%B8%8E%E5%B8%A6%E5%9C%9F).mp3',
            // 'https://pub-24a821a3b60e4e7c9e58082c112dec4f.r2.dev/563%E6%8F%92%E6%9B%B2.mp3',
            // 'https://pub-24a821a3b60e4e7c9e58082c112dec4f.r2.dev/%E7%AC%AC%E4%B8%83%E7%8F%AD.mp3',
            // 'https://pub-24a821a3b60e4e7c9e58082c112dec4f.r2.dev/%E8%90%BD%E8%91%89%E8%88%B9-%E9%AB%98%E6%A2%A8%E5%BA%B7%E6%B2%BB.mp3',
            // 'https://pub-24a821a3b60e4e7c9e58082c112dec4f.r2.dev/-%E8%96%84%E6%9A%AE.mp3',
            // 'https://pub-24a821a3b60e4e7c9e58082c112dec4f.r2.dev/-%20%E7%BA%A2%E8%8E%B2.mp3',
            // 'https://pub-24a821a3b60e4e7c9e58082c112dec4f.r2.dev/-%E5%A4%B1%E6%84%8F%20%E5%8A%A8%E6%BC%AB%E5%8E%9F%E5%A3%B0.mp3',
            // 'https://pub-24a821a3b60e4e7c9e58082c112dec4f.r2.dev/%E7%96%BE%E9%A3%8E%E4%BC%A0%20Ost2%20%E5%BD%A9%E9%9C%9E.mp3',
            'https://pub-24a821a3b60e4e7c9e58082c112dec4f.r2.dev/%E8%A4%AA%E9%BB%91%E7%B4%A0%20-%20%E6%A2%93%E6%B8%9D.mp3'
        ];
        
        let currentTrack = 0;
        const audio = document.getElementById('audioPlayer');
        const playBtn = document.getElementById('playBtn');
        const trackDisplay = document.getElementById('trackNameDisplay');
        const visualizer = document.getElementById('visualizer');
        let isPlaying = false; 

        function getFileName(url) {
            try { return decodeURIComponent(url.split('/').pop().replace('.mp3', '')); } catch(e){ return "Unknown"; }
        }

        function loadTrack(index) {
            currentTrack = (index + playlist.length) % playlist.length;
            audio.src = playlist[currentTrack];
            trackDisplay.textContent = getFileName(playlist[currentTrack]);
            
            // 只有当 isPlaying 为 true 时才自动播放（即用户已经开始播放了，切歌时才自动）
            if(isPlaying) {
                audio.play().catch(e => {
                    console.warn("Auto-play blocked or waiting for interaction");
                    isPlaying = false;
                    updateUI(false);
                });
            }
        }

        function togglePlay() {
            if(!audio.src) {
                loadTrack(currentTrack);
            }
            
            if(audio.paused) {
                audio.play().then(() => {
                    isPlaying = true;
                    updateUI(true);
                }).catch(err => {
                    console.error("Play failed:", err);
                });
            } else {
                audio.pause();
                isPlaying = false;
                updateUI(false);
            }
        }

        function updateUI(playing) {
            if(playing) {
                playBtn.innerHTML = '<i class="fas fa-pause"></i>';
                visualizer.classList.remove('music-paused');
            } else {
                playBtn.innerHTML = '<i class="fas fa-play"></i>';
                visualizer.classList.add('music-paused');
            }
        }

        function nextTrack() { 
            isPlaying = true; 
            loadTrack(currentTrack + 1); 
            updateUI(true); 
        }
        
        function prevTrack() { 
            isPlaying = true;
            loadTrack(currentTrack - 1); 
            updateUI(true); 
        }

        audio.addEventListener('ended', nextTrack);
        
        // 初始加载第一首歌，但不播放
        currentTrack = Math.floor(Math.random() * playlist.length);
        loadTrack(currentTrack);
        isPlaying = false;
        updateUI(false);

        /* ================= 3. 弹窗控制 ================= */
        function closeAllModals() {
            document.querySelectorAll('.modal-overlay').forEach(m => m.classList.remove('visible'));
            document.body.classList.remove('modal-open');
            if (document.activeElement instanceof HTMLElement) {
                document.activeElement.blur();
            }
        }

        // 跳转会员专区
        function goToVip() {
            window.location.href = 'vip.html';
        }

        function openModal(id) {
            closeAllModals();
            setTimeout(() => {
                const m = document.getElementById(id + '-modal');
                if(m) { 
                    m.classList.add('visible'); 
                    document.body.classList.add('modal-open'); 
                }
            }, 10);
        }

        function closeModal(id) {
            const m = document.getElementById(id + '-modal');
            if(m) { 
                m.classList.remove('visible'); 
                if (document.querySelectorAll('.modal-overlay.visible').length === 0) {
                    document.body.classList.remove('modal-open');
                }
            }
        }

        document.querySelectorAll('.modal-overlay').forEach(ov => {
            ov.addEventListener('click', (e) => { 
                // 登录、注册、设置弹窗只能通过X按钮关闭
                var modalId = ov.id;
                if (modalId === 'login-modal' || modalId === 'register-modal' || modalId === 'settings-modal') {
                    return; // 不处理点击遮罩关闭
                }
                if(e.target === ov) {
                    ov.classList.remove('visible'); 
                    document.body.classList.remove('modal-open');
                }
            });
        });

        document.addEventListener('keydown', function(event) {
            if (event.key === "Escape") {
                // ESC键也不关闭登录、注册、设置弹窗
                var loginModal = document.getElementById('login-modal');
                var registerModal = document.getElementById('register-modal');
                var settingsModal = document.getElementById('settings-modal');
                
                if ((loginModal && loginModal.classList.contains('visible')) ||
                    (registerModal && registerModal.classList.contains('visible')) ||
                    (settingsModal && settingsModal.classList.contains('visible'))) {
                    return; // 不处理ESC关闭
                }
                closeAllModals();
            }
        });

        /* ================= 通讯终端（留言系统） ================= */
        
        // 检查是否是站长
        function isAdmin() {
            return currentUser && (currentUser.id === ADMIN_UUID || currentUser.email === ADMIN_EMAIL);
        }
        
        // 切换频道
        var isLoadingChannel = false; // 防止重复加载
        
        function switchChannel(channel) {
            // 防止重复点击
            if (isLoadingChannel || currentChannel === channel) {
                return;
            }
            
            isLoadingChannel = true;
            currentChannel = channel;
            
            // 立即更新UI状态
            document.querySelectorAll('.comm-channel').forEach(function(btn) {
                btn.classList.remove('active');
                if (btn.dataset.channel === channel) {
                    btn.classList.add('active');
                }
            });
            
            // 显示加载中
            document.getElementById('messageList').innerHTML = '<div class="loading-messages"><i class="fas fa-spinner fa-spin"></i><span>正在切换频道...</span></div>';
            document.getElementById('loadMoreBtn').style.display = 'none';
            
            // 更新标题和描述
            var titleEl = document.getElementById('channelTitle');
            var descEl = document.getElementById('channelDesc');
            var inputArea = document.getElementById('messageInputArea');
            var tagSelector = document.getElementById('tagSelector');
            
            // 重置图片预览
            removeImage();
            
            if (channel === 'public') {
                titleEl.textContent = '公共频段 · PUBLIC CHANNEL';
                descEl.innerHTML = '<i class="fas fa-info-circle"></i> 因各平台限制严格、频繁封号，且私信无法留敏感内容。考虑到很多朋友没有TG/WhatsApp，站长特开放此留言区。有需求尽管留言，站长会通过注册手机联系你。';
                inputArea.style.display = 'block';
                tagSelector.style.display = 'flex';
                document.getElementById('loginHint').style.display = 'none';
                
                // 延迟加载，确保UI更新完成
                setTimeout(function() {
                    loadMessages();
                    isLoadingChannel = false;
                }, 100);
                
            } else if (channel === 'private') {
                titleEl.textContent = '加密信箱 · SECURE CHANNEL';
                if (isAdmin()) {
                    descEl.innerHTML = '<i class="fas fa-lock"></i> 私密通信频道，点击用户查看对话并回复。';
                } else {
                    descEl.innerHTML = '<i class="fas fa-lock"></i> 私密通信频道，只有你和站长可见。适合咨询敏感业务或私密问题。';
                }
                tagSelector.style.display = 'none';
                
                if (!currentUser) {
                    inputArea.style.display = 'none';
                    document.getElementById('messageList').innerHTML = '<div class="empty-messages"><i class="fas fa-lock"></i><p>请先登录后使用加密信箱</p></div>';
                    document.getElementById('loginHint').style.display = 'block';
                    isLoadingChannel = false;
                } else {
                    inputArea.style.display = 'block';
                    document.getElementById('loginHint').style.display = 'none';
                    setTimeout(function() {
                        loadDirectMessages();
                        isLoadingChannel = false;
                    }, 100);
                }
                
            } else if (channel === 'notice') {
                titleEl.textContent = '站务公告 · ANNOUNCEMENT';
                descEl.innerHTML = '<i class="fas fa-bullhorn"></i> 站长发布的重要通知和公告。';
                inputArea.style.display = isAdmin() ? 'block' : 'none';
                tagSelector.style.display = 'none';
                document.getElementById('loginHint').style.display = 'none';
                showMessage('公告功能开发中，敬请期待', 'info');
                document.getElementById('messageList').innerHTML = '<div class="empty-messages"><i class="fas fa-bullhorn"></i><p>暂无公告</p></div>';
                isLoadingChannel = false;
            }
        }
        
        // 选择标签
        function selectTag(btn) {
            var tag = btn.dataset.tag;
            
            if (btn.classList.contains('active')) {
                btn.classList.remove('active');
                selectedTag = null;
            } else {
                document.querySelectorAll('.tag-btn').forEach(function(b) {
                    b.classList.remove('active');
                });
                btn.classList.add('active');
                selectedTag = tag;
            }
        }
        
        // 字数统计
        document.getElementById('messageInput').addEventListener('input', function() {
            document.getElementById('charCount').textContent = this.value.length;
        });
        
        // 加载留言
        var loadMessagesRequestId = 0; // 请求ID，用于取消旧请求
        
        function loadMessages(append) {
            // 检查是否还在公共频道
            if (currentChannel !== 'public') {
                return;
            }
            
            var thisRequestId = ++loadMessagesRequestId;
            
            if (!append) {
                currentPage = 0;
                messagesData = [];
                document.getElementById('messageList').innerHTML = '<div class="loading-messages"><i class="fas fa-spinner fa-spin"></i><span>正在接收信号...</span></div>';
            }
            
            var offset = currentPage * pageSize;
            
            // 从视图读取，自动关联 profiles 表获取最新头像
            var queryUrl = SUPABASE_URL + '/rest/v1/messages_with_profile?parent_id=is.null&order=is_pinned.desc,created_at.desc&limit=' + pageSize + '&offset=' + offset;
            
            fetchWithAuth(queryUrl, { method: 'GET' })
            .then(function(response) {
                // 检查请求是否已过期
                if (thisRequestId !== loadMessagesRequestId || currentChannel !== 'public') {
                    throw new Error('请求已取消');
                }
                if (!response.ok) {
                    throw new Error('加载失败: ' + response.status);
                }
                return response.json();
            })
            .then(function(messages) {
                if (thisRequestId !== loadMessagesRequestId || currentChannel !== 'public') {
                    throw new Error('请求已取消');
                }
                
                if (!messages || !Array.isArray(messages)) {
                    messages = [];
                }
                
                if (!append) {
                    messagesData = messages;
                } else {
                    messagesData = messagesData.concat(messages);
                }
                
                hasMoreMessages = messages.length === pageSize;
                
                // 获取所有回复（也从视图读取以获取最新头像）
                if (messages.length > 0) {
                    var parentIds = messages.map(function(m) { return m.id; }).join(',');
                    return fetchWithAuth(SUPABASE_URL + '/rest/v1/messages_with_profile?parent_id=in.(' + parentIds + ')&order=created_at.asc', {
                        method: 'GET'
                    }).then(function(res) { return res.json(); });
                }
                return [];
            })
            .then(function(replies) {
                if (thisRequestId !== loadMessagesRequestId || currentChannel !== 'public') {
                    return; // 静默忽略
                }
                renderMessages(messagesData, replies || [], append);
            })
            .catch(function(error) {
                if (error.message === '请求已取消') {
                    return; // 静默忽略取消的请求
                }
                console.error('加载留言失败:', error);
                if (currentChannel === 'public') {
                    document.getElementById('messageList').innerHTML = '<div class="empty-messages"><i class="fas fa-exclamation-triangle"></i><p>信号中断，请刷新重试</p></div>';
                }
            });
        }
        
        // 渲染留言
        function renderMessages(messages, replies, append) {
            var container = document.getElementById('messageList');
            var loadMoreBtn = document.getElementById('loadMoreBtn');
            
            if (!append) {
                container.innerHTML = '';
            }
            
            if (messages.length === 0 && !append) {
                container.innerHTML = '<div class="empty-messages"><i class="fas fa-satellite-dish"></i><p>暂无情报，成为第一个发言的人吧</p></div>';
                loadMoreBtn.style.display = 'none';
                return;
            }
            
            // 按 parent_id 分组回复
            var repliesMap = {};
            if (replies && replies.length > 0) {
                replies.forEach(function(reply) {
                    if (!repliesMap[reply.parent_id]) {
                        repliesMap[reply.parent_id] = [];
                    }
                    repliesMap[reply.parent_id].push(reply);
                });
            }
            
            messages.forEach(function(msg) {
                var msgReplies = repliesMap[msg.id] || [];
                var html = createMessageHTML(msg, msgReplies);
                container.insertAdjacentHTML('beforeend', html);
            });
            
            loadMoreBtn.style.display = hasMoreMessages ? 'block' : 'none';
            
            // 更新分页信息
            var paginationInfo = document.getElementById('paginationInfo');
            var totalShown = messagesData.length;
            if (totalShown > 0) {
                paginationInfo.innerHTML = '已加载 ' + totalShown + ' 条留言' + (hasMoreMessages ? '' : ' · 已全部加载');
            } else {
                paginationInfo.innerHTML = '';
            }
        }
        
        // 创建单条消息HTML
        // 生成头像HTML（支持图片和emoji）
        function renderAvatar(avatarEmoji, avatarUrl, isAdmin, size) {
            size = size || 'normal'; // 'normal' 或 'small'
            var sizeStyle = size === 'small' ? ' style="width:32px;height:32px;font-size:1em;"' : '';
            var adminClass = isAdmin ? ' admin' : '';
            
            if (avatarUrl) {
                return '<div class="message-avatar' + adminClass + '"' + sizeStyle + '><img src="' + avatarUrl + '" alt="头像" style="width:100%;height:100%;object-fit:cover;border-radius:50%;"></div>';
            } else {
                return '<div class="message-avatar' + adminClass + '"' + sizeStyle + '>' + (avatarEmoji || '👤') + '</div>';
            }
        }
        
        function createMessageHTML(msg, replies) {
            var isAdminMsg = msg.is_admin;
            var isOwn = currentUser && currentUser.id === msg.user_id;
            var isPending = msg.status === 'pending';
            var isPinned = msg.is_pinned;
            
            var cardClass = 'message-card';
            if (isAdminMsg) cardClass += ' admin-message';
            if (isPending) cardClass += ' pending';
            if (isPinned) cardClass += ' pinned';
            
            var timeAgo = getTimeAgo(msg.created_at);
            
            var html = '<div class="' + cardClass + '" data-id="' + msg.id + '">';
            html += '<div class="message-header">';
            html += '<div class="message-user">';
            html += renderAvatar(msg.user_avatar, msg.avatar_url, isAdminMsg, 'normal');
            html += '<div class="message-info">';
            html += '<div class="message-name' + (isAdminMsg ? ' admin' : '') + '">' + escapeHtml(msg.user_name);
            if (isAdminMsg) html += '<span class="admin-badge">站长</span>';
            if (isPinned) html += '<span class="pinned-badge"><i class="fas fa-thumbtack"></i> 置顶</span>';
            html += '</div>';
            html += '<div class="message-meta">';
            html += '<span>' + timeAgo + '</span>';
            if (msg.tag) html += '<span class="message-tag">' + escapeHtml(msg.tag) + '</span>';
            if (isPending) html += '<span class="message-status"><i class="fas fa-clock"></i> 待审核</span>';
            html += '</div></div></div>';
            
            // 操作按钮
            html += '<div class="message-actions">';
            html += '<button onclick="replyTo(\'' + msg.id + '\', \'' + escapeHtml(msg.user_name) + '\')"><i class="fas fa-comment"></i> 回复</button>';
            if (isOwn || isAdmin()) {
                html += '<button class="delete" onclick="deleteMessage(\'' + msg.id + '\')"><i class="fas fa-trash"></i> 删除</button>';
            }
            if (isAdmin() && !isPinned) {
                html += '<button onclick="pinMessage(\'' + msg.id + '\')"><i class="fas fa-thumbtack"></i> 置顶</button>';
            }
            if (isAdmin() && isPending) {
                html += '<button onclick="approveMessage(\'' + msg.id + '\')"><i class="fas fa-check"></i> 通过</button>';
            }
            html += '</div></div>';
            
            // 内容
            html += '<div class="message-content">';
            if (msg.content) {
                html += escapeHtml(msg.content);
            }
            // 显示图片
            if (msg.image_url) {
                html += '<img class="message-image" src="' + msg.image_url + '" alt="图片" onclick="openLightbox(\'' + msg.image_url + '\')">';
            }
            html += '</div>';
            
            // 回复列表
            if (replies && replies.length > 0) {
                html += '<div class="message-replies">';
                replies.forEach(function(reply) {
                    var replyIsAdmin = reply.is_admin;
                    var replyIsOwn = currentUser && currentUser.id === reply.user_id;
                    var replyTimeAgo = getTimeAgo(reply.created_at);
                    
                    html += '<div class="reply-card' + (replyIsAdmin ? ' admin-message' : '') + '" data-id="' + reply.id + '">';
                    html += '<div class="message-header">';
                    html += '<div class="message-user">';
                    html += renderAvatar(reply.user_avatar, reply.avatar_url, replyIsAdmin, 'small');
                    html += '<div class="message-info">';
                    html += '<div class="message-name' + (replyIsAdmin ? ' admin' : '') + '">' + escapeHtml(reply.user_name);
                    if (replyIsAdmin) html += '<span class="admin-badge">站长</span>';
                    html += '</div>';
                    html += '<div class="message-meta"><span>' + replyTimeAgo + '</span>';
                    if (reply.status === 'pending') html += '<span class="message-status"><i class="fas fa-clock"></i> 待审核</span>';
                    html += '</div></div></div>';
                    html += '<div class="message-actions">';
                    html += '<button onclick="replyTo(\'' + reply.parent_id + '\', \'' + escapeHtml(reply.user_name) + '\')"><i class="fas fa-comment"></i> 回复</button>';
                    if (replyIsOwn || isAdmin()) {
                        html += '<button class="delete" onclick="deleteMessage(\'' + reply.id + '\')"><i class="fas fa-trash"></i> 删除</button>';
                    }
                    if (isAdmin() && reply.status === 'pending') {
                        html += '<button onclick="approveMessage(\'' + reply.id + '\')"><i class="fas fa-check"></i> 通过</button>';
                    }
                    html += '</div></div>';
                    html += '<div class="message-content"><span class="reply-to-hint">回复 @' + escapeHtml(msg.user_name) + '：</span>' + escapeHtml(reply.content);
                    if (reply.image_url) {
                        html += '<img class="message-image" src="' + reply.image_url + '" alt="图片" onclick="openLightbox(\'' + reply.image_url + '\')">';
                    }
                    html += '</div>';
                    html += '</div>';
                });
                html += '</div>';
            }
            
            html += '</div>';
            return html;
        }
        
        // 时间格式化
        function getTimeAgo(dateStr) {
            var date = new Date(dateStr);
            var now = new Date();
            var diff = Math.floor((now - date) / 1000);
            
            if (diff < 60) return '刚刚';
            if (diff < 3600) return Math.floor(diff / 60) + '分钟前';
            if (diff < 86400) return Math.floor(diff / 3600) + '小时前';
            if (diff < 604800) return Math.floor(diff / 86400) + '天前';
            
            return date.toLocaleDateString('zh-CN');
        }
        
        // HTML转义
        function escapeHtml(str) {
            if (!str) return '';
            return str.replace(/&/g, '&amp;').replace(/</g, '&lt;').replace(/>/g, '&gt;').replace(/"/g, '&quot;');
        }
        
        // 回复
        function replyTo(id, name) {
            if (!currentUser) {
                showMessage('请先登录后再回复', 'warning');
                openAuthModal('login');
                return;
            }
            
            replyToId = id;
            replyToName = name;
            
            document.getElementById('replyBar').style.display = 'flex';
            document.getElementById('replyToName').textContent = name;
            document.getElementById('messageInput').focus();
            document.getElementById('messageInput').placeholder = '回复 ' + name + '...';
        }
        
        // 取消回复
        function cancelReply() {
            replyToId = null;
            replyToName = '';
            document.getElementById('replyBar').style.display = 'none';
            document.getElementById('messageInput').placeholder = '输入情报...';
        }
        
        // 发布留言
        function submitMessage() {
            var content = document.getElementById('messageInput').value.trim();
            
            if (!currentUser) {
                showMessage('请先登录后再发布', 'warning');
                openAuthModal('login');
                return;
            }
            
            // 允许只发图片或只发文字
            if (!content && !pendingMessageImage) {
                showMessage('请输入内容或上传图片', 'warning');
                return;
            }
            
            if (content.length > 500) {
                showMessage('内容不能超过500字', 'warning');
                return;
            }
            
            var accessToken = localStorage.getItem('nexus_access_token');
            var isAdminUser = isAdmin();
            
            // 只存储必要字段，头像从 profiles 表关联获取
            var userName = '用户';
            if (currentUser.user_metadata && currentUser.user_metadata.full_name) {
                userName = currentUser.user_metadata.full_name;
            }
            
            var messageData = {
                user_id: currentUser.id,
                user_name: userName,
                content: content,
                image_url: pendingMessageImage || null,
                parent_id: replyToId || null,
                tag: replyToId ? null : selectedTag,
                status: 'approved',
                is_admin: isAdminUser
            };
            
            // 调试日志
            console.log('发送消息 - pendingMessageImage:', pendingMessageImage);
            console.log('发送消息 - messageData:', messageData);
            
            var btn = document.querySelector('.execute-btn');
            btn.disabled = true;
            btn.innerHTML = '<i class="fas fa-spinner fa-spin"></i> 发送中...';
            
            fetch(SUPABASE_URL + '/rest/v1/messages', {
                method: 'POST',
                headers: {
                    'apikey': SUPABASE_KEY,
                    'Authorization': 'Bearer ' + accessToken,
                    'Content-Type': 'application/json',
                    'Prefer': 'return=representation'
                },
                body: JSON.stringify(messageData)
            })
            .then(function(response) {
                if (!response.ok) {
                    throw new Error('发送失败');
                }
                return response.json();
            })
            .then(function(data) {
                document.getElementById('messageInput').value = '';
                document.getElementById('charCount').textContent = '0';
                cancelReply();
                removeImage(); // 清除图片
                
                // 清除选中的标签
                document.querySelectorAll('.tag-btn').forEach(function(b) {
                    b.classList.remove('active');
                });
                selectedTag = null;
                
                if (isAdminUser) {
                    showMessage('发送成功', 'success');
                } else {
                    showMessage('发送成功', 'success');
                }
                
                loadMessages();
            })
            .catch(function(error) {
                console.error('发送失败:', error);
                showMessage('发送失败，请重试', 'error');
            })
            .finally(function() {
                btn.disabled = false;
                btn.innerHTML = '<i class="fas fa-paper-plane"></i><span>执行 EXECUTE</span>';
            });
        }
        
        // 删除留言
        function deleteMessage(id) {
            if (!confirm('确定要删除这条留言吗？')) {
                return;
            }
            
            var accessToken = localStorage.getItem('nexus_access_token');
            
            fetch(SUPABASE_URL + '/rest/v1/messages?id=eq.' + id, {
                method: 'DELETE',
                headers: {
                    'apikey': SUPABASE_KEY,
                    'Authorization': 'Bearer ' + accessToken
                }
            })
            .then(function(response) {
                if (!response.ok) {
                    throw new Error('删除失败');
                }
                showMessage('删除成功', 'success');
                loadMessages();
            })
            .catch(function(error) {
                console.error('删除失败:', error);
                showMessage('删除失败', 'error');
            });
        }
        
        // 置顶留言（站长功能）
        function pinMessage(id) {
            if (!isAdmin()) return;
            
            var accessToken = localStorage.getItem('nexus_access_token');
            
            fetch(SUPABASE_URL + '/rest/v1/messages?id=eq.' + id, {
                method: 'PATCH',
                headers: {
                    'apikey': SUPABASE_KEY,
                    'Authorization': 'Bearer ' + accessToken,
                    'Content-Type': 'application/json'
                },
                body: JSON.stringify({ is_pinned: true })
            })
            .then(function(response) {
                if (!response.ok) {
                    throw new Error('操作失败');
                }
                showMessage('已置顶', 'success');
                loadMessages();
            })
            .catch(function(error) {
                console.error('置顶失败:', error);
                showMessage('操作失败', 'error');
            });
        }
        
        // 审核通过（站长功能）
        function approveMessage(id) {
            if (!isAdmin()) return;
            
            var accessToken = localStorage.getItem('nexus_access_token');
            
            fetch(SUPABASE_URL + '/rest/v1/messages?id=eq.' + id, {
                method: 'PATCH',
                headers: {
                    'apikey': SUPABASE_KEY,
                    'Authorization': 'Bearer ' + accessToken,
                    'Content-Type': 'application/json'
                },
                body: JSON.stringify({ status: 'approved' })
            })
            .then(function(response) {
                if (!response.ok) {
                    throw new Error('操作失败');
                }
                showMessage('已通过审核', 'success');
                loadMessages();
            })
            .catch(function(error) {
                console.error('审核失败:', error);
                showMessage('操作失败', 'error');
            });
        }
        
        // 加载更多
        function loadMoreMessages() {
            currentPage++;
            loadMessages(true);
        }
        
        /* ================= 加密信箱（私信功能） ================= */
        
        var dmData = [];
        var dmPage = 0;
        var hasMoreDM = true;
        var dmUserList = []; // 站长用：用户列表
        var currentDMUserId = null; // 当前对话的用户ID
        var currentDMUserName = ''; // 当前对话的用户名
        
        // 加载私信
        function loadDirectMessages(append) {
            if (!currentUser) return;
            
            // 检查是否还在私信频道
            if (currentChannel !== 'private') {
                return;
            }
            
            if (!append) {
                dmPage = 0;
                dmData = [];
                document.getElementById('messageList').innerHTML = '<div class="loading-messages"><i class="fas fa-spinner fa-spin"></i><span>正在解密通信...</span></div>';
            }
            
            var accessToken = localStorage.getItem('nexus_access_token');
            
            if (isAdmin()) {
                // 站长：显示用户列表
                loadDMUserList();
            } else {
                // 普通用户：显示与站长的对话
                loadDMConversation(ADMIN_UUID, '站长');
            }
        }
        
        // 站长端：加载私信用户列表
        function loadDMUserList() {
            var accessToken = localStorage.getItem('nexus_access_token');
            
            // 查询所有发给站长的私信，按用户分组
            fetch(SUPABASE_URL + '/rest/v1/direct_messages?receiver_id=eq.' + ADMIN_UUID + '&order=created_at.desc', {
                method: 'GET',
                headers: {
                    'apikey': SUPABASE_KEY,
                    'Authorization': 'Bearer ' + accessToken
                }
            })
            .then(function(response) { return response.json(); })
            .then(function(messages) {
                // 按发送者分组，获取最新消息
                var userMap = {};
                var unreadCount = 0;
                messages.forEach(function(msg) {
                    if (!userMap[msg.sender_id]) {
                        userMap[msg.sender_id] = {
                            user_id: msg.sender_id,
                            user_name: msg.sender_name,
                            user_avatar: msg.sender_avatar,
                            last_message: msg.content,
                            last_time: msg.created_at,
                            unread: msg.is_read ? 0 : 1
                        };
                    } else if (!msg.is_read) {
                        userMap[msg.sender_id].unread++;
                    }
                    if (!msg.is_read) unreadCount++;
                });
                
                dmUserList = Object.values(userMap);
                renderDMUserList(dmUserList);
                
                // 更新未读数
                updatePrivateBadge(unreadCount);
            })
            .catch(function(error) {
                console.error('加载用户列表失败:', error);
            });
        }
        
        // 渲染用户列表（站长视角）
        function renderDMUserList(users) {
            var container = document.getElementById('messageList');
            
            if (users.length === 0) {
                container.innerHTML = '<div class="empty-messages"><i class="fas fa-inbox"></i><p>暂无私信</p></div>';
                return;
            }
            
            var html = '<div class="dm-user-list">';
            users.forEach(function(user) {
                var timeStr = getTimeAgo(user.last_time);
                html += '<div class="dm-user-item" onclick="openDMConversation(\'' + user.user_id + '\', \'' + escapeHtml(user.user_name) + '\')">';
                html += '<div class="dm-user-avatar">' + (user.user_avatar || '👤') + '</div>';
                html += '<div class="dm-user-info">';
                html += '<div class="dm-user-name">' + escapeHtml(user.user_name);
                if (user.unread > 0) {
                    html += '<span class="dm-unread-badge">' + user.unread + '</span>';
                }
                html += '</div>';
                html += '<div class="dm-user-preview">' + escapeHtml(user.last_message.substring(0, 30)) + (user.last_message.length > 30 ? '...' : '') + '</div>';
                html += '</div>';
                html += '<div class="dm-user-time">' + timeStr + '</div>';
                html += '</div>';
            });
            html += '</div>';
            
            container.innerHTML = html;
            document.getElementById('loadMoreBtn').style.display = 'none';
        }
        
        // 打开与某用户的对话（站长用）
        function openDMConversation(userId, userName) {
            currentDMUserId = userId;
            currentDMUserName = userName;
            loadDMConversation(userId, userName);
            
            // 显示返回按钮和操作按钮（站长视角）
            var headerHtml = '<i class="fas fa-arrow-left" style="cursor:pointer;margin-right:10px;" onclick="backToDMList()"></i> 与 <strong>' + escapeHtml(userName) + '</strong> 的对话';
            
            if (isAdmin()) {
                headerHtml += '<button onclick="toggleUserMembership(\'' + userId + '\', \'' + escapeHtml(userName) + '\')" style="margin-left:15px;background:linear-gradient(135deg,#ffd700,#ff8c00);border:none;padding:5px 12px;border-radius:5px;color:#000;font-weight:bold;cursor:pointer;font-size:0.8em;"><i class="fas fa-crown"></i> 开通会员</button>';
            }
            
            document.getElementById('channelDesc').innerHTML = headerHtml;
        }
        
        // 返回用户列表
        function backToDMList() {
            currentDMUserId = null;
            currentDMUserName = '';
            document.getElementById('channelDesc').innerHTML = '<i class="fas fa-lock"></i> 私密通信频道，点击用户查看对话并回复。';
            loadDMUserList();
        }
        
        // 站长开通/取消用户会员
        function toggleUserMembership(userId, userName) {
            if (!isAdmin()) {
                showMessage('无权限操作', 'error');
                return;
            }
            
            var accessToken = localStorage.getItem('nexus_access_token');
            
            // 先查询用户当前会员状态
            fetch(SUPABASE_URL + '/rest/v1/user_memberships?user_id=eq.' + userId, {
                method: 'GET',
                headers: {
                    'apikey': SUPABASE_KEY,
                    'Authorization': 'Bearer ' + accessToken
                }
            })
            .then(function(res) { return res.json(); })
            .then(function(data) {
                var isPremium = data && data.length > 0 && data[0].membership_type === 'premium';
                var action = isPremium ? '取消' : '开通';
                
                if (!confirm(action + ' ' + userName + ' 的永久会员？')) {
                    return Promise.reject('cancelled');
                }
                
                if (isPremium) {
                    // 取消会员：更新为 free
                    return fetch(SUPABASE_URL + '/rest/v1/user_memberships?user_id=eq.' + userId, {
                        method: 'PATCH',
                        headers: {
                            'apikey': SUPABASE_KEY,
                            'Authorization': 'Bearer ' + accessToken,
                            'Content-Type': 'application/json'
                        },
                        body: JSON.stringify({
                            membership_type: 'free',
                            activated_at: null,
                            activated_by: null
                        })
                    }).then(function() { return '已取消 ' + userName + ' 的会员'; });
                } else {
                    // 开通会员：upsert
                    return fetch(SUPABASE_URL + '/rest/v1/user_memberships', {
                        method: 'POST',
                        headers: {
                            'apikey': SUPABASE_KEY,
                            'Authorization': 'Bearer ' + accessToken,
                            'Content-Type': 'application/json',
                            'Prefer': 'resolution=merge-duplicates'
                        },
                        body: JSON.stringify({
                            user_id: userId,
                            membership_type: 'premium',
                            activated_at: new Date().toISOString(),
                            activated_by: currentUser.id
                        })
                    }).then(function() { return '已为 ' + userName + ' 开通永久会员'; });
                }
            })
            .then(function(msg) {
                if (msg) showMessage(msg, 'success');
            })
            .catch(function(err) {
                if (err !== 'cancelled') {
                    console.error('操作失败:', err);
                    showMessage('操作失败', 'error');
                }
            });
        }
        
        // 加载与某用户的对话
        function loadDMConversation(targetUserId, targetUserName) {
            var accessToken = localStorage.getItem('nexus_access_token');
            var myId = currentUser.id;
            
            // 查询双方的消息
            var queryUrl = SUPABASE_URL + '/rest/v1/direct_messages?or=(and(sender_id.eq.' + myId + ',receiver_id.eq.' + targetUserId + '),and(sender_id.eq.' + targetUserId + ',receiver_id.eq.' + myId + '))&order=created_at.asc';
            
            fetch(queryUrl, {
                method: 'GET',
                headers: {
                    'apikey': SUPABASE_KEY,
                    'Authorization': 'Bearer ' + accessToken
                }
            })
            .then(function(response) { return response.json(); })
            .then(function(messages) {
                renderDMConversation(messages, targetUserName);
                
                // 标记为已读（不管是站长还是普通用户）
                markDMAsRead(targetUserId);
            })
            .catch(function(error) {
                console.error('加载对话失败:', error);
            });
        }
        
        // 渲染对话
        function renderDMConversation(messages, targetUserName) {
            var container = document.getElementById('messageList');
            
            if (messages.length === 0) {
                container.innerHTML = '<div class="empty-messages"><i class="fas fa-envelope-open"></i><p>暂无消息，发送第一条吧</p></div>';
                return;
            }
            
            var html = '<div class="dm-chat-container">';
            messages.forEach(function(msg) {
                var isMine = msg.sender_id === currentUser.id;
                var timeStr = getTimeAgo(msg.created_at);
                var senderName = isMine ? '我' : (msg.is_admin_sent ? '<span class="admin-name">站长</span>' : escapeHtml(msg.sender_name));
                
                // 获取头像：优先使用图片头像
                var avatarHtml = '';
                if (isMine) {
                    // 自己的头像：从 currentUser 获取
                    var myAvatarUrl = currentUser.user_metadata ? currentUser.user_metadata.avatar_url : null;
                    var myAvatarEmoji = currentUser.user_metadata ? currentUser.user_metadata.avatar : '👤';
                    if (myAvatarUrl) {
                        avatarHtml = '<img src="' + myAvatarUrl + '" alt="头像" style="width:100%;height:100%;object-fit:cover;border-radius:50%;">';
                    } else {
                        avatarHtml = myAvatarEmoji || '👤';
                    }
                } else {
                    // 对方的头像：使用消息中的 sender_avatar
                    avatarHtml = msg.sender_avatar || '👤';
                }
                
                html += '<div class="dm-bubble ' + (isMine ? 'dm-mine' : 'dm-other') + '">';
                if (!isMine) {
                    html += '<div class="dm-avatar' + (msg.is_admin_sent ? ' admin' : '') + '">' + avatarHtml + '</div>';
                }
                html += '<div class="dm-content-wrap">';
                html += '<div class="dm-sender">' + senderName + ' <span class="dm-time">' + timeStr + '</span></div>';
                html += '<div class="dm-text">';
                if (msg.content) {
                    html += escapeHtml(msg.content);
                }
                if (msg.image_url) {
                    html += '<img class="message-image" src="' + msg.image_url + '" alt="图片" onclick="openLightbox(\'' + msg.image_url + '\')" style="max-width:200px;margin-top:8px;border-radius:8px;cursor:pointer;">';
                }
                html += '</div>';
                html += '</div>';
                if (isMine) {
                    html += '<div class="dm-avatar' + (isAdmin() ? ' admin' : '') + '">' + avatarHtml + '</div>';
                }
                html += '</div>';
            });
            html += '</div>';
            
            container.innerHTML = html;
            container.scrollTop = container.scrollHeight;
            document.getElementById('loadMoreBtn').style.display = 'none';
        }
        
        // 标记私信为已读
        function markDMAsRead(senderId) {
            var accessToken = localStorage.getItem('nexus_access_token');
            var myId = currentUser.id;
            
            // 标记发给我的、来自senderId的未读消息为已读
            fetch(SUPABASE_URL + '/rest/v1/direct_messages?sender_id=eq.' + senderId + '&receiver_id=eq.' + myId + '&is_read=eq.false', {
                method: 'PATCH',
                headers: {
                    'apikey': SUPABASE_KEY,
                    'Authorization': 'Bearer ' + accessToken,
                    'Content-Type': 'application/json'
                },
                body: JSON.stringify({ is_read: true })
            })
            .then(function() {
                // 更新角标
                checkUnreadDM();
            })
            .catch(function(e) { console.error('标记已读失败', e); });
        }
        
        // 发送私信
        function sendDirectMessage() {
            var content = document.getElementById('messageInput').value.trim();
            
            if (!currentUser) {
                showMessage('请先登录', 'warning');
                openAuthModal('login');
                return;
            }
            
            // 允许只发图片或只发文字
            if (!content && !pendingMessageImage) {
                showMessage('请输入内容或上传图片', 'warning');
                return;
            }
            
            var accessToken = localStorage.getItem('nexus_access_token');
            var isAdminUser = isAdmin();
            
            var userName = '用户';
            var userAvatar = '👤';
            if (currentUser.user_metadata) {
                userName = currentUser.user_metadata.full_name || userName;
                userAvatar = currentUser.user_metadata.avatar || userAvatar;
            }
            
            // 确定接收者
            var receiverId;
            if (isAdminUser) {
                // 站长回复：发给当前选中的用户
                if (!currentDMUserId) {
                    showMessage('请先选择要回复的用户', 'warning');
                    return;
                }
                receiverId = currentDMUserId;
            } else {
                // 普通用户：发给站长
                receiverId = ADMIN_UUID;
            }
            
            var dmData = {
                sender_id: currentUser.id,
                sender_name: userName,
                sender_avatar: userAvatar,
                receiver_id: receiverId,
                content: content,
                image_url: pendingMessageImage || null,
                is_admin_sent: isAdminUser
            };
            
            // 调试日志
            console.log('发送私信 - pendingMessageImage:', pendingMessageImage);
            console.log('发送私信 - dmData:', dmData);
            
            var btn = document.querySelector('.execute-btn');
            btn.disabled = true;
            btn.innerHTML = '<i class="fas fa-spinner fa-spin"></i> 加密发送中...';
            
            fetch(SUPABASE_URL + '/rest/v1/direct_messages', {
                method: 'POST',
                headers: {
                    'apikey': SUPABASE_KEY,
                    'Authorization': 'Bearer ' + accessToken,
                    'Content-Type': 'application/json',
                    'Prefer': 'return=representation'
                },
                body: JSON.stringify(dmData)
            })
            .then(function(response) {
                if (!response.ok) {
                    throw new Error('发送失败');
                }
                return response.json();
            })
            .then(function(data) {
                document.getElementById('messageInput').value = '';
                document.getElementById('charCount').textContent = '0';
                removeImage(); // 清除图片
                showMessage('发送成功', 'success');
                
                // 刷新对话
                if (isAdminUser && currentDMUserId) {
                    loadDMConversation(currentDMUserId, currentDMUserName);
                } else {
                    loadDMConversation(ADMIN_UUID, '站长');
                }
            })
            .catch(function(error) {
                console.error('发送失败:', error);
                showMessage('发送失败，请重试', 'error');
            })
            .finally(function() {
                btn.disabled = false;
                btn.innerHTML = '<i class="fas fa-paper-plane"></i><span>执行 EXECUTE</span>';
            });
        }
        
        // 更新私信未读数角标
        function updatePrivateBadge(count) {
            var badge = document.getElementById('privateBadge');
            if (count > 0) {
                badge.textContent = count > 99 ? '99+' : count;
                badge.style.display = 'block';
            } else {
                badge.style.display = 'none';
            }
        }
        
        // 检查未读私信数量
        function checkUnreadDM() {
            if (!currentUser) return;
            
            var accessToken = localStorage.getItem('nexus_access_token');
            var myId = currentUser.id;
            
            // 查询发给我的未读消息
            fetch(SUPABASE_URL + '/rest/v1/direct_messages?receiver_id=eq.' + myId + '&is_read=eq.false&select=id', {
                method: 'GET',
                headers: {
                    'apikey': SUPABASE_KEY,
                    'Authorization': 'Bearer ' + accessToken
                }
            })
            .then(function(response) { return response.json(); })
            .then(function(data) {
                updatePrivateBadge(data.length);
            })
            .catch(function(e) { console.error('检查未读失败', e); });
        }
        
        // 修改提交函数，根据频道决定发送方式
        var originalSubmitMessage = submitMessage;
        submitMessage = function() {
            if (currentChannel === 'private') {
                sendDirectMessage();
            } else {
                originalSubmitMessage();
            }
        };
        
        // 更新输入区域显示状态
        function updateInputAreaState() {
            var inputWrapper = document.querySelector('.input-wrapper');
            var loginHint = document.getElementById('loginHint');
            
            if (currentUser) {
                inputWrapper.style.display = 'block';
                loginHint.style.display = 'none';
            } else {
                inputWrapper.style.display = 'none';
                loginHint.style.display = 'block';
            }
        }
        
        // 页面加载时初始化留言板
        document.addEventListener('DOMContentLoaded', function() {
            // 延迟加载留言，等待认证状态确认
            setTimeout(function() {
                updateInputAreaState();
                loadMessages();
                checkUnreadDM();
            }, 500);
        });
        
        // 监听登录状态变化，更新输入区域
        var originalUpdateAuthUI = updateAuthUI;
        updateAuthUI = function(isLoggedIn) {
            originalUpdateAuthUI(isLoggedIn);
            updateInputAreaState();
            if (currentChannel === 'public') {
                loadMessages();
            }
            // 检查未读私信
            if (isLoggedIn) {
                checkUnreadDM();
            } else {
                updatePrivateBadge(0);
            }
        };

        // ================= 图片上传功能 =================
        
        // 处理图片选择
        function handleMessageImage(event) {
            var file = event.target.files[0];
            if (file) {
                processImageFile(file);
            }
        }
        
        // 处理图片文件
        function processImageFile(file) {
            if (!currentUser) {
                showMessage('请先登录', 'warning');
                return;
            }
            
            if (!file.type.startsWith('image/')) {
                showMessage('请选择图片文件', 'error');
                return;
            }
            
            if (file.size > 5 * 1024 * 1024) {
                showMessage('图片大小不能超过5MB', 'error');
                return;
            }
            
            // 显示本地预览
            var reader = new FileReader();
            reader.onload = function(e) {
                document.getElementById('imagePreview').src = e.target.result;
                document.getElementById('imagePreviewArea').style.display = 'block';
            };
            reader.readAsDataURL(file);
            
            // 上传图片
            uploadMessageImage(file);
        }
        
        // 上传留言图片到Storage
        function uploadMessageImage(file) {
            var accessToken = localStorage.getItem('nexus_access_token');
            if (!accessToken || !currentUser) {
                showMessage('请先登录', 'error');
                return;
            }
            
            showMessage('图片上传中...', 'info');
            
            var fileExt = file.name.split('.').pop().toLowerCase();
            var fileName = 'msg_' + currentUser.id + '_' + Date.now() + '.' + fileExt;
            
            fetch(SUPABASE_URL + '/storage/v1/object/message-images/' + fileName, {
                method: 'POST',
                headers: {
                    'apikey': SUPABASE_KEY,
                    'Authorization': 'Bearer ' + accessToken,
                    'Content-Type': file.type,
                    'x-upsert': 'true'
                },
                body: file
            })
            .then(function(response) {
                if (!response.ok) {
                    throw new Error('上传失败');
                }
                return response.json();
            })
            .then(function(data) {
                pendingMessageImage = SUPABASE_URL + '/storage/v1/object/public/message-images/' + fileName;
                console.log('图片上传成功 - pendingMessageImage 已设置:', pendingMessageImage);
                showMessage('图片已准备好，点击发送', 'success');
            })
            .catch(function(error) {
                console.error('图片上传失败:', error);
                showMessage('图片上传失败', 'error');
                removeImage();
            });
        }
        
        // 移除待发送的图片
        function removeImage() {
            pendingMessageImage = null;
            document.getElementById('imagePreviewArea').style.display = 'none';
            document.getElementById('imagePreview').src = '';
            document.getElementById('messageImageInput').value = '';
        }
        
        // 拖拽上传
        var inputArea = document.getElementById('messageInputArea');
        
        inputArea.addEventListener('dragenter', function(e) {
            e.preventDefault();
            if (currentUser) {
                this.classList.add('dragging');
            }
        });
        
        inputArea.addEventListener('dragover', function(e) {
            e.preventDefault();
        });
        
        inputArea.addEventListener('dragleave', function(e) {
            if (e.target === this || !this.contains(e.relatedTarget)) {
                this.classList.remove('dragging');
            }
        });
        
        inputArea.addEventListener('drop', function(e) {
            e.preventDefault();
            this.classList.remove('dragging');
            
            if (!currentUser) {
                showMessage('请先登录', 'warning');
                return;
            }
            
            var files = e.dataTransfer.files;
            if (files.length > 0 && files[0].type.startsWith('image/')) {
                processImageFile(files[0]);
            }
        });
        
        // 粘贴图片
        document.getElementById('messageInput').addEventListener('paste', function(e) {
            var items = e.clipboardData.items;
            for (var i = 0; i < items.length; i++) {
                if (items[i].type.startsWith('image/')) {
                    var file = items[i].getAsFile();
                    processImageFile(file);
                    e.preventDefault();
                    break;
                }
            }
        });
        
        // 图片灯箱
        function openLightbox(src) {
            var lightbox = document.getElementById('imageLightbox');
            document.getElementById('lightboxImage').src = src;
            lightbox.classList.add('show');
        }
        
        function closeLightbox() {
            document.getElementById('imageLightbox').classList.remove('show');
        }

    </script>
    
    <!-- 图片灯箱 -->
    <div class="image-lightbox" id="imageLightbox" onclick="closeLightbox()">
        <img id="lightboxImage" src="" alt="大图">
    </div>
</body>
</html>